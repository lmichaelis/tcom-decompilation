instance SQ304_FINISHCUTSCENE(CUTSCENE) {
    ONSTART = FUNCTION(92921);
}

func void SQ304_FINISHCUTSCENE_START() {
    WLD_SENDTRIGGER("SQ304_FINISH_01");
    TELEPORTNPCTOWP(1819, "PART11_PATH_120");
    TELEPORTNPCTOWP(58782, PIR_1324_MORITZ.WP);
    AI_WAIT(HERO, 1073741824);
    AI_TURNTONPC(HERO, PIR_1324_MORITZ);
    NPC_CLEARAIQUEUE(PIR_1324_MORITZ);
    AI_SETWALKMODE(PIR_1324_MORITZ, NPC_RUN);
    AI_GOTOWP(PIR_1324_MORITZ, "PART11_MORITZ_DROP_MAP");
    AI_SETWALKMODE(PIR_1324_MORITZ, NPC_WALK);
    CREATEINVITEMS(PIR_1324_MORITZ, 37289, 1);
    AI_DROPITEM(PIR_1324_MORITZ, 37289);
    AI_PLAYANI(PIR_1324_MORITZ, "T_PISSOFF");
    AI_FUNCTION(PIR_1324_MORITZ, 92922);
}

func void SQ304_FINISHCUTSCENE_END() {
    FF_APPLYONCEEXT(92923, 75, 4);
}

func void SQ304_FINISHCUTSCENE_END_APPLY() {
    var int SQ304_FINISHCUTSCENE_END_COUNT;
    SQ304_FINISHCUTSCENE_END_COUNT = (SQ304_FINISHCUTSCENE_END_COUNT) + (1);
    if ((SQ304_FINISHCUTSCENE_END_COUNT) == (4)) {
        WLD_SENDUNTRIGGER("SQ304_FINISH_01");
        B_LOGENTRY(TOPIC_SQ304, LOG_SQ304_SUCCESS);
        LOG_SETSTATUS(_@(MIS_SQ304), TOPIC_SQ304, LOG_SUCCESS);
        B_GIVEPLAYERXP(XP_SQ304_FINISH);
        RESTOREROUTINE_MORITZ();
        TELEPORTNPCTOWP(58782, "PART11_PATH_124");
        HERO.AIVAR[4] = FALSE;
        SQ304_FINISHCUTSCENE_END_COUNT = 0;
        WLD_INSERTNPC(50969, "PART15_MORITZ_TREASURE_01");
        WLD_INSERTNPC(50336, "FP_ROAM_PART15_323");
        WLD_INSERTNPC(50336, "FP_ROAM_PART15_324");
        WLD_INSERTNPC(50336, "FP_ROAM_PART15_328");
        WLD_REMOVEITEM(ITWR_MAP_MORITZ);
        WLD_INSERTITEM(37289, "FP_SQ304_MORITZMAP");
    };
}

