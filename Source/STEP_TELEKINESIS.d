const int STEP_TELEKINESIS = 1;
var int STAGE;
func int SPELL_TELEKINESIS_FOCUS_REMOVER() {
    var OCNPC NPC;
    NPC = HLP_GETNPC(1819);
    NPC.FOCUS_VOB = 0;
    STAGE = 0;
    return FALSE;
}

instance OCITEM_TELEKINESIS(OCITEM);
var int STEP_X;
var int STEP_Y;
var int STEP_Z;
var int NUMB_OF_STEPS;
func void NEW_TELEKINESIS() {
    OCITEM_TELEKINESIS._ZCVOB_TRAFOOBJTOWORLD[3] = ADDF(OCITEM_TELEKINESIS._ZCVOB_TRAFOOBJTOWORLD[3], STEP_X);
    OCITEM_TELEKINESIS._ZCVOB_TRAFOOBJTOWORLD[7] = ADDF(OCITEM_TELEKINESIS._ZCVOB_TRAFOOBJTOWORLD[7], STEP_Z);
    OCITEM_TELEKINESIS._ZCVOB_TRAFOOBJTOWORLD[11] = ADDF(OCITEM_TELEKINESIS._ZCVOB_TRAFOOBJTOWORLD[11], STEP_Y);
    OCITEM_TELEKINESIS._ZCVOB_BBOX3D_MINS[0] = ADDF(OCITEM_TELEKINESIS._ZCVOB_BBOX3D_MINS[0], STEP_X);
    OCITEM_TELEKINESIS._ZCVOB_BBOX3D_MINS[1] = ADDF(OCITEM_TELEKINESIS._ZCVOB_BBOX3D_MINS[1], STEP_Z);
    OCITEM_TELEKINESIS._ZCVOB_BBOX3D_MINS[2] = ADDF(OCITEM_TELEKINESIS._ZCVOB_BBOX3D_MINS[2], STEP_Y);
    OCITEM_TELEKINESIS._ZCVOB_BBOX3D_MAXS[0] = ADDF(OCITEM_TELEKINESIS._ZCVOB_BBOX3D_MAXS[0], STEP_X);
    OCITEM_TELEKINESIS._ZCVOB_BBOX3D_MAXS[1] = ADDF(OCITEM_TELEKINESIS._ZCVOB_BBOX3D_MAXS[1], STEP_Z);
    OCITEM_TELEKINESIS._ZCVOB_BBOX3D_MAXS[2] = ADDF(OCITEM_TELEKINESIS._ZCVOB_BBOX3D_MAXS[2], STEP_Y);
}

instance SPELL_TELEKINESIS(C_SPELL_PROTO) {
    C_SPELL_PROTO();
    TIME_PER_MANA = 30;
    SPELLTYPE = SPELL_NEUTRAL;
    TARGETCOLLECTRANGE = 10000;
    TARGETCOLLECTALGO = TARGET_COLLECT_FOCUS;
    TARGETCOLLECTTYPE = TARGET_TYPE_ITEMS;
    CANTURNDURINGINVEST = SPELL_TELEKINESIS_FOCUS_REMOVER();
    CANCHANGETARGETDURINGINVEST = FALSE;
}

func int SPELL_LOGIC_TELEKINESIS(var int MANAINVESTED) {
    var int START_Z;
    var int TEMP;
    var OCNPC NPC;
    NPC = HLP_GETNPC(1815);
    if ((STAGE) == (0)) {
        TEMP = 43768;
        MEM_ASSIGNINST(TEMP, NPC.FOCUS_VOB);
        NUMB_OF_STEPS = (NPC_GETDISTTOITEM(SELF, OCITEM_TELEKINESIS)) / (10);
        STEP_X = DIVF(SUBF(NPC._ZCVOB_TRAFOOBJTOWORLD[3], OCITEM_TELEKINESIS._ZCVOB_TRAFOOBJTOWORLD[3]), MKF(NUMB_OF_STEPS));
        STEP_Z = DIVF(SUBF(NPC._ZCVOB_TRAFOOBJTOWORLD[7], OCITEM_TELEKINESIS._ZCVOB_TRAFOOBJTOWORLD[7]), MKF(NUMB_OF_STEPS));
        STEP_Y = DIVF(SUBF(NPC._ZCVOB_TRAFOOBJTOWORLD[11], OCITEM_TELEKINESIS._ZCVOB_TRAFOOBJTOWORLD[11]), MKF(NUMB_OF_STEPS));
    };
    if (((SELF.ATTRIBUTE[2]) < (STEP_TELEKINESIS)) || (((STAGE) == (0)) && ((NPC_GETDISTTOITEM(SELF, OCITEM_TELEKINESIS)) < (180)))) {
        return SPL_DONTINVEST;
    };
    if ((MANAINVESTED) <= (STEP_TELEKINESIS)) {
        return SPL_STATUS_CANINVEST_NO_MANADEC;
    };
    if ((MANAINVESTED) > (STEP_TELEKINESIS)) {
        if ((((STAGE) - (1)) % (10)) == (0)) {
            SELF.ATTRIBUTE[2] = (SELF.ATTRIBUTE[2]) - (STEP_TELEKINESIS);
        };
        if ((SELF.ATTRIBUTE[2]) < (0)) {
            SELF.ATTRIBUTE[2] = 0;
        };
        if ((NPC_GETDISTTOITEM(SELF, OCITEM_TELEKINESIS)) < (150)) {
            return SPL_SENDCAST;
        };
        if ((STAGE) == (0)) {
            START_Z = SUBF(OCITEM_TELEKINESIS._ZCVOB_BBOX3D_MAXS[1], OCITEM_TELEKINESIS._ZCVOB_BBOX3D_MINS[1]);
            OCITEM_TELEKINESIS._ZCVOB_TRAFOOBJTOWORLD[7] = ADDF(OCITEM_TELEKINESIS._ZCVOB_TRAFOOBJTOWORLD[7], START_Z);
            OCITEM_TELEKINESIS._ZCVOB_BBOX3D_MINS[1] = ADDF(OCITEM_TELEKINESIS._ZCVOB_BBOX3D_MINS[1], START_Z);
            OCITEM_TELEKINESIS._ZCVOB_BBOX3D_MAXS[1] = ADDF(OCITEM_TELEKINESIS._ZCVOB_BBOX3D_MAXS[1], START_Z);
            WLD_PLAYEFFECT("spellFX_ItemAusbuddeln", OCITEM_TELEKINESIS, OCITEM_TELEKINESIS, 0, 0, 0, FALSE);
        };
        NEW_TELEKINESIS();
        STAGE += 1;
        return SPL_NEXTLEVEL;
    };
    if ((NPC_GETDISTTOITEM(SELF, OCITEM_TELEKINESIS)) < (150)) {
        return SPL_SENDCAST;
    };
    return SPL_STATUS_CANINVEST_NO_MANADEC;
}

