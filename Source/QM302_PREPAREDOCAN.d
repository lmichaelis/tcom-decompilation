func void QM302_PREPAREDOCAN() {
    B_STARTOTHERROUTINE(SLD_1018_DOCAN, "QM302_WAIT");
    NPC_REFRESH(SLD_1018_DOCAN);
    TELEPORTNPCTOWP(52050, SLD_1018_DOCAN.WP);
    if (HLP_ISVALIDNPC(VLK_6082_GUY)) {
        B_STARTOTHERROUTINE(VLK_6082_GUY, "QM302_WAIT");
        NPC_REFRESH(VLK_6082_GUY);
        TELEPORTNPCTOWP(54342, VLK_6082_GUY.WP);
    };
}

func void QM302_CHANGEDOCANRTN() {
    NPC_EXCHANGEROUTINE(SLD_1018_DOCAN, START);
    if (HLP_ISVALIDNPC(VLK_6082_GUY)) {
        B_STARTOTHERROUTINE(VLK_6082_GUY, START);
        NPC_REFRESH(VLK_6082_GUY);
        TELEPORTNPCTOWP(54342, VLK_6082_GUY.WP);
    };
}

var int MARVIN_QM302_CURRENTMANA;
var int MARVIN_QM302_CURRENTMAXMANA;
func void QM302_LOCKINVENTORY() {
    PRINTD("Block inventory");
    CLOSEINVENTORY();
    PLAYERLOCKINVENTORY = TRUE;
    MARVIN_QM302_CURRENTMANA = HERO.ATTRIBUTE[2];
    MARVIN_QM302_CURRENTMAXMANA = HERO.ATTRIBUTE[3];
    HERO.ATTRIBUTE[2] = 2;
    HERO.ATTRIBUTE[3] = 2;
    EQUIPWEAPON(HERO, 37226);
}

func void QM302_UNLOCKINVENTORY() {
    PRINTD("Unlock inventory");
    PLAYERLOCKINVENTORY = FALSE;
    HERO.ATTRIBUTE[2] = MARVIN_QM302_CURRENTMANA;
    HERO.ATTRIBUTE[3] = MARVIN_QM302_CURRENTMAXMANA;
    HERO.ATTRIBUTE[2] = HERO.ATTRIBUTE[3];
}

func void QM302_PREPAREDOCANCROSSBOW() {
    if ((NPC_HASITEMS(SLD_1018_DOCAN, 37227)) == (0)) {
        CREATEINVITEMS(SLD_1018_DOCAN, 37227, 1);
    };
    CREATEINVITEMS(SLD_1018_DOCAN, 34384, 10);
    AI_EQUIPBESTRANGEDWEAPON(SLD_1018_DOCAN);
}

func void QM302_SPAWNBOARS() {
    WLD_INSERTNPC(50186, "PART4_PATH_53");
    WLD_INSERTNPC(50187, "PART4_PATH_53");
    WLD_INSERTNPC(50188, "PART4_PATH_54");
    WLD_INSERTNPC(50189, "PART4_PATH_54");
}

func void QM302_REMOVEBOARS() {
    if (HLP_ISVALIDNPC(KEILER_QM302_03)) {
        if ((NPC_ISDEAD(KEILER_QM302_03)) == (FALSE)) {
            B_REMOVENPC(50186);
        };
    };
    if (HLP_ISVALIDNPC(KEILER_QM302_04)) {
        if ((NPC_ISDEAD(KEILER_QM302_04)) == (FALSE)) {
            B_REMOVENPC(50187);
        };
    };
    if (HLP_ISVALIDNPC(KEILER_QM302_05)) {
        if ((NPC_ISDEAD(KEILER_QM302_05)) == (FALSE)) {
            B_REMOVENPC(50188);
        };
    };
    if (HLP_ISVALIDNPC(KEILER_QM302_06)) {
        if ((NPC_ISDEAD(KEILER_QM302_06)) == (FALSE)) {
            B_REMOVENPC(50189);
        };
    };
}

func void QM302_TELEPORTBANDITS_TOT() {
    if (HLP_ISVALIDNPC(BDT_11308_BANDIT)) {
        if ((NPC_ISDEAD(BDT_11308_BANDIT)) == (FALSE)) {
            B_STARTOTHERROUTINE(BDT_11308_BANDIT, TOT);
            NPC_REFRESH(BDT_11308_BANDIT);
            TELEPORTNPCTOWP(55839, BDT_11308_BANDIT.WP);
        };
    };
    if (HLP_ISVALIDNPC(BDT_11304_BANDIT)) {
        if ((NPC_ISDEAD(BDT_11304_BANDIT)) == (FALSE)) {
            B_STARTOTHERROUTINE(BDT_11304_BANDIT, TOT);
            NPC_REFRESH(BDT_11304_BANDIT);
            TELEPORTNPCTOWP(55831, BDT_11304_BANDIT.WP);
        };
    };
    if (HLP_ISVALIDNPC(BDT_11305_BANDIT)) {
        if ((NPC_ISDEAD(BDT_11305_BANDIT)) == (FALSE)) {
            B_STARTOTHERROUTINE(BDT_11305_BANDIT, TOT);
            NPC_REFRESH(BDT_11305_BANDIT);
            TELEPORTNPCTOWP(55834, BDT_11305_BANDIT.WP);
        };
    };
    if (HLP_ISVALIDNPC(BDT_11298_BANDIT)) {
        if ((NPC_ISDEAD(BDT_11298_BANDIT)) == (FALSE)) {
            B_STARTOTHERROUTINE(BDT_11298_BANDIT, TOT);
            NPC_REFRESH(BDT_11298_BANDIT);
            TELEPORTNPCTOWP(55828, BDT_11298_BANDIT.WP);
        };
    };
    if (HLP_ISVALIDNPC(BDT_11294_LEADER)) {
        if ((NPC_ISDEAD(BDT_11294_LEADER)) == (FALSE)) {
            B_STARTOTHERROUTINE(BDT_11294_LEADER, TOT);
            NPC_REFRESH(BDT_11294_LEADER);
            TELEPORTNPCTOWP(55822, BDT_11294_LEADER.WP);
        };
    };
    if (HLP_ISVALIDNPC(BDT_11296_BANDIT)) {
        if ((NPC_ISDEAD(BDT_11296_BANDIT)) == (FALSE)) {
            B_STARTOTHERROUTINE(BDT_11296_BANDIT, TOT);
            NPC_REFRESH(BDT_11296_BANDIT);
            TELEPORTNPCTOWP(55825, BDT_11296_BANDIT.WP);
        };
    };
}

func void QM302_TELEPORTBANDITS_START() {
    if (HLP_ISVALIDNPC(BDT_11308_BANDIT)) {
        if ((NPC_ISDEAD(BDT_11308_BANDIT)) == (FALSE)) {
            B_STARTOTHERROUTINE(BDT_11308_BANDIT, START);
            NPC_REFRESH(BDT_11308_BANDIT);
            TELEPORTNPCTOWP(55839, BDT_11308_BANDIT.WP);
        };
    };
    if (HLP_ISVALIDNPC(BDT_11304_BANDIT)) {
        if ((NPC_ISDEAD(BDT_11304_BANDIT)) == (FALSE)) {
            B_STARTOTHERROUTINE(BDT_11304_BANDIT, START);
            NPC_REFRESH(BDT_11304_BANDIT);
            TELEPORTNPCTOWP(55831, BDT_11304_BANDIT.WP);
        };
    };
    if (HLP_ISVALIDNPC(BDT_11305_BANDIT)) {
        if ((NPC_ISDEAD(BDT_11305_BANDIT)) == (FALSE)) {
            B_STARTOTHERROUTINE(BDT_11305_BANDIT, START);
            NPC_REFRESH(BDT_11305_BANDIT);
            TELEPORTNPCTOWP(55834, BDT_11305_BANDIT.WP);
        };
    };
    if (HLP_ISVALIDNPC(BDT_11298_BANDIT)) {
        if ((NPC_ISDEAD(BDT_11298_BANDIT)) == (FALSE)) {
            B_STARTOTHERROUTINE(BDT_11298_BANDIT, START);
            NPC_REFRESH(BDT_11298_BANDIT);
            TELEPORTNPCTOWP(55828, BDT_11298_BANDIT.WP);
        };
    };
    if (HLP_ISVALIDNPC(BDT_11294_LEADER)) {
        if ((NPC_ISDEAD(BDT_11294_LEADER)) == (FALSE)) {
            B_STARTOTHERROUTINE(BDT_11294_LEADER, START);
            NPC_REFRESH(BDT_11294_LEADER);
            TELEPORTNPCTOWP(55822, BDT_11294_LEADER.WP);
        };
    };
    if (HLP_ISVALIDNPC(BDT_11296_BANDIT)) {
        if ((NPC_ISDEAD(BDT_11296_BANDIT)) == (FALSE)) {
            B_STARTOTHERROUTINE(BDT_11296_BANDIT, START);
            NPC_REFRESH(BDT_11296_BANDIT);
            TELEPORTNPCTOWP(55825, BDT_11296_BANDIT.WP);
        };
    };
}

var int QM302_REMOVEMOLERAT;
var int QM302_REMOVEWOLF;
var int QM302_REMOVEKEILER;
var int QM302_REMOVERAT;
func void QM302_REMOVEMONSTERS() {
    if (HLP_ISVALIDNPC(MOLERAT_QM302_01)) {
        if ((NPC_ISDEAD(MOLERAT_QM302_01)) == (FALSE)) {
            B_REMOVENPC(50670);
            QM302_REMOVEMOLERAT = (QM302_REMOVEMOLERAT) + (1);
        };
    };
    if (HLP_ISVALIDNPC(MOLERAT_QM302_02)) {
        if ((NPC_ISDEAD(MOLERAT_QM302_02)) == (FALSE)) {
            B_REMOVENPC(50671);
            QM302_REMOVEMOLERAT = (QM302_REMOVEMOLERAT) + (1);
        };
    };
    if (HLP_ISVALIDNPC(MOLERAT_QM302_03)) {
        if ((NPC_ISDEAD(MOLERAT_QM302_03)) == (FALSE)) {
            B_REMOVENPC(50672);
            QM302_REMOVEMOLERAT = (QM302_REMOVEMOLERAT) + (1);
        };
    };
    if (HLP_ISVALIDNPC(WOLF_QM302_01)) {
        if ((NPC_ISDEAD(WOLF_QM302_01)) == (FALSE)) {
            B_REMOVENPC(51100);
            QM302_REMOVEWOLF = (QM302_REMOVEWOLF) + (1);
        };
    };
    if (HLP_ISVALIDNPC(WOLF_QM302_02)) {
        if ((NPC_ISDEAD(WOLF_QM302_02)) == (FALSE)) {
            B_REMOVENPC(51101);
            QM302_REMOVEWOLF = (QM302_REMOVEWOLF) + (1);
        };
    };
    if (HLP_ISVALIDNPC(WOLF_QM302_03)) {
        if ((NPC_ISDEAD(WOLF_QM302_03)) == (FALSE)) {
            B_REMOVENPC(51102);
            QM302_REMOVEWOLF = (QM302_REMOVEWOLF) + (1);
        };
    };
    if (HLP_ISVALIDNPC(GIANT_RAT_QM302_01)) {
        if ((NPC_ISDEAD(GIANT_RAT_QM302_01)) == (FALSE)) {
            B_REMOVENPC(50477);
            QM302_REMOVERAT = (QM302_REMOVERAT) + (1);
        };
    };
    if (HLP_ISVALIDNPC(KEILER_QM302_01)) {
        if ((NPC_ISDEAD(KEILER_QM302_01)) == (FALSE)) {
            B_REMOVENPC(50184);
            QM302_REMOVEKEILER = (QM302_REMOVEKEILER) + (1);
        };
    };
    if (HLP_ISVALIDNPC(KEILER_QM302_02)) {
        if ((NPC_ISDEAD(KEILER_QM302_02)) == (FALSE)) {
            B_REMOVENPC(50185);
            QM302_REMOVEKEILER = (QM302_REMOVEKEILER) + (1);
        };
    };
}

func void QM302_BRINGBACKMONSTERS() {
    if ((QM302_REMOVEKEILER) == (1)) {
        WLD_INSERTNPC(50182, "PART4_MOB_96");
    };
    if ((QM302_REMOVEKEILER) == (2)) {
        WLD_INSERTNPC(50182, "PART4_MOB_96");
    };
    if ((QM302_REMOVERAT) == (1)) {
        WLD_INSERTNPC(50466, "PART4_MOB_98");
    };
    if ((QM302_REMOVEWOLF) == (1)) {
        WLD_INSERTNPC(51070, "PART4_MOB_07");
    };
    if ((QM302_REMOVEWOLF) == (2)) {
        WLD_INSERTNPC(51070, "PART4_MOB_08");
    };
    if ((QM302_REMOVEWOLF) == (3)) {
        WLD_INSERTNPC(51070, "PART4_MOB_07");
    };
    if ((QM302_REMOVEMOLERAT) == (1)) {
        WLD_INSERTNPC(50662, "PART4_MOB_93");
    };
    if ((QM302_REMOVEMOLERAT) == (2)) {
        WLD_INSERTNPC(50662, "PART4_MOB_94");
    };
    if ((QM302_REMOVEMOLERAT) == (3)) {
        WLD_INSERTNPC(50662, "PART4_MOB_95");
    };
}

func void QM302_PREPARECUTSCENE() {
    FF_APPLYONCEEXT(63505, 75, 4);
    B_STARTOTHERROUTINE(SLD_1018_DOCAN, "QM302_RENEGADES_CUTSCENE");
    NPC_REFRESH(SLD_1018_DOCAN);
}

func void QM302_PREPARECUTSCENE_APPLY() {
    var int QM302_PREPARECUTSCENE_COUNT;
    QM302_PREPARECUTSCENE_COUNT = (QM302_PREPARECUTSCENE_COUNT) + (1);
    if ((QM302_PREPARECUTSCENE_COUNT) == (4)) {
        QM302_PREPARECUTSCENE_COUNT = 0;
        CUTSCENE_START(92834);
    };
}

func void QM302_RESPAWNRENEGADES() {
    QM302_RENEGADESEVENT = 1;
    if ((NPC_ISDEAD(MIL_6270_JERRAN)) == (FALSE)) {
        B_STARTOTHERROUTINE(MIL_6270_JERRAN, "QM302_FIGHT");
        NPC_REFRESH(MIL_6270_JERRAN);
        TELEPORTNPCTOWP(56273, MIL_6270_JERRAN.WP);
    };
    WLD_INSERTNPC(56220, "PART4_RENEGADE_02");
    if ((NPC_ISDEAD(MIL_6271_RENEGADE)) == (FALSE)) {
        B_STARTOTHERROUTINE(MIL_6271_RENEGADE, "QM302_FIGHT");
        NPC_REFRESH(MIL_6271_RENEGADE);
        TELEPORTNPCTOWP(56233, MIL_6271_RENEGADE.WP);
    };
    WLD_INSERTNPC(56222, "PART4_RENEGADE_01");
    WLD_INSERTNPC(56218, "PART4_PATH_62");
}

func void QM302_RENEGADESATTACK_REFRESH() {
    NPC_CLEARAIQUEUE(MIL_11272_LEADER);
    if (HLP_ISVALIDNPC(MIL_6270_JERRAN)) {
        NPC_CLEARAIQUEUE(MIL_6270_JERRAN);
    };
    NPC_CLEARAIQUEUE(MIL_11275_RENEGADE);
    if (HLP_ISVALIDNPC(MIL_6271_RENEGADE)) {
        NPC_CLEARAIQUEUE(MIL_6271_RENEGADE);
    };
    NPC_CLEARAIQUEUE(MIL_11276_RENEGADE);
}

func void QM302_RENEGADESATTACK() {
    if (HLP_ISVALIDNPC(MIL_6270_JERRAN)) {
        MIL_6270_JERRAN.AIVAR[61] = FALSE;
        MIL_6270_JERRAN.FLAGS = 0;
    };
    MIL_11275_RENEGADE.AIVAR[61] = FALSE;
    MIL_11275_RENEGADE.FLAGS = 0;
    if (HLP_ISVALIDNPC(MIL_6271_RENEGADE)) {
        MIL_6271_RENEGADE.AIVAR[61] = FALSE;
        MIL_6271_RENEGADE.FLAGS = 0;
    };
    MIL_11276_RENEGADE.AIVAR[61] = FALSE;
    MIL_11276_RENEGADE.FLAGS = 0;
    MIL_11272_LEADER.AIVAR[61] = FALSE;
    MIL_11272_LEADER.FLAGS = 0;
}

func void QM302_RENEGADES_END() {
    FF_APPLYONCEEXT(63511, 75, 4);
}

func void QM302_RENEGADES_END_APPLY() {
    var int QM302_RENEGADES_END_COUNT;
    QM302_RENEGADES_END_COUNT = (QM302_RENEGADES_END_COUNT) + (1);
    if ((QM302_RENEGADES_END_COUNT) == (4)) {
        QM302_RENEGADES_END_COUNT = 0;
        WLD_SENDUNTRIGGER("QM302_RENEGADES_01");
        WLD_SENDUNTRIGGER("QM302_RENEGADES_02");
        WLD_SENDUNTRIGGER("QM302_RENEGADES_03");
        DIACAM_ENABLE();
        MIL_11272_LEADER.AIVAR[92] = FALSE;
        SLD_1018_DOCAN.AIVAR[92] = FALSE;
        HERO.AIVAR[4] = FALSE;
        QM302_RENEGADESATTACK();
    };
}

func void QM302_PREPAREDETLOW() {
    B_STARTOTHERROUTINE(VLK_3015_DETLOW, "QM302_SEARCH");
    QM302_DETLOW_RTNCHECK = 1;
    NPC_REFRESH(VLK_3015_DETLOW);
    TELEPORTNPCTOWP(53778, VLK_3015_DETLOW.WP);
}

func void QM302_PREPAREDETLOWTRAINING() {
    NPC_EXCHANGEROUTINE(NONE_2009_LENNART, "QM302_LORENZO");
    B_STARTOTHERROUTINE(VLK_3015_DETLOW, "QM302_TRAINING");
    QM302_DETLOW_RTNCHECK = 3;
    NPC_REFRESH(VLK_3015_DETLOW);
    TELEPORTNPCTOWP(53778, VLK_3015_DETLOW.WP);
    WLD_INSERTNPC(52695, "PARTM3_CROSSBOW_SHOOT_01");
    WLD_INSERTNPC(52698, "PARTM3_CROSSBOW_SHOOT_02");
}

func void QM302_FINISHTRAINING() {
    B_REMOVENPC(52695);
    B_REMOVENPC(52698);
    B_STARTOTHERROUTINE(NONE_2009_LENNART, START);
    NPC_REFRESH(NONE_2009_LENNART);
    TELEPORTNPCTOWP(53001, NONE_2009_LENNART.WP);
    RESTOREROUTINE_DETLOW();
}

func void QM302_FAILEDQUEST() {
    if (((KAPITEL) != (5)) && ((LOG_GETSTATUS(MIS_Q308)) != (LOG_RUNNING))) {
        B_STARTOTHERROUTINE(VLK_2261_BODOWIN, START);
        NPC_REFRESH(VLK_2261_BODOWIN);
    };
    if (HLP_ISVALIDNPC(MIL_11286_MILITIA)) {
        if (NPC_ISDEAD(MIL_11286_MILITIA)) {
            B_REMOVENPC(52695);
        };
    };
    if (HLP_ISVALIDNPC(MIL_11287_MILITIA)) {
        if (NPC_ISDEAD(MIL_11287_MILITIA)) {
            B_REMOVENPC(52698);
        };
    };
    if (HLP_ISVALIDNPC(MIL_6270_JERRAN)) {
        if (NPC_ISDEAD(MIL_6270_JERRAN)) {
            B_REMOVENPC(56273);
        };
    };
    if (HLP_ISVALIDNPC(MIL_6271_RENEGADE)) {
        if (NPC_ISDEAD(MIL_6271_RENEGADE)) {
            B_REMOVENPC(56233);
        };
    };
    if (HLP_ISVALIDNPC(MIL_11275_RENEGADE)) {
        if (NPC_ISDEAD(MIL_11275_RENEGADE)) {
            B_REMOVENPC(56220);
        };
    };
    if (HLP_ISVALIDNPC(MIL_11276_RENEGADE)) {
        if (NPC_ISDEAD(MIL_11276_RENEGADE)) {
            B_REMOVENPC(56222);
        };
    };
    if (HLP_ISVALIDNPC(MIL_11272_LEADER)) {
        if (NPC_ISDEAD(MIL_11272_LEADER)) {
            B_REMOVENPC(56218);
        };
    };
    RESTOREROUTINE_DETLOW();
    QM302_CHANGEDOCANRTN();
}

