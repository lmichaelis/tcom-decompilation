var int LENA_SQ316_FIRSTLOG;
func void SQ316_PREPARECORTEZ() {
    B_STARTOTHERROUTINE(PIR_1303_CORTEZ, "SQ316");
    SQ316_CORTEZ_RTNCHECK = 1;
    NPC_REFRESH(PIR_1303_CORTEZ);
    TELEPORTNPCTOWP(58644, PIR_1303_CORTEZ.WP);
    HERO.AIVAR[4] = FALSE;
}

instance DIA_LENA_EXIT(C_INFO) {
    NPC = 58835;
    NR = 999;
    CONDITION = DIA_LENA_EXIT_CONDITION;
    INFORMATION = DIA_LENA_EXIT_INFO;
    PERMANENT = TRUE;
    DESCRIPTION = DIALOG_ENDE;
}

func int DIA_LENA_EXIT_CONDITION() {
    return TRUE;
}

func void DIA_LENA_EXIT_INFO() {
    AI_STOPPROCESSINFOS(SELF);
}

instance DIA_LENA_HELPME(C_INFO) {
    NPC = 58835;
    NR = 1;
    CONDITION = DIA_LENA_HELPME_CONDITION;
    INFORMATION = DIA_LENA_HELPME_INFO;
    IMPORTANT = TRUE;
}

func int DIA_LENA_HELPME_CONDITION() {
    if ((SQ316_CANUSELEVER) == (FALSE)) {
        if (NPC_ISINSTATE(SELF, 61599)) {
            if ((SQ507_STARTINGPOINT) == (0)) {
                return TRUE;
            };
        };
    };
    return 0 /* !broken stack! */;
}

func void DIA_LENA_HELPME_INFO() {
    MDL_STARTFACEANI(SELF, S_FRIGHTENED, 1065353216, -1082130432);
    AI_OUTPUT(SELF, OTHER, "DIA_Lena_Helpme_16_01");
    if ((LOG_GETSTATUS(MIS_SQ316)) == (LOG_RUNNING)) {
        if ((LENA_SQ316_FIRSTLOG) == (FALSE)) {
            AI_LOGENTRY(TOPIC_SQ316, LOG_SQ316_FRIGHTENEDGIRL);
            LENA_SQ316_FIRSTLOG = TRUE;
        };
    };
}

instance DIA_LENA_SQ316_YOUAREFREE(C_INFO) {
    NPC = 58835;
    NR = 1;
    CONDITION = DIA_LENA_SQ316_YOUAREFREE_CONDITION;
    INFORMATION = DIA_LENA_SQ316_YOUAREFREE_INFO;
    PERMANENT = FALSE;
    DESCRIPTION = "You're free.";
}

func int DIA_LENA_SQ316_YOUAREFREE_CONDITION() {
    if ((SQ316_CANUSELEVER) == (TRUE)) {
        if ((SQ507_STARTINGPOINT) == (0)) {
            return TRUE;
        };
    };
    return 0 /* !broken stack! */;
}

func void DIA_LENA_SQ316_YOUAREFREE_INFO() {
    AI_OUTPUT(OTHER, SELF, "DIA_Lena_SQ316_YouAreFree_15_01");
    AI_OUTPUT(SELF, OTHER, "DIA_Lena_SQ316_YouAreFree_03_02");
    AI_OUTPUT(OTHER, SELF, "DIA_Lena_SQ316_YouAreFree_15_03");
    AI_OUTPUT(SELF, OTHER, "DIA_Lena_SQ316_YouAreFree_03_04");
    AI_OUTPUT(SELF, OTHER, "DIA_Lena_SQ316_YouAreFree_03_05");
    AI_LOGENTRY(TOPIC_SQ316, LOG_SQ316_LENAISHURT);
    NPC_EXCHANGEROUTINE(SELF, FOLLOW);
    AI_FUNCTION(SELF, 85213);
    AI_STOPPROCESSINFOS(SELF);
}

instance DIA_LENA_SQ316_IMUSTSTAY(C_INFO) {
    NPC = 58835;
    NR = 1;
    CONDITION = DIA_LENA_SQ316_IMUSTSTAY_CONDITION;
    INFORMATION = DIA_LENA_SQ316_IMUSTSTAY_INFO;
    PERMANENT = FALSE;
    IMPORTANT = TRUE;
}

func int DIA_LENA_SQ316_IMUSTSTAY_CONDITION() {
    if (NPC_KNOWSINFO(OTHER, 83857)) {
        if ((SQ507_STARTINGPOINT) == (0)) {
            return TRUE;
        };
    };
    return 0 /* !broken stack! */;
}

func void DIA_LENA_SQ316_IMUSTSTAY_INFO() {
    AI_OUTPUT(SELF, OTHER, "DIA_Lena_SQ316_IMustStay_03_01");
    INFO_CLEARCHOICES(85223);
    INFO_ADDCHOICE(85223, "There must be some way to get you out of here...", 85226);
}

func void DIA_LENA_SQ316_WAYTOGETYOUOUT() {
    AI_OUTPUT(OTHER, SELF, "DIA_Lena_SQ316_WayToGetYouOut_15_01");
    AI_OUTPUT(SELF, OTHER, "DIA_Lena_SQ316_WayToGetYouOut_03_02");
    AI_OUTPUT(SELF, OTHER, "DIA_Lena_SQ316_WayToGetYouOut_03_03");
    AI_OUTPUT(SELF, OTHER, "DIA_Lena_SQ316_WayToGetYouOut_03_04");
    AI_OUTPUT(SELF, OTHER, "DIA_Lena_SQ316_WayToGetYouOut_03_05");
    AI_OUTPUT(OTHER, SELF, "DIA_Lena_SQ316_WayToGetYouOut_15_06");
    CREATEINVITEMS(SELF, 35149, 1);
    B_GIVEINVITEMS(SELF, OTHER, 35149, 1);
    NPC_EXCHANGEROUTINE(SELF, "AFTERQUEST");
    AI_LOGENTRY(TOPIC_SQ316, LOG_SQ316_LENAISSAVE);
    AI_STOPPROCESSINFOS(SELF);
}

instance DIA_LENA_SQ507_ASSAULTINCOMING(C_INFO) {
    NPC = 58835;
    NR = 1;
    CONDITION = DIA_LENA_SQ507_ASSAULTINCOMING_CONDITION;
    INFORMATION = DIA_LENA_SQ507_ASSAULTINCOMING_INFO;
    PERMANENT = TRUE;
    IMPORTANT = TRUE;
}

func int DIA_LENA_SQ507_ASSAULTINCOMING_CONDITION() {
    if ((SQ507_STARTINGPOINT) != (0)) {
        if (!(NPC_ISDEAD(PIR_1303_CORTEZ))) {
            return TRUE;
        };
    };
    return 0 /* !broken stack! */;
}

func void DIA_LENA_SQ507_ASSAULTINCOMING_INFO() {
    AI_OUTPUT(SELF, OTHER, "DIA_Lena_SQ507_AssaultIncoming_03_01");
    AI_STOPPROCESSINFOS(SELF);
}

instance DIA_LENA_SQ507_STARTINGPOINT(C_INFO) {
    NPC = 58835;
    NR = 2;
    CONDITION = DIA_LENA_SQ507_STARTINGPOINT_CONDITION;
    INFORMATION = DIA_LENA_SQ507_STARTINGPOINT_INFO;
    PERMANENT = FALSE;
    IMPORTANT = TRUE;
}

func int DIA_LENA_SQ507_STARTINGPOINT_CONDITION() {
    if ((SQ507_STARTINGPOINT) != (0)) {
        if (NPC_ISDEAD(PIR_1303_CORTEZ)) {
            return TRUE;
        };
    };
    return 0 /* !broken stack! */;
}

func void DIA_LENA_SQ507_STARTINGPOINT_INFO() {
    AI_OUTPUT(SELF, OTHER, "DIA_Lena_SQ507_StartingPoint_03_01");
}

instance DIA_LENA_SQ507_CORTEZISDEAD(C_INFO) {
    NPC = 58835;
    NR = 3;
    CONDITION = DIA_LENA_SQ507_CORTEZISDEAD_CONDITION;
    INFORMATION = DIA_LENA_SQ507_CORTEZISDEAD_INFO;
    PERMANENT = FALSE;
    DESCRIPTION = "Yes, Cortez is dead. This is the end of the Haven.";
}

func int DIA_LENA_SQ507_CORTEZISDEAD_CONDITION() {
    if (NPC_KNOWSINFO(OTHER, 85230)) {
        return TRUE;
    };
    return 0 /* !broken stack! */;
}

func void DIA_LENA_SQ507_CORTEZISDEAD_INFO() {
    AI_OUTPUT(OTHER, SELF, "DIA_Lena_SQ507_CortezIsDead_15_01");
    if ((SQ507_STARTINGPOINT) == (1)) {
        AI_OUTPUT(OTHER, SELF, "DIA_Lena_SQ507_CortezIsDead_15_02");
        AI_OUTPUT(SELF, OTHER, "DIA_Lena_SQ507_CortezIsDead_03_03");
    };
    if ((SQ507_STARTINGPOINT) == (3)) {
        VLK_6126_LENA.NAME[0] = NPCNAME_LENA;
        VLK_6126_LENA.AIVAR[79] = 1;
        AI_OUTPUT(OTHER, SELF, "DIA_Lena_SQ507_CortezIsDead_15_04");
        AI_OUTPUT(SELF, OTHER, "DIA_Lena_SQ507_CortezIsDead_03_05");
        AI_OUTPUT(SELF, OTHER, "DIA_Lena_SQ507_CortezIsDead_03_06");
        AI_OUTPUT(SELF, OTHER, "DIA_Lena_SQ507_CortezIsDead_03_07");
        AI_OUTPUT(SELF, OTHER, "DIA_Lena_SQ507_CortezIsDead_03_08");
    };
    if ((SQ507_STARTINGPOINT) == (2)) {
        VLK_6126_LENA.NAME[0] = NPCNAME_LENA;
        VLK_6126_LENA.AIVAR[79] = 1;
        if ((NPC_KNOWSINFO(OTHER, 83911)) && (!(NPC_KNOWSINFO(OTHER, 83857)))) {
            AI_OUTPUT(OTHER, SELF, "DIA_Lena_SQ507_CortezIsDead_15_09");
            AI_OUTPUT(SELF, OTHER, "DIA_Lena_SQ507_CortezIsDead_03_10");
        } else if ((!(NPC_KNOWSINFO(OTHER, 83911))) && (!(NPC_KNOWSINFO(OTHER, 83857)))) {
            AI_OUTPUT(OTHER, SELF, "DIA_Lena_SQ507_CortezIsDead_15_11");
            AI_OUTPUT(SELF, OTHER, "DIA_Lena_SQ507_CortezIsDead_03_12");
        };
        AI_OUTPUT(OTHER, SELF, "DIA_Lena_SQ507_CortezIsDead_15_13");
        LOG_SETSTATUS(_@(MIS_SQ316), TOPIC_SQ316, LOG_SUCCESS);
        AI_LOGENTRY(TOPIC_SQ316, LOG_SQ316_FINISHUNUSSUALWAY);
    };
    AI_OUTPUT(SELF, OTHER, "DIA_Lena_SQ507_CortezIsDead_03_14");
}

instance DIA_LENA_SQ507_REALSTART(C_INFO) {
    NPC = 58835;
    NR = 4;
    CONDITION = DIA_LENA_SQ507_REALSTART_CONDITION;
    INFORMATION = DIA_LENA_SQ507_REALSTART_INFO;
    PERMANENT = FALSE;
    DESCRIPTION = "All right, let's go!";
}

func int DIA_LENA_SQ507_REALSTART_CONDITION() {
    if (NPC_KNOWSINFO(OTHER, 85233)) {
        return TRUE;
    };
    return 0 /* !broken stack! */;
}

func void DIA_LENA_SQ507_REALSTART_INFO() {
    AI_OUTPUT(OTHER, SELF, "DIA_Lena_SQ507_RealStart_15_01");
    NPC_EXCHANGEROUTINE(SELF, "FOLLOW2");
    LOG_CREATETOPIC(TOPIC_SQ507, LOG_MISSION);
    LOG_SETSTATUS(_@(MIS_SQ507), TOPIC_SQ507, LOG_RUNNING);
    AI_LOGENTRY(TOPIC_SQ507, LOG_SQ507_START);
    AI_STOPPROCESSINFOS(SELF);
    WLD_INSERTNPC(58513, "P17_HAVEN_CELL_06");
}

instance DIA_LENA_SQ507_RUNE(C_INFO) {
    NPC = 58835;
    NR = 5;
    CONDITION = DIA_LENA_SQ507_RUNE_CONDITION;
    INFORMATION = DIA_LENA_SQ507_RUNE_INFO;
    PERMANENT = FALSE;
    DESCRIPTION = "Maybe you want to use a teleportation rune to get home?";
}

func int DIA_LENA_SQ507_RUNE_CONDITION() {
    if ((NPC_KNOWSINFO(OTHER, 85233)) && ((LOG_GETSTATUS(MIS_SQ507)) == (LOG_RUNNING))) {
        return TRUE;
    };
    return 0 /* !broken stack! */;
}

func void DIA_LENA_SQ507_RUNE_INFO() {
    AI_OUTPUT(OTHER, SELF, "DIA_Lena_SQ507_Rune_15_01");
    AI_OUTPUT(SELF, OTHER, "DIA_Lena_SQ507_Rune_03_02");
    AI_OUTPUT(SELF, OTHER, "DIA_Lena_SQ507_Rune_03_03");
}

func void DIA_LENA_SQ507_NEWWEAPON_GO() {
    SQ507_FIGHTWITHBOUNTYHUNTERS = 1;
    NPC_EXCHANGEROUTINE(SELF, "FOLLOWBARRY2");
    B_STARTOTHERROUTINE(MIL_13698_BARRY, "GUIDE2");
    NPC_REFRESH(MIL_13698_BARRY);
    WLD_INSERTNPC(58394, "PART17_PATH_175A");
    WLD_INSERTNPC(58396, "PART17_PATH_175B");
    WLD_INSERTNPC(58398, "PART17_PATH_175C");
}

instance DIA_LENA_SQ507_NEWWEAPON(C_INFO) {
    NPC = 58835;
    NR = 1;
    CONDITION = DIA_LENA_SQ507_NEWWEAPON_CONDITION;
    INFORMATION = DIA_LENA_SQ507_NEWWEAPON_INFO;
    PERMANENT = FALSE;
    IMPORTANT = TRUE;
}

func int DIA_LENA_SQ507_NEWWEAPON_CONDITION() {
    if (((NPC_KNOWSINFO(OTHER, 82790)) && ((NPC_GETDISTTOWP(SELF, "P17_HAVEN_OUT_06")) <= (600))) && ((LOG_GETSTATUS(MIS_SQ507)) == (LOG_RUNNING))) {
        return TRUE;
    };
    return 0 /* !broken stack! */;
}

func void DIA_LENA_SQ507_NEWWEAPON_INFO() {
    NPC_EXCHANGEROUTINE(SELF, "LAYOVER");
    B_STARTOTHERROUTINE(MIL_13698_BARRY, "LAYOVER");
    NPC_REFRESH(MIL_13698_BARRY);
    AI_OUTPUT(SELF, OTHER, "DIA_Lena_SQ507_NewWeapon_03_01");
    AI_OUTPUT(OTHER, SELF, "DIA_Lena_SQ507_NewWeapon_15_02");
    AI_OUTPUT(SELF, OTHER, "DIA_Lena_SQ507_NewWeapon_03_03");
    INFO_CLEARCHOICES(85243);
    INFO_ADDCHOICE(85243, "Well, let's see...", 85246);
}

func void DIA_LENA_SQ507_GIVEWEAPON() {
    AI_OUTPUT(OTHER, SELF, "DIA_Lena_SQ507_GiveWeapon_15_01");
    INFO_CLEARCHOICES(85243);
    INFO_ADDCHOICE(85243, "I don't think I have any extra weapons.", 85257);
    if ((NPC_HASITEMS(OTHER, 39512)) > (0)) {
        INFO_ADDCHOICE(85243, "(Give a knife)", 85248);
    };
    if ((NPC_HASITEMS(OTHER, 34000)) > (0)) {
        INFO_ADDCHOICE(85243, "(Give a heavy branch)", 85249);
    };
    if ((NPC_HASITEMS(OTHER, 33995)) > (0)) {
        INFO_ADDCHOICE(85243, "(Give a dagger)", 85250);
    };
    if ((NPC_HASITEMS(OTHER, 33719)) > (0)) {
        INFO_ADDCHOICE(85243, "(Give a wolf knife)", 85251);
    };
    if ((NPC_HASITEMS(OTHER, 33999)) > (0)) {
        INFO_ADDCHOICE(85243, "(Give a club)", 85252);
    };
    if ((NPC_HASITEMS(OTHER, 33996)) > (0)) {
        INFO_ADDCHOICE(85243, "(Give a poker)", 85253);
    };
    if ((NPC_HASITEMS(OTHER, 34001)) > (0)) {
        INFO_ADDCHOICE(85243, "(Give an axe)", 85254);
    };
    if ((NPC_HASITEMS(OTHER, 33997)) > (0)) {
        INFO_ADDCHOICE(85243, "(Give a scythe)", 85255);
    };
    if ((NPC_HASITEMS(OTHER, 34005)) > (0)) {
        INFO_ADDCHOICE(85243, "(Give a spiked club)", 85256);
    };
}

func void B_LENA_EQUIPWEAPON() {
    AI_EQUIPBESTMELEEWEAPON(SELF);
    AI_OUTPUT(SELF, OTHER, "DIA_Lena_SQ507_GiveWeapon_03_02");
    AI_OUTPUT(SELF, OTHER, "DIA_Lena_SQ507_GiveWeapon_03_04");
    AI_LOGENTRY(TOPIC_SQ507, LOG_SQ507_LENAWEAPONV1);
    B_GIVEPLAYERXP(XP_SQ507_LENAWEAPON);
    AI_STOPPROCESSINFOS(SELF);
    DIA_LENA_SQ507_NEWWEAPON_GO();
}

func void DIA_LENA_SQ507_GIVEWEAPON_ITMW_1H_BAU_KNIFE() {
    B_GIVEINVITEMS(OTHER, SELF, 39512, 1);
    B_LENA_EQUIPWEAPON();
}

func void DIA_LENA_SQ507_GIVEWEAPON_ITMW_1H_BAU_MACE() {
    B_GIVEINVITEMS(OTHER, SELF, 34000, 1);
    B_LENA_EQUIPWEAPON();
}

func void DIA_LENA_SQ507_GIVEWEAPON_ITMW_1H_VLK_DAGGER() {
    B_GIVEINVITEMS(OTHER, SELF, 33995, 1);
    B_LENA_EQUIPWEAPON();
}

func void DIA_LENA_SQ507_GIVEWEAPON_ITMW_ADDON_KNIFE01() {
    B_GIVEINVITEMS(OTHER, SELF, 33719, 1);
    B_LENA_EQUIPWEAPON();
}

func void DIA_LENA_SQ507_GIVEWEAPON_ITMW_1H_MACE_L_03() {
    B_GIVEINVITEMS(OTHER, SELF, 33999, 1);
    B_LENA_EQUIPWEAPON();
}

func void DIA_LENA_SQ507_GIVEWEAPON_ITMW_1H_MACE_L_01() {
    B_GIVEINVITEMS(OTHER, SELF, 33996, 1);
    B_LENA_EQUIPWEAPON();
}

func void DIA_LENA_SQ507_GIVEWEAPON_ITMW_1H_VLK_AXE() {
    B_GIVEINVITEMS(OTHER, SELF, 34001, 1);
    B_LENA_EQUIPWEAPON();
}

func void DIA_LENA_SQ507_GIVEWEAPON_ITMW_1H_BAU_AXE() {
    B_GIVEINVITEMS(OTHER, SELF, 33997, 1);
    B_LENA_EQUIPWEAPON();
}

func void DIA_LENA_SQ507_GIVEWEAPON_ITMW_NAGELKNUEPPEL() {
    B_GIVEINVITEMS(OTHER, SELF, 34005, 1);
    B_LENA_EQUIPWEAPON();
}

func void DIA_LENA_SQ507_GIVEWEAPON_NOWEAPON() {
    AI_OUTPUT(OTHER, SELF, "DIA_Lena_SQ507_GiveWeapon_NoWeapon_15_01");
    AI_OUTPUT(SELF, OTHER, "DIA_Lena_SQ507_GiveWeapon_NoWeapon_03_02");
    AI_LOGENTRY(TOPIC_SQ507, LOG_SQ507_LENAWEAPONV2);
    AI_STOPPROCESSINFOS(SELF);
    DIA_LENA_SQ507_NEWWEAPON_GO();
}

