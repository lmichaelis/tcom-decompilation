instance QM401_FINALBATTLE(CUTSCENE) {
    ONSTART = FUNCTION(92840);
}

func void QM401_FINALBATTLE_START() {
    WLD_SENDTRIGGER("QM401_FINALBATTLE_01");
    TELEPORTNPCTOWP(1819, "PART9_QM401_BARREL_HERO");
    TELEPORTNPCTOWP(52439, "PART9_QM401_WINSTAN_PREPAREATTACK");
    AI_FUNCTION(HERO, 62848);
    AI_FUNCTION(HERO, 62849);
    AI_TURNTONPC(HERO, MIL_924_WINSTAN);
    AI_TURNTONPC(MIL_924_WINSTAN, HERO);
    AI_PLAYANI(HERO, "T_COMEOVERHERE");
    AI_WAIT(MIL_924_WINSTAN, 1058642330);
    AI_PLAYANI(MIL_924_WINSTAN, "T_IGETYOU");
    AI_TURNAWAY(MIL_924_WINSTAN, HERO);
    AI_SETWALKMODE(MIL_924_WINSTAN, NPC_WALK);
    AI_FUNCTION(MIL_924_WINSTAN, 92841);
    AI_GOTOWP(MIL_924_WINSTAN, "PART2_PATH_03");
}

func void QM401_FINALBATTLE_FADE() {
    FADESCREENTOBLACKF(2, 92842, 1000);
}

func void QM401_FINALBATTLE_FADESCREEN() {
    MUSIC_OVERRIDETRACK(21950);
    WLD_SENDTRIGGER("QM401_FINALBATTLE_02");
    WLD_SENDUNTRIGGER("QM401_FINALBATTLE_01");
    WLD_SENDTRIGGER("QM401_MOVER_PREPAREBARREL");
    QM401_LEAVEGUILD_MOVER_02 = FALSE;
    QM401_TELEPORTHERO();
    B_PASSTIME(2);
    AI_LOOKATNPC(HERO, MIL_6267_SALVI);
    AI_TURNTONPC(HERO, MARVIN_CUTSCENEHELPER_QM401);
    NPC_CLEARAIQUEUE(MIL_924_WINSTAN);
    NPC_CLEARAIQUEUE(MIL_4001_OKTAV);
    NPC_CLEARAIQUEUE(MIL_4044_SALL);
    NPC_CLEARAIQUEUE(MIL_6371_DUSTER);
    NPC_CLEARAIQUEUE(MIL_13511_MILITIA);
    NPC_CLEARAIQUEUE(MIL_13512_MILITIA);
    NPC_CLEARAIQUEUE(MIL_13513_MILITIA);
    NPC_CLEARAIQUEUE(MIL_13514_MILITIA);
    AI_TURNTONPC(MIL_924_WINSTAN, MARVIN_CUTSCENEHELPER_QM401);
    AI_TURNTONPC(MIL_4001_OKTAV, MARVIN_CUTSCENEHELPER_QM401);
    AI_TURNTONPC(MIL_4044_SALL, MARVIN_CUTSCENEHELPER_QM401);
    AI_TURNTONPC(MIL_6371_DUSTER, MARVIN_CUTSCENEHELPER_QM401);
    AI_TURNTONPC(MIL_13511_MILITIA, MARVIN_CUTSCENEHELPER_QM401);
    AI_TURNTONPC(MIL_13512_MILITIA, MARVIN_CUTSCENEHELPER_QM401);
    AI_TURNTONPC(MIL_13513_MILITIA, MARVIN_CUTSCENEHELPER_QM401);
    AI_TURNTONPC(MIL_13514_MILITIA, MARVIN_CUTSCENEHELPER_QM401);
    FF_APPLYONCEEXT(92843, 1000, 32);
}

func void QM401_FINALBATTLE_TIMER() {
    var int QM401_FINALBATTLE_TIMER_COUNT;
    QM401_FINALBATTLE_TIMER_COUNT = (QM401_FINALBATTLE_TIMER_COUNT) + (1);
    if ((QM401_FINALBATTLE_TIMER_COUNT) == (1)) {
        FADESCREENFROMBLACK(7);
        QM401_RENEGADESWALK();
    };
    if ((QM401_FINALBATTLE_TIMER_COUNT) == (12)) {
        WLD_SENDTRIGGER("QM401_FINALBATTLE_03");
        WLD_SENDUNTRIGGER("QM401_FINALBATTLE_02");
        B_REMOVENPC(50096);
        TELEPORTNPCTOWP(50096, MARVIN_CUTSCENEHELPER_QM401.WP);
    };
    if ((QM401_FINALBATTLE_TIMER_COUNT) == (18)) {
        WLD_SENDTRIGGER("QM401_FINALBATTLE_04");
        WLD_SENDUNTRIGGER("QM401_FINALBATTLE_03");
    };
    if ((QM401_FINALBATTLE_TIMER_COUNT) == (24)) {
        WLD_SENDTRIGGER("QM401_FINALBATTLE_05");
        WLD_SENDUNTRIGGER("QM401_FINALBATTLE_04");
    };
    if ((QM401_FINALBATTLE_TIMER_COUNT) == (26)) {
        WLD_SENDTRIGGER("QM401_FINALBATTLE_LIGHT");
        QM401_REMOVEROCKS();
        WLD_PLAYEFFECT("FX_EarthQuake", HERO, HERO, 0, 0, 0, FALSE);
        SND_PLAY("Ravens_Earthquake4");
        SND_PLAY("EXPLOSION02");
        SND_PLAY("SVM_1_BERZERK");
        SND_PLAY("SVM_2_BERZERK");
        AI_STARTFACEANI(HERO, S_SMUG, 1, -(1));
    };
    if ((QM401_FINALBATTLE_TIMER_COUNT) == (27)) {
        WLD_SENDTRIGGER("QM401_FINALBATTLE_LIGHT");
    };
    if ((QM401_FINALBATTLE_TIMER_COUNT) == (29)) {
        FF_APPLYONCEEXT(62853, 75, 4);
    };
}

