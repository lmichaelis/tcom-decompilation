func void SQ311_PREPAREMILITIA() {
    B_STARTOTHERROUTINE(MIL_4040_CABI, "SQ311_WAIT");
    NPC_REFRESH(MIL_4040_CABI);
    TELEPORTNPCTOWP(52903, MIL_4040_CABI.WP);
    B_STARTOTHERROUTINE(MIL_4042_NEIR, "SQ311_WAIT");
    NPC_REFRESH(MIL_4042_NEIR);
    TELEPORTNPCTOWP(52951, MIL_4042_NEIR.WP);
    PRINTD("Teleport");
}

func void SQ311_MALENDEADSCENE() {
    PRINTD("Malen dead");
    B_REMOVENPC(57213);
    FF_APPLYONCEEXTGT(62389, 0, -(1));
    B_STARTOTHERROUTINE(MIL_11131_ELWART, "SQ311_MALENDEAD");
    NPC_REFRESH(MIL_11131_ELWART);
    TELEPORTNPCTOWP(57209, MIL_11131_ELWART.WP);
    B_STARTOTHERROUTINE(MIL_11135_MILITIA, "SQ311_MALENDEAD");
    NPC_REFRESH(MIL_11135_MILITIA);
    TELEPORTNPCTOWP(57165, MIL_11135_MILITIA.WP);
    B_STARTOTHERROUTINE(MIL_11141_MILITIA, "SQ311_MALENDEAD");
    NPC_REFRESH(MIL_11141_MILITIA);
    TELEPORTNPCTOWP(57174, MIL_11141_MILITIA.WP);
    B_STARTOTHERROUTINE(BAU_11145_WORKER, "SQ311_MALENDEAD");
    NPC_REFRESH(BAU_11145_WORKER);
    TELEPORTNPCTOWP(57112, BAU_11145_WORKER.WP);
    B_STARTOTHERROUTINE(BAU_11146_WORKER, "SQ311_MALENDEAD");
    NPC_REFRESH(BAU_11146_WORKER);
    TELEPORTNPCTOWP(57116, BAU_11146_WORKER.WP);
    B_STARTOTHERROUTINE(BAU_11147_WORKER, "SQ311_MALENDEAD");
    NPC_REFRESH(BAU_11147_WORKER);
    TELEPORTNPCTOWP(57120, BAU_11147_WORKER.WP);
    B_STARTOTHERROUTINE(BAU_11160_WORKER, "SQ311_MALENDEAD");
    NPC_REFRESH(BAU_11160_WORKER);
    TELEPORTNPCTOWP(57124, BAU_11160_WORKER.WP);
    B_STARTOTHERROUTINE(BAU_11161_WORKER, "SQ311_MALENDEAD");
    NPC_REFRESH(BAU_11161_WORKER);
    TELEPORTNPCTOWP(57128, BAU_11161_WORKER.WP);
    B_STARTOTHERROUTINE(BAU_11162_WORKER, "SQ311_MALENDEAD");
    NPC_REFRESH(BAU_11162_WORKER);
    TELEPORTNPCTOWP(57132, BAU_11162_WORKER.WP);
    B_STARTOTHERROUTINE(BAU_11167_WORKER, "SQ311_MALENDEAD");
    NPC_REFRESH(BAU_11167_WORKER);
    TELEPORTNPCTOWP(57148, BAU_11167_WORKER.WP);
    B_STARTOTHERROUTINE(BAU_11168_WORKER, "SQ311_MALENDEAD");
    NPC_REFRESH(BAU_11168_WORKER);
    TELEPORTNPCTOWP(57153, BAU_11168_WORKER.WP);
    B_STARTOTHERROUTINE(NONE_11136_REFIR, "SQ311_MALENDEAD");
    NPC_REFRESH(NONE_11136_REFIR);
    TELEPORTNPCTOWP(57216, NONE_11136_REFIR.WP);
    B_STARTOTHERROUTINE(NONE_11137_NERAL, "SQ311_MALENDEAD");
    NPC_REFRESH(NONE_11137_NERAL);
    TELEPORTNPCTOWP(57222, NONE_11137_NERAL.WP);
}

func void SQ311_MALENDEADSCENE_APPLY() {
    var ZCMOVER MOVER1;
    var int MOVPTR1;
    var int SQ311_MALENDEADSCENE_COLLISION;
    if ((SQ311_MALENDEADSCENE_COLLISION) == (0)) {
        PRINTD("Rozpoczynam - SQ311_MalenDeadScene_Apply");
        MOVPTR1 = MEM_SEARCHVOBBYNAME("MOVER_SQ311_MALEN");
        MOVER1 = MEM_PTRTOINST(MOVPTR1);
        CHANGEVOBCOLLISION("SQ311_MALEN", FALSE, FALSE, FALSE, TRUE);
        WLD_SENDTRIGGER("MOVER_SQ311_MALEN");
        SQ311_MALENDEADSCENE_COLLISION = 1;
    };
    if (((MOVER1.MOVERSTATE) != (MOVER_STATE_OPENING)) && ((MOVER1.MOVERSTATE) != (MOVER_STATE_CLOSING))) {
        PRINTD("Skoñczy³em - SQ311_MalenDeadScene_Apply");
        CHANGEVOBCOLLISION("SQ311_MALEN", TRUE, TRUE, TRUE, TRUE);
        FF_REMOVE(62389);
        SQ311_MALENDEADSCENE_COLLISION = 0;
    };
}

func void SQ311_MINEINVESTIGATION() {
    NPC_EXCHANGEROUTINE(MIL_11131_ELWART, "SQ311_GUIDE");
    B_STARTOTHERROUTINE(BAU_11167_WORKER, "SQ311_INVESTIGATION");
    NPC_REFRESH(BAU_11167_WORKER);
    B_STARTOTHERROUTINE(BAU_11168_WORKER, "SQ311_INVESTIGATION");
    NPC_REFRESH(BAU_11168_WORKER);
    B_STARTOTHERROUTINE(MIL_4040_CABI, "SQ311_INVESTIGATION");
    NPC_REFRESH(MIL_4040_CABI);
    B_STARTOTHERROUTINE(MIL_4042_NEIR, "SQ311_INVESTIGATION");
    NPC_REFRESH(MIL_4042_NEIR);
    B_STARTOTHERROUTINE(MIL_11130_LEWKO, "SQ311_FIGHT");
    NPC_REFRESH(MIL_11130_LEWKO);
    TELEPORTNPCTOWP(57204, MIL_11130_LEWKO.WP);
    AI_TELEPORTALWAYS(MIL_11130_LEWKO, MIL_11130_LEWKO.WP, TRUE);
    MIL_4040_CABI.AIVAR[15] = FALSE;
    MIL_4042_NEIR.AIVAR[15] = FALSE;
}

func void SQ311_DRINKWITHLEWKO() {
    var int SQ311_LEWKOBEERDAMAGE;
    SQ311_DRINKWITHLEWKOPOINTS = (SQ311_DRINKWITHLEWKOPOINTS) + (1);
    if ((HERO.ATTRIBUTE[0]) > ((SQ311_LEWKOBEERDAMAGE) + (2))) {
        HERO.ATTRIBUTE[0] -= SQ311_LEWKOBEERDAMAGE;
    };
    HERO.ATTRIBUTE[0] = 2;
    B_STANDUP();
    AI_REMOVEWEAPON(OTHER);
    AI_REMOVEWEAPON(SELF);
    AI_STARTFACEANI(SELF, S_SMILE, 1, -(1));
    AI_STARTFACEANI(OTHER, S_SMILE, 1, -(1));
    AI_WAITTILLEND(SELF, OTHER);
    CREATEINVITEMS(SELF, 36363, 2);
    B_GIVEINVITEMS(SELF, OTHER, 36363, 1);
    B_USEITEM(SELF, 36363);
    AI_WAIT(OTHER, 1045220557);
    B_USEITEM(OTHER, 36363);
    AI_RESETFACEANI(OTHER);
    AI_RESETFACEANI(SELF);
}

func void SQ311_FIGHTINMINE() {
    PRINTD("AAAH! WALKA!");
    MIL_4040_CABI.FLAGS = 2;
    MIL_4042_NEIR.FLAGS = 2;
    NONE_11136_REFIR.FLAGS = 2;
    NONE_11137_NERAL.FLAGS = 2;
    BAU_11145_WORKER.FLAGS = 2;
    BAU_11146_WORKER.FLAGS = 2;
    BAU_11147_WORKER.FLAGS = 2;
    BAU_11160_WORKER.FLAGS = 2;
    BAU_11161_WORKER.FLAGS = 2;
    BAU_11162_WORKER.FLAGS = 2;
    BAU_11163_WORKER.FLAGS = 2;
    BAU_11164_WORKER.FLAGS = 2;
    BAU_11165_WORKER.FLAGS = 2;
    BAU_11166_WORKER.FLAGS = 2;
    BAU_11167_WORKER.FLAGS = 2;
    BAU_11168_WORKER.FLAGS = 2;
    BAU_11169_WORKER.FLAGS = 2;
    MIL_11132_GUARDMINE.FLAGS = 0;
    MIL_11143_STOCKGUARD.FLAGS = 0;
    MIL_11134_MILITIA.FLAGS = 0;
    MIL_11135_MILITIA.FLAGS = 0;
    MIL_11138_MILITIA.FLAGS = 0;
    MIL_11140_MILITIA.FLAGS = 0;
    MIL_11141_MILITIA.FLAGS = 0;
    MIL_11142_MILITIA.FLAGS = 0;
    MIL_11144_MILITIA.FLAGS = 0;
    MIL_11132_GUARDMINE.GUILD = GIL_BDT;
    MIL_11143_STOCKGUARD.GUILD = GIL_BDT;
    MIL_11134_MILITIA.GUILD = GIL_BDT;
    MIL_11135_MILITIA.GUILD = GIL_BDT;
    MIL_11138_MILITIA.GUILD = GIL_BDT;
    MIL_11140_MILITIA.GUILD = GIL_BDT;
    MIL_11141_MILITIA.GUILD = GIL_BDT;
    MIL_11142_MILITIA.GUILD = GIL_BDT;
    MIL_11144_MILITIA.GUILD = GIL_BDT;
    NPC_SETTRUEGUILD(MIL_11144_MILITIA, GIL_BDT);
    NPC_CLEARAIQUEUE(MIL_11132_GUARDMINE);
    NPC_SETTRUEGUILD(MIL_11142_MILITIA, GIL_BDT);
    B_STARTOTHERROUTINE(MIL_11132_GUARDMINE, "SQ311_FIGHT");
    NPC_SETTRUEGUILD(MIL_11141_MILITIA, GIL_BDT);
    TELEPORTNPCTOWP(57104, MIL_11132_GUARDMINE.WP);
    NPC_SETTRUEGUILD(MIL_11140_MILITIA, GIL_BDT);
    NPC_CLEARAIQUEUE(MIL_11143_STOCKGUARD);
    NPC_SETTRUEGUILD(MIL_11138_MILITIA, GIL_BDT);
    B_STARTOTHERROUTINE(MIL_11143_STOCKGUARD, "SQ311_FIGHT");
    NPC_SETTRUEGUILD(MIL_11135_MILITIA, GIL_BDT);
    TELEPORTNPCTOWP(57107, MIL_11143_STOCKGUARD.WP);
    NPC_SETTRUEGUILD(MIL_11134_MILITIA, GIL_BDT);
    NPC_CLEARAIQUEUE(MIL_11134_MILITIA);
    NPC_SETTRUEGUILD(MIL_11143_STOCKGUARD, GIL_BDT);
    B_STARTOTHERROUTINE(MIL_11134_MILITIA, "SQ311_FIGHT");
    NPC_SETTRUEGUILD(MIL_11132_GUARDMINE, GIL_BDT);
    TELEPORTNPCTOWP(57162, MIL_11134_MILITIA.WP);
    NPC_CLEARAIQUEUE(MIL_11138_MILITIA);
    B_STARTOTHERROUTINE(MIL_11138_MILITIA, "SQ311_FIGHT");
    TELEPORTNPCTOWP(57168, MIL_11138_MILITIA.WP);
    NPC_CLEARAIQUEUE(MIL_11140_MILITIA);
    B_STARTOTHERROUTINE(MIL_11140_MILITIA, "SQ311_FIGHT");
    TELEPORTNPCTOWP(57171, MIL_11140_MILITIA.WP);
    NPC_CLEARAIQUEUE(MIL_11142_MILITIA);
    B_STARTOTHERROUTINE(MIL_11142_MILITIA, "SQ311_FIGHT2");
    TELEPORTNPCTOWP(57177, MIL_11142_MILITIA.WP);
    NPC_CLEARAIQUEUE(MIL_11144_MILITIA);
    B_STARTOTHERROUTINE(MIL_11144_MILITIA, "SQ311_FIGHT");
    TELEPORTNPCTOWP(57181, MIL_11144_MILITIA.WP);
    NPC_SETTRUEGUILD(HERO, HERO.GUILD);
}

func void SQ311_AFTERFIGHT() {
    MIL_4040_CABI.AIVAR[15] = FALSE;
    MIL_4042_NEIR.AIVAR[15] = FALSE;
    NONE_11136_REFIR.AIVAR[15] = FALSE;
    NONE_11137_NERAL.AIVAR[15] = FALSE;
    BAU_11145_WORKER.AIVAR[15] = FALSE;
    BAU_11146_WORKER.AIVAR[15] = FALSE;
    BAU_11147_WORKER.AIVAR[15] = FALSE;
    BAU_11160_WORKER.AIVAR[15] = FALSE;
    BAU_11161_WORKER.AIVAR[15] = FALSE;
    BAU_11162_WORKER.AIVAR[15] = FALSE;
    BAU_11163_WORKER.AIVAR[15] = FALSE;
    BAU_11164_WORKER.AIVAR[15] = FALSE;
    BAU_11165_WORKER.AIVAR[15] = FALSE;
    BAU_11166_WORKER.AIVAR[15] = FALSE;
    BAU_11167_WORKER.AIVAR[15] = FALSE;
    BAU_11168_WORKER.AIVAR[15] = FALSE;
    BAU_11169_WORKER.AIVAR[15] = FALSE;
    MIL_4040_CABI.FLAGS = NPC_FLAG_IMPORTANT;
    MIL_4042_NEIR.FLAGS = NPC_FLAG_IMPORTANT;
    NONE_11136_REFIR.FLAGS = NPC_FLAG_IMPORTANT;
    NONE_11137_NERAL.FLAGS = NPC_FLAG_IMPORTANT;
    TELEPORTNPCTOWP(52903, MIL_4040_CABI.WP);
    TELEPORTNPCTOWP(52951, MIL_4042_NEIR.WP);
    NPC_CLEARAIQUEUE(BAU_11145_WORKER);
    B_STARTOTHERROUTINE(BAU_11145_WORKER, "SQ311_AFTERFIGHT");
    TELEPORTNPCTOWP(57112, BAU_11145_WORKER.WP);
    NPC_CLEARAIQUEUE(BAU_11146_WORKER);
    B_STARTOTHERROUTINE(BAU_11146_WORKER, "SQ311_AFTERFIGHT");
    TELEPORTNPCTOWP(57116, BAU_11146_WORKER.WP);
    NPC_CLEARAIQUEUE(BAU_11147_WORKER);
    B_STARTOTHERROUTINE(BAU_11147_WORKER, "SQ311_AFTERFIGHT");
    TELEPORTNPCTOWP(57120, BAU_11147_WORKER.WP);
    NPC_CLEARAIQUEUE(BAU_11160_WORKER);
    B_STARTOTHERROUTINE(BAU_11160_WORKER, "SQ311_AFTERFIGHT");
    TELEPORTNPCTOWP(57124, BAU_11160_WORKER.WP);
    NPC_CLEARAIQUEUE(BAU_11161_WORKER);
    B_STARTOTHERROUTINE(BAU_11161_WORKER, "SQ311_AFTERFIGHT");
    TELEPORTNPCTOWP(57128, BAU_11161_WORKER.WP);
    NPC_CLEARAIQUEUE(BAU_11162_WORKER);
    B_STARTOTHERROUTINE(BAU_11162_WORKER, "SQ311_AFTERFIGHT");
    TELEPORTNPCTOWP(57132, BAU_11162_WORKER.WP);
    NPC_CLEARAIQUEUE(BAU_11163_WORKER);
    B_STARTOTHERROUTINE(BAU_11163_WORKER, "SQ311_AFTERFIGHT");
    TELEPORTNPCTOWP(57136, BAU_11163_WORKER.WP);
    NPC_CLEARAIQUEUE(BAU_11164_WORKER);
    B_STARTOTHERROUTINE(BAU_11164_WORKER, "SQ311_AFTERFIGHT");
    TELEPORTNPCTOWP(57139, BAU_11164_WORKER.WP);
    NPC_CLEARAIQUEUE(BAU_11165_WORKER);
    B_STARTOTHERROUTINE(BAU_11165_WORKER, "SQ311_AFTERFIGHT");
    TELEPORTNPCTOWP(57142, BAU_11165_WORKER.WP);
    NPC_CLEARAIQUEUE(BAU_11166_WORKER);
    B_STARTOTHERROUTINE(BAU_11166_WORKER, "SQ311_AFTERFIGHT");
    TELEPORTNPCTOWP(57145, BAU_11166_WORKER.WP);
    NPC_CLEARAIQUEUE(BAU_11169_WORKER);
    B_STARTOTHERROUTINE(BAU_11169_WORKER, "SQ311_AFTERFIGHT");
    TELEPORTNPCTOWP(57158, BAU_11169_WORKER.WP);
    NPC_CLEARAIQUEUE(NONE_11136_REFIR);
    B_STARTOTHERROUTINE(NONE_11136_REFIR, "SQ311_AFTERFIGHT");
    TELEPORTNPCTOWP(57216, NONE_11136_REFIR.WP);
    NPC_CLEARAIQUEUE(NONE_11137_NERAL);
    B_STARTOTHERROUTINE(NONE_11137_NERAL, "SQ311_AFTERFIGHT");
    TELEPORTNPCTOWP(57222, NONE_11137_NERAL.WP);
}

func void SQ311_SPAWNNEWMILITIA() {
    WLD_INSERTNPC(57184, "PART10_MINE_13");
    WLD_INSERTNPC(57186, "PART10_MINE_13");
    WLD_INSERTNPC(57188, "PART10_MINE_13");
    WLD_INSERTNPC(57190, "PART10_MINE_13");
    WLD_INSERTNPC(57192, "PART10_MINE_13");
    WLD_INSERTNPC(57194, "PART10_MINE_13");
    WLD_INSERTNPC(57198, "PART10_MINE_13");
    WLD_INSERTNPC(57200, "PART10_MINE_13");
    WLD_INSERTNPC(57202, "PART10_MINE_13");
}

func void SQ311_FINISHQUEST() {
    SQ311_HIDEMALENCORPSE = 1;
    SQ311_HIDEMALENCORPSE_DAY = WLD_GETDAY();
    LOG_SETSTATUS(_@(MIS_SQ311), TOPIC_SQ311, LOG_SUCCESS);
    B_GIVEPLAYERXP(XP_SQ311_FINISH);
    NPC_CLEARAIQUEUE(MIL_4040_CABI);
    B_STARTOTHERROUTINE(MIL_4040_CABI, START);
    NPC_CLEARAIQUEUE(MIL_4042_NEIR);
    B_STARTOTHERROUTINE(MIL_4042_NEIR, START);
    SQ311_SPAWNNEWMILITIA();
}

