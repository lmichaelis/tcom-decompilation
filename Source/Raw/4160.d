var int BODYGUARD_GOAWAY = 0;
var int BODYGUARD_FIST = 0;
instance DIA_BODYGUARD01_EXIT(C_INFO) {
    NPC = 0xe420;
    NR = 999;
    CONDITION = DIA_BODYGUARD01_EXIT_CONDITION;
    INFORMATION = DIA_BODYGUARD01_EXIT_INFO;
    PERMANENT = TRUE;
    DESCRIPTION = DIALOG_ENDE;
}

func int DIA_BODYGUARD01_EXIT_CONDITION() {
    return TRUE;
}

func void DIA_BODYGUARD01_EXIT_INFO() {
    AI_STOPPROCESSINFOS(SELF);
}

instance DIA_BODYGUARD01_HELLO(C_INFO) {
    NPC = 0xe420;
    NR = 1;
    CONDITION = DIA_BODYGUARD01_HELLO_CONDITION;
    INFORMATION = DIA_BODYGUARD01_HELLO_INFO;
    PERMANENT = FALSE;
    IMPORTANT = TRUE;
}

func int DIA_BODYGUARD01_HELLO_CONDITION() {
    if ((LOG_GETSTATUS(MIS_Q304)) == (LOG_RUNNING)) {
        return TRUE;
    };
    return 0 /* !broken stack! */;
}

func void DIA_BODYGUARD01_KILLINDIALOGUE() {
    AI_WAITTILLEND(SELF, OTHER);
    HERO.ATTRIBUTE[0] = 1;
    AI_DRAWWEAPON(SELF);
    AI_SETWALKMODE(SELF, NPC_WALK);
    AI_GOTONPC(SELF, OTHER);
    AI_WAITTILLEND(OTHER, SELF);
    AI_WAITTILLEND(SELF, OTHER);
    AI_FUNCTION(SELF, 0x14564);
    INFO_CLEARCHOICES(0x14739);
    AI_STOPPROCESSINFOS(SELF);
}

func void DIA_BODYGUARD01_HELLO_INFO() {
    AI_OUTPUT(OTHER, SELF, "DIA_Bodyguard01_HELLO_15_01");
    AI_OUTPUT(SELF, OTHER, "DIA_Bodyguard01_HELLO_03_02");
    INFO_CLEARCHOICES(0x1455c);
    if ((NPC_HASITEMS(OTHER, 0x859b)) >= (1)) {
        INFO_ADDCHOICE(0x1455c, "(Show a gold coin)", 0x14560);
    };
    if ((NPC_HASITEMS(OTHER, 0x859c)) >= (1)) {
        INFO_ADDCHOICE(0x1455c, "(Show an old coin)", 0x14561);
    };
    if ((NPC_HASITEMS(OTHER, 0x9180)) >= (1)) {
        INFO_ADDCHOICE(0x1455c, "(Show the strange coin)", 0x14562);
    };
    INFO_ADDCHOICE(0x1455c, "(Show fist - Provoke)", 0x14563);
}

func void DIA_BODYGUARD01_HELLO_GOLDCOIN() {
    B_USEFAKECOIN_GOLD_MARVIN();
    DIA_BODYGUARD01_KILLINDIALOGUE();
}

func void DIA_BODYGUARD01_HELLO_OLDCOIN() {
    B_USEFAKECOIN_OLDCOIN_MARVIN();
    DIA_BODYGUARD01_KILLINDIALOGUE();
}

func void DIA_BODYGUARD01_HELLO_WEIRDCOIN() {
    BODYGUARD_GOAWAY = TRUE;
    B_USEFAKECOIN_WEIRDCOIN_MARVIN();
    AI_WAITTILLEND(SELF, OTHER);
    AI_OUTPUT(SELF, OTHER, "DIA_Bodyguard01_HELLO_WeirdCoin_03_01");
    AI_LOGENTRY(TOPIC_Q304, LOG_Q304_TOTHECAVE);
    INFO_CLEARCHOICES(0x1455c);
    AI_STOPPROCESSINFOS(SELF);
}

func void DIA_BODYGUARD01_HELLO_FIST() {
    BODYGUARD_FIST = TRUE;
    AI_PLAYANI(OTHER, "T_STAND_2_DRUNKTEST");
    DIA_BODYGUARD01_KILLINDIALOGUE();
}

func void BODYGUARD_KILLMARVIN() {
    MDL_APPLYOVERLAYMDS(HERO, "HUMANS_SUDDENDEATH.MDS");
    AI_PLAYANI(NONE_6336_BODYGUARD, T_1HATTACKR);
    AI_PLAYANI(HERO, T_DEAD);
    SND_PLAY("FIG_SwordFinal");
    SND_PLAY("SVM_15_DEAD");
    HERO.ATTRIBUTE[1] = -(1);
    HERO.ATTRIBUTE[0] = -(1);
    AI_REMOVEWEAPON(NONE_6336_BODYGUARD);
    HERO.AIVAR[4] = FALSE;
}

instance DIA_BODYGUARD01_GOAWAY(C_INFO) {
    NPC = 0xe420;
    NR = 1;
    CONDITION = DIA_BODYGUARD01_GOAWAY_CONDITION;
    INFORMATION = DIA_BODYGUARD01_GOAWAY_INFO;
    PERMANENT = TRUE;
    IMPORTANT = TRUE;
}

func int DIA_BODYGUARD01_GOAWAY_CONDITION() {
    if (((BODYGUARD_GOAWAY) == (TRUE)) && (NPC_ISINSTATE(SELF, 0xf09f))) {
        if ((Q304_CUTSCENEENDING) == (0)) {
            return TRUE;
        };
    };
    return 0 /* !broken stack! */;
}

func void DIA_BODYGUARD01_GOAWAY_INFO() {
    NPC_INITAMBIENTS(SELF, 4);
    if ((NPC_GETLASTAMBIENT(SELF)) == (1)) {
        AI_OUTPUT(SELF, OTHER, "DIA_Bodyguard01_GoAway_03_01");
    };
    if ((NPC_GETLASTAMBIENT(SELF)) == (2)) {
        AI_OUTPUT(SELF, OTHER, "DIA_Bodyguard01_GoAway_03_02");
    };
    if ((NPC_GETLASTAMBIENT(SELF)) == (3)) {
        AI_OUTPUT(SELF, OTHER, "DIA_Bodyguard01_GoAway_03_03");
    };
    if ((NPC_GETLASTAMBIENT(SELF)) == (4)) {
        AI_OUTPUT(SELF, OTHER, "DIA_Bodyguard01_GoAway_03_04");
    };
    AI_STOPPROCESSINFOS(SELF);
}

instance DIA_BODYGUARD_FIGHT(C_INFO) {
    NPC = 0xe420;
    NR = 1;
    CONDITION = DIA_BODYGUARD_FIGHT_CONDITION;
    INFORMATION = DIA_BODYGUARD_FIGHT_INFO;
    PERMANENT = FALSE;
    IMPORTANT = TRUE;
}

func int DIA_BODYGUARD_FIGHT_CONDITION() {
    if (((LOG_GETSTATUS(MIS_Q304)) == (LOG_RUNNING)) && ((Q304_CUTSCENEENDING) == (1))) {
        return TRUE;
    };
    return 0 /* !broken stack! */;
}

func void DIA_BODYGUARD_FIGHT_INFO() {
    AI_OUTPUT(SELF, OTHER, "DIA_Bodyguard_Fight_03_01");
    INFO_CLEARCHOICES(0x14568);
    INFO_ADDCHOICE(0x14568, "Yes, it's me, your worst nightmare.", 0x1456c);
    INFO_ADDCHOICE(0x14568, "Have you been looking for me?", 0x1456d);
}

func void BODYGUARD_SWAMP_KILLMARVIN() {
    NPC_SETTRUEGUILD(NONE_6336_BODYGUARD, GIL_BDT);
    NONE_6336_BODYGUARD.GUILD = GIL_BDT;
    NONE_6336_BODYGUARD.FLAGS = 0;
    NONE_6336_BODYGUARD.AIVAR[52] = TRUE;
    NPC_SETTRUEGUILD(HERO, HERO.GUILD);
    INFO_CLEARCHOICES(0x14568);
    AI_STOPPROCESSINFOS(SELF);
    B_ATTACK(SELF, OTHER, AR_KILL, 1);
    AI_LOGENTRY(TOPIC_Q304, LOG_Q304_BODYGUARD);
    AI_RESETFACEANI(OTHER);
}

func void DIA_BODYGUARD_FIGHT_NIGHTMARE() {
    AI_STARTFACEANI(OTHER, S_ANGRY, 1, -(1));
    AI_DRAWWEAPON(OTHER);
    AI_OUTPUT(OTHER, SELF, "DIA_Bodyguard_Fight_Nightmare_15_01");
    AI_WAITTILLEND(SELF, OTHER);
    AI_PLAYANI(SELF, T_LAUGH);
    AI_OUTPUT(SELF, OTHER, "DIA_Bodyguard_Fight_Nightmare_03_02");
    AI_DRAWWEAPON(SELF);
    AI_OUTPUT(SELF, OTHER, "DIA_Bodyguard_Fight_Nightmare_03_03");
    BODYGUARD_SWAMP_KILLMARVIN();
}

func void DIA_BODYGUARD_FIGHT_LOOKING() {
    AI_OUTPUT(OTHER, SELF, "DIA_Bodyguard_Fight_Looking_15_01");
    AI_OUTPUT(SELF, OTHER, "DIA_Bodyguard_Fight_Looking_03_02");
    AI_DRAWWEAPON(SELF);
    AI_OUTPUT(SELF, OTHER, "DIA_Bodyguard_Fight_Looking_03_03");
    BODYGUARD_SWAMP_KILLMARVIN();
}

