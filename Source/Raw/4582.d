instance Q311_GERSTANDTAVERN(CUTSCENE) {
    ONSTART = FUNCTION(0x169af);
}

func void Q311_GERSTANDTAVERN_START() {
    Q311_PROPAGANDISTCOUNT = (Q311_PROPAGANDISTCOUNT) + (1);
    WLD_SENDTRIGGER("KM_TAVERN_CUTSCENE_01");
    TELEPORTNPCTOWP(0xd017, "PARTM4_TAVERN_CUTSCENE_PROPAGANDIST");
    TELEPORTNPCTOWP(0x71b, "PARTM4_TAVERN_CUTSCENE_HERO");
    NPC_CLEARAIQUEUE(VLK_6417_PROPAGANDIST);
    VLK_6417_PROPAGANDIST.AIVAR[92] = TRUE;
    AI_TURNTONPC(VLK_6417_PROPAGANDIST, HERO);
    AI_TURNTONPC(HERO, VLK_6417_PROPAGANDIST);
    AI_STARTFACEANI(HERO, S_ANGRY, 1, -(1));
    if (NPC_HASGUILDARMOREQUIPPED(HERO, GIL_MIL)) {
        AI_OUTPUT(VLK_6417_PROPAGANDIST, HERO, "DIA_Propagandist_Talk01_03_01");
        AI_FUNCTION(VLK_6417_PROPAGANDIST, 0x169b0);
        AI_WAITTILLEND(VLK_6418_CITIZEN, VLK_6417_PROPAGANDIST);
        AI_WAITTILLEND(VLK_6419_CITIZEN, VLK_6417_PROPAGANDIST);
        AI_WAITTILLEND(VLK_6420_CITIZEN, VLK_6417_PROPAGANDIST);
        AI_WAITTILLEND(VLK_6421_CITIZEN, VLK_6417_PROPAGANDIST);
        AI_TURNTONPC(VLK_6418_CITIZEN, HERO);
        AI_TURNTONPC(VLK_6419_CITIZEN, HERO);
        AI_TURNTONPC(VLK_6420_CITIZEN, HERO);
        AI_TURNTONPC(VLK_6421_CITIZEN, HERO);
        AI_OUTPUT(VLK_6417_PROPAGANDIST, HERO, "DIA_Propagandist_Talk01_03_02");
        AI_FUNCTION(VLK_6417_PROPAGANDIST, 0x169b1);
        AI_WAIT(VLK_6417_PROPAGANDIST, 0x40800000);
        AI_OUTPUT(VLK_6417_PROPAGANDIST, HERO, "DIA_Propagandist_Talk01_03_03");
        AI_FUNCTION(VLK_6417_PROPAGANDIST, 0x169b2);
        AI_OUTPUT(VLK_6417_PROPAGANDIST, HERO, "DIA_Propagandist_Talk01_03_04");
        AI_OUTPUT(VLK_6417_PROPAGANDIST, HERO, "DIA_Propagandist_Talk01_03_05");
    };
    if (NPC_HASGUILDARMOREQUIPPED(HERO, GIL_SLD)) {
        AI_OUTPUT(VLK_6417_PROPAGANDIST, HERO, "DIA_Propagandist_Talk01_03_06");
        AI_OUTPUT(VLK_6417_PROPAGANDIST, HERO, "DIA_Propagandist_Talk01_03_07");
        AI_FUNCTION(VLK_6417_PROPAGANDIST, 0x169b0);
        AI_WAITTILLEND(VLK_6418_CITIZEN, VLK_6417_PROPAGANDIST);
        AI_WAITTILLEND(VLK_6419_CITIZEN, VLK_6417_PROPAGANDIST);
        AI_WAITTILLEND(VLK_6420_CITIZEN, VLK_6417_PROPAGANDIST);
        AI_WAITTILLEND(VLK_6421_CITIZEN, VLK_6417_PROPAGANDIST);
        AI_TURNTONPC(VLK_6418_CITIZEN, HERO);
        AI_TURNTONPC(VLK_6419_CITIZEN, HERO);
        AI_TURNTONPC(VLK_6420_CITIZEN, HERO);
        AI_TURNTONPC(VLK_6421_CITIZEN, HERO);
        AI_OUTPUT(VLK_6417_PROPAGANDIST, HERO, "DIA_Propagandist_Talk01_03_08");
        AI_FUNCTION(VLK_6417_PROPAGANDIST, 0x169b1);
        AI_WAIT(VLK_6417_PROPAGANDIST, 0x40800000);
        AI_OUTPUT(VLK_6417_PROPAGANDIST, HERO, "DIA_Propagandist_Talk01_03_09");
        AI_FUNCTION(VLK_6417_PROPAGANDIST, 0x169b2);
        AI_OUTPUT(VLK_6417_PROPAGANDIST, HERO, "DIA_Propagandist_Talk01_03_10");
        AI_OUTPUT(VLK_6417_PROPAGANDIST, HERO, "DIA_Propagandist_Talk01_03_11");
        AI_OUTPUT(VLK_6417_PROPAGANDIST, HERO, "DIA_Propagandist_Talk01_03_12");
    };
    AI_FUNCTION(VLK_6417_PROPAGANDIST, 0x169b3);
    AI_OUTPUT(VLK_6417_PROPAGANDIST, HERO, "DIA_Propagandist_Talk01_03_13");
    AI_OUTPUT(VLK_6417_PROPAGANDIST, HERO, "DIA_Propagandist_Talk01_03_14");
    AI_FUNCTION(VLK_6417_PROPAGANDIST, 0x169b4);
}

func void Q311_TAVERNECUTSCENE_01() {
    WLD_SENDTRIGGER("KM_TAVERN_CUTSCENE_02");
    WLD_SENDUNTRIGGER("KM_TAVERN_CUTSCENE_01");
}

func void Q311_TAVERNECUTSCENE_02() {
    TELEPORTNPCTOWP(0x71b, "PARTM4_TAVERN_CUTSCENE_HERO");
    WLD_SENDTRIGGER("KM_TAVERN_CUTSCENE_03");
    WLD_SENDUNTRIGGER("KM_TAVERN_CUTSCENE_02");
    WLD_SENDTRIGGER("Q311_CROWD_BOO");
}

func void Q311_TAVERNECUTSCENE_03() {
    WLD_SENDTRIGGER("KM_TAVERN_CUTSCENE_04");
    WLD_SENDUNTRIGGER("KM_TAVERN_CUTSCENE_03");
}

func void Q311_TAVERNECUTSCENE_04() {
    WLD_SENDTRIGGER("KM_TAVERN_CUTSCENE_05");
    WLD_SENDUNTRIGGER("KM_TAVERN_CUTSCENE_04");
}

func void Q311_TAVERNECUTSCENE_05() {
    FF_APPLYONCEEXT(0x169b5, 75, 4);
}

func void Q311_TAVERNECUTSCENE_END() {
    Q311_TAVERNECUTSCENE_END_COUNT = (Q311_TAVERNECUTSCENE_END_COUNT) + (1);
    if ((Q311_TAVERNECUTSCENE_END_COUNT) == (4)) {
        Q311_TAVERNCUTSCENE = 2;
        WLD_SENDUNTRIGGER("KM_TAVERN_CUTSCENE_05");
        WLD_SENDUNTRIGGER("KM_TAVERN_CUTSCENE_01");
        if (NPC_HASGUILDARMOREQUIPPED(HERO, GIL_MIL)) {
            B_LOGENTRY(TOPIC_Q311, LOG_Q311_TAVERNCUTSCENE_V1);
        } else if (NPC_HASGUILDARMOREQUIPPED(HERO, GIL_SLD)) {
            B_LOGENTRY(TOPIC_Q311, LOG_Q311_TAVERNCUTSCENE_V2);
        } else {
            B_LOGENTRY(TOPIC_Q311, LOG_Q311_TAVERNCUTSCENE_V3);
        } else {
            B_STARTOTHERROUTINE(VLK_6417_PROPAGANDIST, START);
        } else {
            NPC_REFRESH(VLK_6417_PROPAGANDIST);
        } else {
            VLK_6417_PROPAGANDIST.AIVAR[92] = FALSE;
        } else {
            TELEPORTNPCTOWP(0xd017, "PARTM4_TAVERN_CHAIR_05");
        } else {
            AI_STOPLOOKAT(HERO);
        } else {
            AI_RESETFACEANI(HERO);
        } else {
            HERO.AIVAR[4] = FALSE;
        } else {
            B_STARTOTHERROUTINE(VLK_6418_CITIZEN, START);
        } else {
            NPC_REFRESH(VLK_6418_CITIZEN);
        } else {
            B_STARTOTHERROUTINE(VLK_6419_CITIZEN, START);
        } else {
            NPC_REFRESH(VLK_6419_CITIZEN);
        } else {
            B_STARTOTHERROUTINE(VLK_6420_CITIZEN, START);
        } else {
            NPC_REFRESH(VLK_6420_CITIZEN);
        } else {
            B_STARTOTHERROUTINE(VLK_6421_CITIZEN, START);
        } else {
            NPC_REFRESH(VLK_6421_CITIZEN);
        };
    };
}

var int Q311_TAVERNECUTSCENE_END.Q311_TAVERNECUTSCENE_END_COUNT = 0;
