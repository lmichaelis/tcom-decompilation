func void QA302_PREPAREQUEST() {
    WLD_INSERTNPC(0xc48b, "PART2_PATH_68");
    WLD_INSERTNPC(0xc528, "PART2_MOB_32");
    WLD_INSERTNPC(0xc529, "PART2_MOB_33");
    WLD_INSERTNPC(0xc52a, "PART2_MOB_34");
    WLD_INSERTNPC(0xc52b, "PART2_MOB_36");
    QA302_AVOID_RANDOM_TRAPS();
    FF_APPLYONCEEXTGT(0xeff4, 0, -(1));
}

func void QA302_PREPAREQUEST_APPLY() {
    if ((QA302_PREPAREQUEST_COUNT) == (0)) {
        PRINTD("Rozpoczynam - QA302_PrepareQuest_Apply");
        MOVPTR1 = MEM_SEARCHVOBBYNAME("QA302_MOVER_CLUES_01");
        MOVER1 = MEM_PTRTOINST(MOVPTR1);
        MOVPTR2 = MEM_SEARCHVOBBYNAME("QA302_MOVER_CLUES_02");
        MOVER2 = MEM_PTRTOINST(MOVPTR2);
        MOVPTR3 = MEM_SEARCHVOBBYNAME("QA302_MOVER_CLUES_03");
        MOVER3 = MEM_PTRTOINST(MOVPTR3);
        MOVPTR4 = MEM_SEARCHVOBBYNAME("QA302_MOVER_CLUES_04");
        MOVER4 = MEM_PTRTOINST(MOVPTR4);
        MOVPTR5 = MEM_SEARCHVOBBYNAME("QA302_MOVER_LINES");
        MOVER5 = MEM_PTRTOINST(MOVPTR5);
        CHANGEVOBCOLLISION("QA302_SHIELDS_01", FALSE, FALSE, FALSE, TRUE);
        CHANGEVOBCOLLISION("QA302_SHIELDS_02", FALSE, FALSE, FALSE, TRUE);
        WLD_SENDTRIGGER("QA302_MOVER_CLUES_01");
        WLD_SENDTRIGGER("QA302_MOVER_CLUES_02");
        WLD_SENDTRIGGER("QA302_MOVER_CLUES_03");
        WLD_SENDTRIGGER("QA302_MOVER_CLUES_04");
        WLD_SENDTRIGGER("QA302_MOVER_LINES");
        QA302_PREPAREQUEST_COUNT = 1;
        if ((QA302_LEAVEGUILD_MOVER_01) == (TRUE)) {
            QA302_LEAVEGUILD_MOVER_01 = FALSE;
        };
    };
    if (((((((((((MOVER1.MOVERSTATE) != (MOVER_STATE_OPENING)) && ((MOVER1.MOVERSTATE) != (MOVER_STATE_CLOSING))) && ((MOVER2.MOVERSTATE) != (MOVER_STATE_OPENING))) && ((MOVER2.MOVERSTATE) != (MOVER_STATE_CLOSING))) && ((MOVER3.MOVERSTATE) != (MOVER_STATE_OPENING))) && ((MOVER3.MOVERSTATE) != (MOVER_STATE_CLOSING))) && ((MOVER4.MOVERSTATE) != (MOVER_STATE_OPENING))) && ((MOVER4.MOVERSTATE) != (MOVER_STATE_CLOSING))) && ((MOVER5.MOVERSTATE) != (MOVER_STATE_OPENING))) && ((MOVER5.MOVERSTATE) != (MOVER_STATE_CLOSING))) {
        PRINTD("Skoñczy³em - QA302_PrepareQuest_Apply");
        CHANGEVOBCOLLISION("QA302_SHIELDS_01", TRUE, TRUE, TRUE, TRUE);
        CHANGEVOBCOLLISION("QA302_SHIELDS_02", TRUE, TRUE, TRUE, TRUE);
        FF_REMOVE(0xeff4);
        QA302_PREPAREQUEST_COUNT = 0;
        if ((QA302_LEAVEGUILD_MOVER_01) == (FALSE)) {
            QA302_LEAVEGUILD_MOVER_01 = TRUE;
        };
    };
}

var int QA302_PREPAREQUEST_APPLY.QA302_PREPAREQUEST_COUNT = 0;
instance QA302_PREPAREQUEST_APPLY.MOVER1(ZCMOVER)
instance QA302_PREPAREQUEST_APPLY.MOVER2(ZCMOVER)
instance QA302_PREPAREQUEST_APPLY.MOVER3(ZCMOVER)
instance QA302_PREPAREQUEST_APPLY.MOVER4(ZCMOVER)
instance QA302_PREPAREQUEST_APPLY.MOVER5(ZCMOVER)
var int QA302_PREPAREQUEST_APPLY.MOVPTR1 = 0;
var int QA302_PREPAREQUEST_APPLY.MOVPTR2 = 0;
var int QA302_PREPAREQUEST_APPLY.MOVPTR3 = 0;
var int QA302_PREPAREQUEST_APPLY.MOVPTR4 = 0;
var int QA302_PREPAREQUEST_APPLY.MOVPTR5 = 0;
func void QA302_PREPAREERNESTO() {
    B_STARTOTHERROUTINE(VLK_3024_ERNESTO, "QA302_GERSTAND_INN");
    TELEPORTNPCTOWP(0xd0af, VLK_3024_ERNESTO.WP);
    B_STARTOTHERROUTINE(VLK_6421_CITIZEN, "QA302_GERSTAND_INN");
}

func void QA302_ERNESTORTN() {
    if (((LOG_GETSTATUS(MIS_FAQ002)) == (LOG_SUCCESS)) || ((KAPITEL) >= (4))) {
        B_STARTOTHERROUTINE(VLK_3024_ERNESTO, "OLDCITY");
    };
    B_STARTOTHERROUTINE(VLK_3024_ERNESTO, START);
    B_STARTOTHERROUTINE(VLK_6421_CITIZEN, START);
}

func void QA302_FOLLOWCITIZEN_SPAWN() {
    PRINTD("Spawn");
    QA302_CARAMON_RTNCHECK = 3;
    B_STARTOTHERROUTINE(SLD_1009_CARAMON, "QA302_GERSTAND_WAIT");
    NPC_REFRESH(SLD_1009_CARAMON);
    TELEPORTNPCTOWP(0xcb1c, SLD_1009_CARAMON.WP);
    WLD_INSERTNPC(0xd295, "PARTM4_PATH_81");
}

func void QA302_FOLLOWCITIZEN_CHANGERTN() {
    QA302_FOLLOWCITIZEN = 1;
    QA302_CARAMON_RTNCHECK = 4;
    NPC_EXCHANGEROUTINE(SLD_1009_CARAMON, "QA302_GERSTAND_FOLLOW_V1");
}

func void QA302_PREPAREBANDITS() {
    QA302_BANDITS_CUTSCENEENABLE = 1;
    WLD_INSERTNPC(0xd28f, "HARBOUR_QA302_SPOT_05");
    WLD_INSERTNPC(0xd291, "HARBOUR_QA302_SPOT_05");
    WLD_INSERTNPC(0xd293, "HARBOUR_QA302_SPOT_05");
    WLD_INSERTNPC(0xd29c, "HARBOUR_QA302_SPOT_05");
}

func void QA302_BANDITS_CUTSCENEENABLE_APPLY() {
    QA302_BANDITS_CUTSCENEENABLE_COUNT = (QA302_BANDITS_CUTSCENEENABLE_COUNT) + (1);
    if ((QA302_BANDITS_CUTSCENEENABLE_COUNT) == (4)) {
        CUTSCENE_START(0x16a6e);
    };
}

var int QA302_BANDITS_CUTSCENEENABLE_APPLY.QA302_BANDITS_CUTSCENEENABLE_COUNT = 0;
func void QA302_BANDITS_END_APPLY() {
    QA302_BANDITS_END_COUNT = (QA302_BANDITS_END_COUNT) + (1);
    if ((QA302_BANDITS_END_COUNT) == (4)) {
        QA302_BANDITS_CUTSCENEENABLE = 3;
        NONE_13499_QA302_BANDIT.AIVAR[92] = FALSE;
        NONE_13496_QA302_BANDIT.AIVAR[92] = FALSE;
        WLD_SENDUNTRIGGER("QA302_BANDIT_01");
        WLD_SENDUNTRIGGER("QA302_BANDIT_02");
        WLD_SENDUNTRIGGER("QA302_BANDIT_03");
        B_STARTOTHERROUTINE(NONE_13499_QA302_BANDIT, "QA302_FIGHT");
        NPC_REFRESH(NONE_13499_QA302_BANDIT);
        B_STARTOTHERROUTINE(SLD_1009_CARAMON, "QA302_HARBOUR");
        QA302_CARAMON_RTNCHECK = 6;
        NPC_REFRESH(SLD_1009_CARAMON);
        HERO.AIVAR[4] = FALSE;
    };
}

var int QA302_BANDITS_END_APPLY.QA302_BANDITS_END_COUNT = 0;
func void QA302_FIGHTWITHBANDITS() {
    QA302_FINALFIGHT = 1;
    NONE_13496_QA302_BANDIT.AIVAR[52] = TRUE;
    NONE_13496_QA302_BANDIT.GUILD = GIL_BDT;
    NPC_SETTRUEGUILD(NONE_13496_QA302_BANDIT, GIL_BDT);
    B_IMMEDIATEATTACKPLAYER(NONE_13496_QA302_BANDIT, AR_KILL);
    NONE_13497_QA302_BANDIT.AIVAR[52] = TRUE;
    NONE_13497_QA302_BANDIT.GUILD = GIL_BDT;
    NPC_SETTRUEGUILD(NONE_13497_QA302_BANDIT, GIL_BDT);
    B_IMMEDIATEATTACKPLAYER(NONE_13497_QA302_BANDIT, AR_KILL);
    NONE_13498_QA302_BANDIT.AIVAR[52] = TRUE;
    NONE_13498_QA302_BANDIT.GUILD = GIL_BDT;
    NPC_SETTRUEGUILD(NONE_13498_QA302_BANDIT, GIL_BDT);
    B_IMMEDIATEATTACKPLAYER(NONE_13498_QA302_BANDIT, AR_KILL);
    NONE_13499_QA302_BANDIT.AIVAR[52] = TRUE;
    NONE_13499_QA302_BANDIT.GUILD = GIL_BDT;
    NPC_SETTRUEGUILD(NONE_13499_QA302_BANDIT, GIL_BDT);
    B_IMMEDIATEATTACKPLAYER(NONE_13499_QA302_BANDIT, AR_KILL);
    NONE_13500_QA302_BANDIT.AIVAR[52] = TRUE;
    NONE_13500_QA302_BANDIT.GUILD = GIL_BDT;
    NPC_SETTRUEGUILD(NONE_13500_QA302_BANDIT, GIL_BDT);
    B_IMMEDIATEATTACKPLAYER(NONE_13500_QA302_BANDIT, AR_KILL);
    NPC_SETTRUEGUILD(SLD_1009_CARAMON, SLD_1009_CARAMON.GUILD);
}

