func void EVENTSMANAGER_Q304() {
    if ((LOG_GETSTATUS(MIS_Q304)) != (LOG_RUNNING)) {
        return;
    };
    if (((Q304_POCKETGIVEN) == (1)) && ((Q304_CAVEFIGHTAFTERPAYING) == (FALSE))) {
        if (((NPC_GETDISTTONPC(HERO, NONE_6336_BODYGUARD)) >= (0x1068)) && ((NPC_GETDISTTONPC(HERO, NONE_6340_SMUGGLER)) >= (0x1068))) {
            AI_OUTPUT(HERO, HERO, "DIA_Marvin_Q304_15_01");
            B_LOGENTRY(TOPIC_Q304, LOG_Q304_POCKETGIVEN);
            Q304_POCKETGIVEN = 2;
        };
    };
    if (((Q304_POCKETGIVEN) == (2)) && ((Q304_CAVEFIGHTAFTERPAYING) == (FALSE))) {
        if ((NPC_GETDISTTOWP(HERO, "PART17_BLOODCURRENCY_HERO_01")) <= (1000)) {
            Q304_CUTSCENEPOSITION = 1;
            Q304_POCKETGIVEN = 3;
            AI_FUNCTION(HERO, 0x16f6d);
        } else if ((NPC_GETDISTTOWP(HERO, "PART17_BLOODCURRENCY_HERO_02")) <= (1000)) {
            Q304_CUTSCENEPOSITION = 2;
            Q304_POCKETGIVEN = 3;
            AI_FUNCTION(HERO, 0x16f6d);
        } else if ((NPC_GETDISTTOWP(HERO, "PART17_BLOODCURRENCY_HERO_03")) <= (1000)) {
            Q304_CUTSCENEPOSITION = 3;
            Q304_POCKETGIVEN = 3;
            AI_FUNCTION(HERO, 0x16f6d);
        } else if ((NPC_GETDISTTOWP(HERO, "PART17_BLOODCURRENCY_HERO_04")) <= (1000)) {
            Q304_CUTSCENEPOSITION = 4;
            Q304_POCKETGIVEN = 3;
            AI_FUNCTION(HERO, 0x16f6d);
        };
    };
    if ((Q304_ANTONIORUNAWAY) == (FALSE)) {
        if (NPC_KNOWSINFO(HERO, 0x148be)) {
            if (((NPC_GETDISTTONPC(HERO, BAU_6287_GONZALO)) <= (750)) && ((NPC_ISINSTATE(BAU_6287_GONZALO, 0xf09f)) == (FALSE))) {
                PRINTD("Gonzalo ucieka!");
                B_STARTOTHERROUTINE(BAU_6287_GONZALO, "ANTONIOESCAPE");
                NPC_REFRESH(BAU_6287_GONZALO);
                Q304_ANTONIORUNAWAY = TRUE;
                AI_OUTPUT(HERO, HERO, "DIA_MARVIN_ANTONIOESCAPE_15_01");
                BAU_6287_GONZALO.NAME[0] = NPCNAME_ANTONIO;
                BAU_6287_GONZALO.AIVAR[79] = 2;
                if ((NPC_ISDEAD(WOLF_SQ109_01)) == (FALSE)) {
                    B_REMOVENPC(0xc7a1);
                };
                if ((NPC_ISDEAD(WOLF_SQ109_02)) == (FALSE)) {
                    B_REMOVENPC(0xc7a2);
                };
            };
        };
    };
    if ((Q304_ANTONIORUNAWAY) == (1)) {
        if (((NPC_GETDISTTOWP(BAU_6287_GONZALO, "PART15_PATH_11")) <= (750)) && ((NPC_ISINSTATE(BAU_6287_GONZALO, 0xf09f)) == (FALSE))) {
            PRINTD("Gonzalo zmieni³ RTN!");
            B_STARTOTHERROUTINE(BAU_6287_GONZALO, "ANTONIOSCARED");
            NPC_REFRESH(BAU_6287_GONZALO);
            Q304_ANTONIORUNAWAY = 2;
        };
    };
    if ((Q304_BRANCHESANDLEAVESLOGENTRY) == (FALSE)) {
        if (((NPC_HASITEMS(HERO, 0x9186)) >= (20)) && ((NPC_HASITEMS(HERO, 0x9187)) >= (20))) {
            Q304_BRANCHESANDLEAVESLOGENTRY = TRUE;
            AI_OUTPUT(HERO, HERO, "DIA_MARVIN_FARN_15_02");
            B_LOGENTRY(TOPIC_Q304, LOG_Q304_BRANCHESANDLEAVES);
            FF_APPLYONCEEXTGT(0x16f71, 0, -(1));
            B_STARTOTHERROUTINE(PIR_1306_RODRIGO, "SWAMPCAVEBEFORETRAP");
            B_STARTOTHERROUTINE(PIR_1308_SIMON, "SWAMPCAVEBEFORETRAP");
            TELEPORTNPCTOWP(0xe54f, "PART17_CAVE_BODYGOUARD_04");
            TELEPORTNPCTOWP(0xe535, "PART17_CAVE_LEAN_01");
            if ((SIMON_Q304_NEEDMOREPPL) >= (1)) {
                if (!(NPC_ISDEAD(PIR_1311_THIAGO))) {
                    B_STARTOTHERROUTINE(PIR_1311_THIAGO, "SWAMPCAVEBEFORETRAP");
                    TELEPORTNPCTOWP(0xe577, "PART17_CAVE_SMALLTALK_01");
                };
                if ((SIMON_Q304_NEEDMOREPPL) == (2)) {
                    if (!(NPC_ISDEAD(PIR_6322_GHOST))) {
                        B_STARTOTHERROUTINE(PIR_6322_GHOST, "SWAMPCAVEBEFORETRAP");
                        TELEPORTNPCTOWP(0xe481, "PART17_CAVE_SMALLTALK_02");
                    };
                };
            };
        };
    };
    if ((Q304_FINALCUTSCENE) == (1)) {
        if ((NPC_GETDISTTOWP(HERO, "PART17_PATH_226")) <= (500)) {
            Q304_FINALCUTSCENE = 2;
            AI_FUNCTION(HERO, 0x16f75);
        };
    };
    if ((Q304_FINALCUTSCENE) == (2)) {
        if (((NPC_ISDEAD(NONE_6337_BODYGUARD)) && (NPC_ISDEAD(NONE_6338_BODYGUARD))) && (NPC_ISDEAD(NONE_6341_BODYGUARD))) {
            AI_FUNCTION(HERO, 0x16924);
            Q304_FINALCUTSCENE = 3;
        };
    };
    if (((Q304_FINALCUTSCENE) >= (4)) && ((Q304_FINALCUTSCENE) < (10))) {
        if ((NPC_ISINSTATE(NONE_6340_SMUGGLER, 0xf09f)) == (FALSE)) {
            if (((Q304_FINALCUTSCENE) == (4)) && ((NPC_GETDISTTOWP(NONE_6340_SMUGGLER, "PART15_PATH_266")) <= (500))) {
                B_STARTOTHERROUTINE(NONE_6340_SMUGGLER, "ESCAPE_V2");
                NPC_REFRESH(NONE_6340_SMUGGLER);
                Q304_FINALCUTSCENE = 5;
            };
            if (((Q304_FINALCUTSCENE) == (5)) && ((NPC_GETDISTTOWP(NONE_6340_SMUGGLER, "PART15_PATH_234")) <= (500))) {
                B_STARTOTHERROUTINE(NONE_6340_SMUGGLER, "ESCAPE_V3");
                NPC_REFRESH(NONE_6340_SMUGGLER);
                Q304_FINALCUTSCENE = 6;
            };
            if (((Q304_FINALCUTSCENE) == (6)) && ((NPC_GETDISTTOWP(NONE_6340_SMUGGLER, "PART17_PATH_141")) <= (500))) {
                B_STARTOTHERROUTINE(NONE_6340_SMUGGLER, "ESCAPE_V4");
                NPC_REFRESH(NONE_6340_SMUGGLER);
                Q304_FINALCUTSCENE = 7;
            };
            if (((Q304_FINALCUTSCENE) == (7)) && ((NPC_GETDISTTOWP(NONE_6340_SMUGGLER, "PART15_PATH_225")) <= (500))) {
                B_STARTOTHERROUTINE(NONE_6340_SMUGGLER, "ESCAPE_V5");
                NPC_REFRESH(NONE_6340_SMUGGLER);
                Q304_FINALCUTSCENE = 8;
            };
            if (((Q304_FINALCUTSCENE) == (8)) && ((NPC_GETDISTTOWP(NONE_6340_SMUGGLER, "PART15_PATH_248")) <= (500))) {
                B_STARTOTHERROUTINE(NONE_6340_SMUGGLER, "ESCAPE_V6");
                NPC_REFRESH(NONE_6340_SMUGGLER);
                Q304_FINALCUTSCENE = 9;
            };
            if (((Q304_FINALCUTSCENE) == (9)) && ((NPC_GETDISTTOWP(NONE_6340_SMUGGLER, "PART17_PATH_155")) <= (500))) {
                B_STARTOTHERROUTINE(NONE_6340_SMUGGLER, "ESCAPE_V1");
                NPC_REFRESH(NONE_6340_SMUGGLER);
                Q304_FINALCUTSCENE = 4;
            };
        };
        if (NPC_ISDEAD(NONE_6340_SMUGGLER)) {
            MUSIC_DISABLEOVERRIDE();
            B_LOGENTRY(TOPIC_Q304, LOG_Q304_SMUGGLERISDEAD);
            MDL_REMOVEOVERLAYMDS(HERO, HUMANSSPRINTMDS);
            AI_STANDUP(HERO);
            Q304_FINALCUTSCENE = 10;
            HERO.AIVAR[4] = FALSE;
        };
        if ((NPC_GETDISTTONPC(HERO, NONE_6340_SMUGGLER)) >= (0x9c4)) {
            MUSIC_DISABLEOVERRIDE();
            B_STARTOTHERROUTINE(NONE_6340_SMUGGLER, TOT);
            TELEPORTNPCTOWP(0xe44c, TOT);
            B_LOGENTRY(TOPIC_Q304, LOG_Q304_SMUGGLERESCAPED);
            MDL_REMOVEOVERLAYMDS(HERO, HUMANSSPRINTMDS);
            AI_STANDUP(HERO);
            Q304_FINALCUTSCENE = 10;
            HERO.AIVAR[4] = FALSE;
        };
    };
    if ((Q304_FINALCUTSCENE) == (10)) {
        if (NPC_ISDEAD(NONE_6340_SMUGGLER)) {
            Q304_FINALCUTSCENE = 11;
            Q304_SMUGGLERISDEAD = TRUE;
        } else {
            Q304_FINALCUTSCENE = 12;
            Q304_SMUGGLERISDEAD = FALSE;
        } else {
            B_KILLNPC(0xe420);
        } else {
            B_KILLNPC(0xe430);
        } else {
            B_KILLNPC(0xe43a);
        } else {
            B_KILLNPC(0xe443);
        } else {
            B_KILLNPC(0xe460);
        };
    };
    if ((Q304_SMUGGLERESACPE) == (1)) {
        if ((NPC_GETDISTTONPC(NONE_6340_SMUGGLER, HERO)) <= (700)) {
            PRINTD("Ucieka");
            NONE_6340_SMUGGLER.AIVAR[15] = FALSE;
            NONE_6340_SMUGGLER.FLAGS = 0;
            NONE_6340_SMUGGLER.AIVAR[52] = TRUE;
            NONE_6340_SMUGGLER.ATTRIBUTE[0] = 50;
            NONE_6340_SMUGGLER.ATTRIBUTE[1] = 50;
            Q304_SMUGGLERESACPE = 2;
            B_STARTOTHERROUTINE(NONE_6340_SMUGGLER, "ESCAPE_V1");
            NPC_REFRESH(NONE_6340_SMUGGLER);
        };
    };
}

func void Q304_CUTSCENE_START() {
    PRINTD("Start Cutscenki!");
    FADESCREENTOBLACKF(1, 0x16f6e, 1000);
    HERO.AIVAR[4] = FALSE;
    WLD_INSERTNPC(0xe45c, "PART17_PATH_223");
    WLD_INSERTNPC(0xe42c, "PART17_PATH_223");
    B_STARTOTHERROUTINE(NONE_6340_SMUGGLER, TOT);
    B_STARTOTHERROUTINE(NONE_6336_BODYGUARD, TOT);
}

func void Q304_CUTSCENE_FADEESCREEN() {
    FF_APPLYONCEEXT(0x16f6f, 75, 4);
}

func void Q304_HIDECUTSCENE_APPLY() {
    Q304_HIDECUTSCENE_COUNT = (Q304_HIDECUTSCENE_COUNT) + (1);
    if ((Q304_HIDECUTSCENE_COUNT) == (4)) {
        Q304_HIDECUTSCENE_COUNT = 0;
        CUTSCENE_START(0x16927);
    };
}

var int Q304_HIDECUTSCENE_APPLY.Q304_HIDECUTSCENE_COUNT = 0;
func void Q304_TRAPPITMOVER() {
    if ((CHANGEPITTRAPCOLLISION) == (0)) {
        PRINTD("Rozpoczynam - Q304_TrapPitMover");
        MOVPTR1 = MEM_SEARCHVOBBYNAME("KM_SWAMPCAVE_TRAP_MOVER");
        MOVER1 = MEM_PTRTOINST(MOVPTR1);
        CHANGEVOBCOLLISION("KM_SWAMPCAVE_PIT_01", FALSE, FALSE, FALSE, TRUE);
        CHANGEVOBCOLLISION("KM_SWAMPCAVE_PIT_02", FALSE, FALSE, FALSE, TRUE);
        CHANGEVOBCOLLISION("KM_SWAMPCAVE_PIT_03", FALSE, FALSE, FALSE, TRUE);
        CHANGEVOBCOLLISION("KM_SWAMPCAVE_PIT_04", FALSE, FALSE, FALSE, TRUE);
        CHANGEVOBCOLLISION("KM_SWAMPCAVE_PIT_05", FALSE, FALSE, FALSE, TRUE);
        WLD_SENDTRIGGER("KM_SWAMPCAVE_TRAP_MOVER");
        CHANGEPITTRAPCOLLISION = 1;
    };
    if (((MOVER1.MOVERSTATE) != (MOVER_STATE_OPENING)) && ((MOVER1.MOVERSTATE) != (MOVER_STATE_CLOSING))) {
        PRINTD("Skoñczy³em - Q304_TrapPitMover");
        CHANGEVOBCOLLISION("KM_SWAMPCAVE_PIT_01", TRUE, TRUE, TRUE, TRUE);
        CHANGEVOBCOLLISION("KM_SWAMPCAVE_PIT_02", TRUE, TRUE, TRUE, TRUE);
        CHANGEVOBCOLLISION("KM_SWAMPCAVE_PIT_03", TRUE, TRUE, TRUE, TRUE);
        CHANGEVOBCOLLISION("KM_SWAMPCAVE_PIT_04", TRUE, TRUE, TRUE, TRUE);
        CHANGEVOBCOLLISION("KM_SWAMPCAVE_PIT_05", TRUE, TRUE, TRUE, TRUE);
        FF_REMOVE(0x16f71);
        CHANGEPITTRAPCOLLISION = 0;
    };
}

var int Q304_TRAPPITMOVER.CHANGEPITTRAPCOLLISION = 0;
instance Q304_TRAPPITMOVER.MOVER1(ZCMOVER)
var int Q304_TRAPPITMOVER.MOVPTR1 = 0;
func void Q304_CUTSCENEFINAL_START() {
    FADESCREENTOBLACKF(2, 0x16f76, 1000);
}

func void Q304_CUTSCENEFINAL_START_FADESCREEN() {
    PRINTD("Start Cutscenki!");
    B_STARTOTHERROUTINE(PIR_1306_RODRIGO, "SWAMPCAVEHIDE");
    B_STARTOTHERROUTINE(PIR_1308_SIMON, "SWAMPCAVEHIDE");
    if (!(NPC_ISDEAD(NONE_6336_BODYGUARD))) {
        B_STARTOTHERROUTINE(NONE_6336_BODYGUARD, "FINALCUTSCENE");
    };
    B_STARTOTHERROUTINE(NONE_6337_BODYGUARD, "FINALCUTSCENE");
    B_STARTOTHERROUTINE(NONE_6338_BODYGUARD, "FINALCUTSCENE");
    B_STARTOTHERROUTINE(NONE_6339_BODYGUARD, "FINALCUTSCENE");
    B_STARTOTHERROUTINE(NONE_6340_SMUGGLER, "FINALCUTSCENE");
    B_STARTOTHERROUTINE(NONE_6341_BODYGUARD, "FINALCUTSCENE");
    if ((SIMON_Q304_NEEDMOREPPL) >= (1)) {
        if (!(NPC_ISDEAD(PIR_1311_THIAGO))) {
            B_STARTOTHERROUTINE(PIR_1311_THIAGO, "SWAMPCAVEHIDE");
        };
        if ((SIMON_Q304_NEEDMOREPPL) == (2)) {
            if (!(NPC_ISDEAD(PIR_6322_GHOST))) {
                B_STARTOTHERROUTINE(PIR_6322_GHOST, "SWAMPCAVEHIDE");
            };
        };
    };
    if ((Q304_GONZALOSAFED) == (FALSE)) {
        B_STARTOTHERROUTINE(BAU_6287_GONZALO, "SWAMPCAVE_FINALCUTSCENE");
        NPC_REFRESH(BAU_6287_GONZALO);
        TELEPORTNPCTOWP(0xe2aa, BAU_6287_GONZALO.WP);
        CREATEINVITEMS(BAU_6287_GONZALO, 0x9182, 1);
    };
    CUTSCENE_START(0x1691b);
}

