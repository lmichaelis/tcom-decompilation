instance DIA_LUDLOF_EXIT(C_INFO) {
    NPC = 0xd537;
    NR = 999;
    CONDITION = DIA_LUDLOF_EXIT_CONDITION;
    INFORMATION = DIA_LUDLOF_EXIT_INFO;
    PERMANENT = TRUE;
    DESCRIPTION = DIALOG_ENDE;
}

func int DIA_LUDLOF_EXIT_CONDITION() {
    return TRUE;
}

func void DIA_LUDLOF_EXIT_INFO() {
    AI_STOPPROCESSINFOS(SELF);
}

instance DIA_LUDLOF_HELLO(C_INFO) {
    NPC = 0xd537;
    NR = 1;
    CONDITION = DIA_LUDLOF_HELLO_CONDITION;
    INFORMATION = DIA_LUDLOF_HELLO_INFO;
    PERMANENT = FALSE;
    IMPORTANT = TRUE;
}

func int DIA_LUDLOF_HELLO_CONDITION() {
    if ((LOG_GETSTATUS(MIS_Q311)) == (LOG_RUNNING)) {
        return TRUE;
    };
    return 0 /* !broken stack! */;
}

func void LUDLOF_ATTACKMARVIN() {
    Q311_PROPAGANDISTCOUNT = (Q311_PROPAGANDISTCOUNT) + (1);
    AI_OUTPUT(SELF, OTHER, "DIA_Ludlof_HELLO_GoAway_03_05");
    INFO_CLEARCHOICES(0x12b35);
    AI_STOPPROCESSINFOS(SELF);
    AI_FUNCTION(SELF, 0x12b38);
}

func void LUDLOF_CITIZENSATTACKMARVIN() {
    Q311_LUDLOFMANSATTACK();
}

func void DIA_LUDLOF_HELLO_INFO() {
    AI_OUTPUT(SELF, OTHER, "DIA_Ludlof_HELLO_03_01");
    if (NPC_HASGUILDARMOREQUIPPED(OTHER, GIL_MIL)) {
        AI_OUTPUT(SELF, OTHER, "DIA_Ludlof_HELLO_03_02");
    };
    if (NPC_HASGUILDARMOREQUIPPED(OTHER, GIL_SLD)) {
        AI_OUTPUT(SELF, OTHER, "DIA_Ludlof_HELLO_03_03");
    };
    AI_OUTPUT(SELF, OTHER, "DIA_Ludlof_HELLO_03_04");
    Q308_IVYINVESTIGATION_HARBOUR();
    INFO_CLEARCHOICES(0x12b35);
    INFO_ADDCHOICE(0x12b35, "Is this gathering even legal?", 0x12b3a);
    INFO_ADDCHOICE(0x12b35, "Who is the author of your brochures?", 0x12b3c);
    INFO_ADDCHOICE(0x12b35, "I came to help you.", 0x12b3f);
}

func void DIA_LUDLOF_HELLO_LEGAL() {
    AI_OUTPUT(OTHER, SELF, "DIA_Ludlof_HELLO_Legal_15_01");
    if (NPC_HASGUILDARMOREQUIPPED(OTHER, GIL_MIL)) {
        AI_OUTPUT(SELF, OTHER, "DIA_Ludlof_HELLO_Legal_03_02");
    };
    if (NPC_HASGUILDARMOREQUIPPED(OTHER, GIL_SLD)) {
        AI_OUTPUT(SELF, OTHER, "DIA_Ludlof_HELLO_Legal_03_03");
    };
    AI_OUTPUT(SELF, OTHER, "DIA_Ludlof_HELLO_Legal_03_04");
    INFO_ADDCHOICE(0x12b35, "Get out of here while I have any patience left.", 0x12b3b);
}

func void DIA_LUDLOF_HELLO_GOAWAY() {
    AI_OUTPUT(OTHER, SELF, "DIA_Ludlof_HELLO_GoAway_15_01");
    AI_OUTPUT(SELF, OTHER, "DIA_Ludlof_HELLO_GoAway_03_02");
    AI_OUTPUT(SELF, OTHER, "DIA_Ludlof_HELLO_GoAway_03_03");
    AI_OUTPUT(SELF, OTHER, "DIA_Ludlof_HELLO_GoAway_03_04");
    LUDLOF_ATTACKMARVIN();
    AI_LOGENTRY(TOPIC_Q311, LOG_Q311_LUDLOF_FIGHT_V1);
}

func void DIA_LUDLOF_HELLO_AUTHOR() {
    AI_OUTPUT(OTHER, SELF, "DIA_Ludlof_HELLO_Author_15_01");
    AI_OUTPUT(SELF, OTHER, "DIA_Ludlof_HELLO_Author_03_02");
    INFO_ADDCHOICE(0x12b35, "Tell me where you got them or I'll kick your moldy ass!", 0x12b3d);
}

func void DIA_LUDLOF_HELLO_AUTHOR_TELL() {
    AI_OUTPUT(OTHER, SELF, "DIA_Ludlof_HELLO_Tell_15_01");
    AI_OUTPUT(SELF, OTHER, "DIA_Ludlof_HELLO_Tell_03_02");
    AI_OUTPUT(SELF, OTHER, "DIA_Ludlof_HELLO_Tell_03_03");
    AI_OUTPUT(OTHER, SELF, "DIA_Ludlof_HELLO_Tell_15_04");
    AI_OUTPUT(SELF, OTHER, "DIA_Ludlof_HELLO_Tell_03_05");
    LUDLOF_ATTACKMARVIN();
    AI_LOGENTRY(TOPIC_Q311, LOG_Q311_LUDLOF_FIGHT_V2);
}

func void DIA_LUDLOF_HELPCHOICE() {
    INFO_ADDCHOICE(0x12b35, "I could help you hand out brochures.", 0x12b41);
}

func void DIA_LUDLOF_HELLO_HELP() {
    AI_OUTPUT(OTHER, SELF, "DIA_Ludlof_HELLO_Help_15_01");
    if (NPC_HASGUILDARMOREQUIPPED(OTHER, GIL_MIL)) {
        AI_OUTPUT(SELF, OTHER, "DIA_Ludlof_HELLO_Help_03_02");
    };
    if (NPC_HASGUILDARMOREQUIPPED(OTHER, GIL_SLD)) {
        AI_OUTPUT(SELF, OTHER, "DIA_Ludlof_HELLO_Help_03_03");
    };
    AI_OUTPUT(SELF, OTHER, "DIA_Ludlof_HELLO_Help_03_04");
    INFO_CLEARCHOICES(0x12b35);
    if ((NPC_HASGUILDARMOREQUIPPED(OTHER, GIL_MIL)) || (NPC_HASGUILDARMOREQUIPPED(OTHER, GIL_SLD))) {
        INFO_ADDCHOICE(0x12b35, "It's better than a useless mob.", 0x12b40);
        INFO_ADDCHOICE(0x12b35, "Let's talk.", 0x12b42);
    };
    DIA_LUDLOF_HELPCHOICE();
}

func void DIA_LUDLOF_HELLO_HELP_CROWD() {
    AI_OUTPUT(OTHER, SELF, "DIA_Ludlof_HELLO_Crowd_15_01");
    AI_OUTPUT(SELF, OTHER, "DIA_Ludlof_HELLO_Crowd_03_02");
    if (NPC_HASGUILDARMOREQUIPPED(OTHER, GIL_MIL)) {
        AI_OUTPUT(SELF, OTHER, "DIA_Ludlof_HELLO_Crowd_03_03");
    };
    AI_OUTPUT(OTHER, SELF, "DIA_Ludlof_HELLO_Crowd_15_04");
    AI_OUTPUT(SELF, OTHER, "DIA_Ludlof_HELLO_Crowd_03_05");
    INFO_CLEARCHOICES(0x12b35);
    DIA_LUDLOF_HELPCHOICE();
}

func void DIA_LUDLOF_HELLO_HELP_CROWD_HELPPOSTER() {
    AI_OUTPUT(OTHER, SELF, "DIA_Ludlof_HELLO_HelpPoster_15_01");
    AI_OUTPUT(SELF, OTHER, "DIA_Ludlof_HELLO_HelpPoster_03_02");
    AI_OUTPUT(SELF, OTHER, "DIA_Ludlof_HELLO_HelpPoster_03_03");
    INFO_CLEARCHOICES(0x12b35);
    INFO_ADDCHOICE(0x12b35, "Then it's time to get new ones.", 0x12b43);
}

func void DIA_LUDLOF_HELLO_HELP_LETSTALK() {
    AI_OUTPUT(OTHER, SELF, "DIA_Ludlof_HELLO_LetsTalk_15_01");
    AI_OUTPUT(SELF, OTHER, "DIA_Ludlof_HELLO_LetsTalk_03_02");
    AI_OUTPUT(SELF, OTHER, "DIA_Ludlof_HELLO_LetsTalk_03_03");
    AI_OUTPUT(SELF, OTHER, "DIA_Ludlof_HELLO_LetsTalk_03_04");
    if (NPC_HASGUILDARMOREQUIPPED(OTHER, GIL_MIL)) {
        AI_OUTPUT(SELF, OTHER, "DIA_Ludlof_HELLO_LetsTalk_03_05");
        AI_OUTPUT(SELF, OTHER, "DIA_Ludlof_HELLO_LetsTalk_03_06");
        AI_OUTPUT(SELF, OTHER, "DIA_Ludlof_HELLO_LetsTalk_03_07");
    };
    if (NPC_HASGUILDARMOREQUIPPED(OTHER, GIL_SLD)) {
        AI_OUTPUT(SELF, OTHER, "DIA_Ludlof_HELLO_LetsTalk_03_08");
        AI_OUTPUT(SELF, OTHER, "DIA_Ludlof_HELLO_LetsTalk_03_09");
        AI_OUTPUT(SELF, OTHER, "DIA_Ludlof_HELLO_LetsTalk_03_10");
    };
    AI_OUTPUT(OTHER, SELF, "DIA_Ludlof_HELLO_LetsTalk_15_11");
    LUDLOF_ATTACKMARVIN();
    AI_LOGENTRY(TOPIC_Q311, LOG_Q311_LUDLOF_FIGHT_V3);
}

func void DIA_LUDLOF_HELLO_HELP_CROWD_HELPPOSTER_NEW() {
    AI_OUTPUT(OTHER, SELF, "DIA_Ludlof_HELLO_New_15_01");
    AI_OUTPUT(SELF, OTHER, "DIA_Ludlof_HELLO_New_03_02");
    AI_OUTPUT(OTHER, SELF, "DIA_Ludlof_HELLO_New_15_03");
    AI_OUTPUT(SELF, OTHER, "DIA_Ludlof_HELLO_New_03_04");
    AI_OUTPUT(SELF, OTHER, "DIA_Ludlof_HELLO_New_03_05");
    INFO_CLEARCHOICES(0x12b35);
    INFO_ADDCHOICE(0x12b35, "Then, where did you get them?", 0x12b45);
}

func void DIA_LUDLOF_WHOMADE() {
    AI_OUTPUT(SELF, OTHER, "DIA_Ludlof_AfterFight_FromWhere_03_03");
}

func void DIA_LUDLOF_HELLO_HELP_CROWD_HELPPOSTER_NEW_WHO() {
    AI_OUTPUT(OTHER, SELF, "DIA_Ludlof_HELLO_Who_15_01");
    DIA_LUDLOF_WHOMADE();
    AI_OUTPUT(SELF, OTHER, "DIA_Ludlof_HELLO_Who_03_03");
    AI_OUTPUT(SELF, OTHER, "DIA_Ludlof_HELLO_Who_03_04");
    AI_OUTPUT(SELF, OTHER, "DIA_Ludlof_HELLO_Who_03_05");
    INFO_CLEARCHOICES(0x12b35);
    AI_STOPPROCESSINFOS(SELF);
    AI_LOGENTRY(TOPIC_Q311, LOG_Q311_LUDLOF_INFO_V1);
    Q311_INFOFROMLUDLOF = TRUE;
}

instance DIA_LUDLOF_AFTERFIGHT(C_INFO) {
    NPC = 0xd537;
    NR = 1;
    CONDITION = DIA_LUDLOF_AFTERFIGHT_CONDITION;
    INFORMATION = DIA_LUDLOF_AFTERFIGHT_INFO;
    PERMANENT = FALSE;
    IMPORTANT = TRUE;
}

func int DIA_LUDLOF_AFTERFIGHT_CONDITION() {
    if (((LOG_GETSTATUS(MIS_Q311)) == (LOG_RUNNING)) && (NPC_KNOWSINFO(OTHER, 0x12b35))) {
        if (((((((VLK_6084_GUY.AIVAR[0]) == (FIGHT_LOST)) && ((VLK_6083_WORKER.AIVAR[0]) == (FIGHT_LOST))) && ((VLK_6070_GUY.AIVAR[0]) == (FIGHT_LOST))) && ((VLK_6068_GUY.AIVAR[0]) == (FIGHT_LOST))) && ((VLK_6102_WORKER.AIVAR[0]) == (FIGHT_LOST))) || (((((NPC_ISINSTATE(VLK_6084_GUY, 0xf0a3)) && (NPC_ISINSTATE(VLK_6083_WORKER, 0xf0a3))) && (NPC_ISINSTATE(VLK_6070_GUY, 0xf0a3))) && (NPC_ISINSTATE(VLK_6068_GUY, 0xf0a3))) && (NPC_ISINSTATE(VLK_6102_WORKER, 0xf0a3)))) {
            return TRUE;
        };
    };
    return 0 /* !broken stack! */;
}

func void DIA_LUDLOF_AFTERFIGHT_INFO() {
    Q311_AFTERLUDLOFMANFIGHT();
    AI_OUTPUT(OTHER, SELF, "DIA_Ludlof_AfterFight_15_01");
    AI_OUTPUT(SELF, OTHER, "DIA_Ludlof_AfterFight_03_02");
    AI_OUTPUT(OTHER, SELF, "DIA_Ludlof_AfterFight_15_03");
    AI_OUTPUT(OTHER, SELF, "DIA_Ludlof_AfterFight_15_04");
    if (NPC_HASGUILDARMOREQUIPPED(OTHER, GIL_MIL)) {
        AI_OUTPUT(OTHER, SELF, "DIA_Ludlof_AfterFight_15_05");
    };
    if (NPC_HASGUILDARMOREQUIPPED(OTHER, GIL_SLD)) {
        AI_OUTPUT(OTHER, SELF, "DIA_Ludlof_AfterFight_15_06");
    };
    AI_OUTPUT(SELF, OTHER, "DIA_Ludlof_AfterFight_03_07");
    INFO_CLEARCHOICES(0x12b46);
    INFO_ADDCHOICE(0x12b46, "Where did you get the brochures?", 0x12b49);
}

func void DIA_LUDLOF_AFTERFIGHT_FROMWHERE() {
    AI_OUTPUT(OTHER, SELF, "DIA_Ludlof_AfterFight_FromWhere_15_01");
    AI_OUTPUT(SELF, OTHER, "DIA_Ludlof_AfterFight_FromWhere_03_02");
    DIA_LUDLOF_WHOMADE();
    AI_OUTPUT(SELF, OTHER, "DIA_Ludlof_AfterFight_FromWhere_03_04");
    INFO_CLEARCHOICES(0x12b46);
    INFO_ADDCHOICE(0x12b46, "Who could have made them?", 0x12b4a);
}

func void DIA_LUDLOF_AFTERFIGHT_FROMWHERE_WHO() {
    Q311_INFOFROMLUDLOF = TRUE;
    AI_OUTPUT(OTHER, SELF, "DIA_Ludlof_AfterFight_Who_15_01");
    AI_OUTPUT(SELF, OTHER, "DIA_Ludlof_AfterFight_Who_03_02");
    if (!(NPC_KNOWSINFO(OTHER, 0x12c6e))) {
        AI_OUTPUT(OTHER, SELF, "DIA_Ludlof_AfterFight_Who_15_03");
        AI_OUTPUT(SELF, OTHER, "DIA_Ludlof_AfterFight_Who_03_04");
    };
    AI_OUTPUT(OTHER, SELF, "DIA_Ludlof_AfterFight_Who_15_05");
    AI_OUTPUT(SELF, OTHER, "DIA_Ludlof_AfterFight_Who_03_06");
    INFO_CLEARCHOICES(0x12b46);
    INFO_ADDCHOICE(0x12b46, "I will, but I want you to stop inciting people.", 0x12b4b);
    INFO_ADDCHOICE(0x12b46, "I'll let you off this time.", 0x12b4c);
    INFO_ADDCHOICE(0x12b46, "You're coming with me to the dungeon.", 0x12b4d);
}

func void DIA_LUDLOF_AFTERFIGHT_FROMWHERE_WHO_STOP() {
    Q311_LUDLOFRIOT = 1;
    AI_OUTPUT(OTHER, SELF, "DIA_Ludlof_AfterFight_Stop_15_01");
    AI_OUTPUT(SELF, OTHER, "DIA_Ludlof_AfterFight_Stop_03_02");
    AI_OUTPUT(SELF, OTHER, "DIA_Ludlof_AfterFight_Stop_03_03");
    AI_LOGENTRY(TOPIC_Q311, LOG_Q311_LUDLOF_INFO_V3);
    INFO_CLEARCHOICES(0x12b46);
    AI_STOPPROCESSINFOS(SELF);
    NPC_EXCHANGEROUTINE(SELF, FLEE);
}

func void DIA_LUDLOF_AFTERFIGHT_FROMWHERE_WHO_LETGO() {
    Q311_LUDLOFRIOT = 1;
    AI_OUTPUT(OTHER, SELF, "DIA_Ludlof_AfterFight_LetGo_15_01");
    AI_OUTPUT(SELF, OTHER, "DIA_Ludlof_AfterFight_LetGo_03_02");
    AI_LOGENTRY(TOPIC_Q311, LOG_Q311_LUDLOF_INFO_V2);
    INFO_CLEARCHOICES(0x12b46);
    AI_STOPPROCESSINFOS(SELF);
    NPC_EXCHANGEROUTINE(SELF, FLEE);
}

func void DIA_LUDLOF_AFTERFIGHT_FROMWHERE_WHO_JAIL() {
    Q311_LUDLOFRIOT = 2;
    AI_OUTPUT(OTHER, SELF, "DIA_Ludlof_AfterFight_Jail_15_01");
    if (NPC_HASGUILDARMOREQUIPPED(OTHER, GIL_MIL)) {
        AI_OUTPUT(OTHER, SELF, "DIA_Ludlof_AfterFight_Jail_15_02");
    };
    if (NPC_HASGUILDARMOREQUIPPED(OTHER, GIL_SLD)) {
        AI_OUTPUT(OTHER, SELF, "DIA_Ludlof_AfterFight_Jail_15_03");
        AI_OUTPUT(OTHER, SELF, "DIA_Ludlof_AfterFight_Jail_15_04");
    };
    AI_OUTPUT(SELF, OTHER, "DIA_Ludlof_AfterFight_Jail_03_05");
    AI_OUTPUT(OTHER, SELF, "DIA_Ludlof_AfterFight_Jail_15_06");
    AI_OUTPUT(SELF, OTHER, "DIA_Ludlof_AfterFight_Jail_03_07");
    if (NPC_HASGUILDARMOREQUIPPED(OTHER, GIL_MIL)) {
        AI_LOGENTRY(TOPIC_Q311, LOG_Q311_LUDLOF_INFO_V4);
    };
    if (NPC_HASGUILDARMOREQUIPPED(OTHER, GIL_SLD)) {
        AI_LOGENTRY(TOPIC_Q311, LOG_Q311_LUDLOF_INFO_V5);
    };
    AI_FUNCTION(SELF, 0x12b4e);
    INFO_CLEARCHOICES(0x12b46);
    AI_STOPPROCESSINFOS(SELF);
}

func void LUDLOF_JAILTIME() {
    FADESCREENTOBLACKF(1, 0x12b4f, 1000);
}

func void LUDLOF_JAILTIME_FADESCREEN() {
    TELEPORTNPCTOWP(0x71b, "PARTM3_PRISON_01");
    TELEPORTNPCTOWP(0xd537, "PARTM3_CELL1_01");
    B_STARTOTHERROUTINE(VLK_6424_LUDLOF, "PRISON");
    B_PASSTIME(1);
    HERO.AIVAR[4] = FALSE;
    FADESCREENFROMBLACK(1);
}

