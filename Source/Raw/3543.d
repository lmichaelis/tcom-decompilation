func void QM303_PREPARENPC() {
    FF_APPLYONCEEXTGT(0xf81e, 0, -(1));
    WLD_INSERTNPC(0xdb8f, "PART6_QM303_MILITIA");
    WLD_INSERTNPC(0xc664, "PART4_MOB_78");
    WLD_INSERTITEM(0x916d, "FP_PARTM4_QM303_PACKET_01");
    WLD_INSERTITEM(0x916d, "FP_PARTM4_QM303_PACKET_02");
    WLD_INSERTITEM(0x916d, "FP_PARTM4_QM303_PACKET_03");
    WLD_INSERTITEM(0x916d, "FP_PARTM4_QM303_PACKET_05");
    WLD_INSERTNPC(0xc647, "PART4_PATHFOREST_06");
    WLD_INSERTNPC(0xc647, "PART4_MOB_62");
    WLD_INSERTNPC(0xc647, "PART4_MOB_74");
    WLD_INSERTNPC(0xc647, "PART4_PATHFOREST_61");
    WLD_INSERTNPC(0xc647, "FP_ROAM_PART4_65");
    WLD_INSERTNPC(0xc647, "FP_ROAM_PART4_83");
}

func void QM303_PREPARENPC_APPLY() {
    if ((QM303_PREPARENPC_COUNT) == (0)) {
        PRINTD("Rozpoczynam - QM303_PrepareNPC_Apply");
        MOVPTR1 = MEM_SEARCHVOBBYNAME("QM303_MOVER_MILITIA_CORPSE");
        MOVER1 = MEM_PTRTOINST(MOVPTR1);
        MOVPTR2 = MEM_SEARCHVOBBYNAME("QM303_MOVER_CORPSESANIMAL");
        MOVER2 = MEM_PTRTOINST(MOVPTR2);
        CHANGEVOBCOLLISION("QM303_MILITIA_CORPSE", FALSE, FALSE, FALSE, TRUE);
        CHANGEVOBCOLLISION("QM303_ANIMAL_CORPSE_01", FALSE, FALSE, FALSE, TRUE);
        CHANGEVOBCOLLISION("QM303_ANIMAL_CORPSE_02", FALSE, FALSE, FALSE, TRUE);
        WLD_SENDTRIGGER("QM303_MOVER_MILITIA_CORPSE");
        WLD_SENDTRIGGER("QM303_MOVER_CORPSESANIMAL");
        QM303_PREPARENPC_COUNT = 1;
    };
    if (((((MOVER1.MOVERSTATE) != (MOVER_STATE_OPENING)) && ((MOVER1.MOVERSTATE) != (MOVER_STATE_CLOSING))) && ((MOVER2.MOVERSTATE) != (MOVER_STATE_OPENING))) && ((MOVER2.MOVERSTATE) != (MOVER_STATE_CLOSING))) {
        PRINTD("Skoñczy³em - QM303_PrepareNPC_Apply");
        CHANGEVOBCOLLISION("QM303_MILITIA_CORPSE", TRUE, TRUE, TRUE, TRUE);
        CHANGEVOBCOLLISION("QM303_ANIMAL_CORPSE_01", TRUE, TRUE, TRUE, TRUE);
        CHANGEVOBCOLLISION("QM303_ANIMAL_CORPSE_02", TRUE, TRUE, TRUE, TRUE);
        FF_REMOVE(0xf81e);
        QM303_PREPARENPC_COUNT = 0;
    };
}

var int QM303_PREPARENPC_APPLY.QM303_PREPARENPC_COUNT = 0;
instance QM303_PREPARENPC_APPLY.MOVER1(ZCMOVER)
instance QM303_PREPARENPC_APPLY.MOVER2(ZCMOVER)
var int QM303_PREPARENPC_APPLY.MOVPTR1 = 0;
var int QM303_PREPARENPC_APPLY.MOVPTR2 = 0;
func void QM303_FINISHQUEST() {
    QM303_FINISH = TRUE;
    QM303_FINISH_DAY = WLD_GETDAY();
    MARVINCURRENT_ITMIS_QM303_PACKET = NPC_HASITEMS(OTHER, 0x916d);
    CREATEINVITEMS(SELF, 0x859b, (QM303_FINISHGOLD) * (MARVINCURRENT_ITMIS_QM303_PACKET));
    NPC_REMOVEINVITEMS(SELF, 0x916d, MARVINCURRENT_ITMIS_QM303_PACKET);
    LOG_SETSTATUS(_@(MIS_QM303), TOPIC_QM303, LOG_SUCCESS);
    if (NPC_ISDEAD(SHADOWBEAST_QM303)) {
        B_GIVEPLAYERXP(XP_QM303_FINISH_V2);
    };
    B_GIVEINVITEMS(OTHER, SELF, 0x916d, MARVINCURRENT_ITMIS_QM303_PACKET);
    B_GIVEPLAYERXP(XP_QM303_FINISH_V1);
    if ((QM303_GIVEMILITIAPOTION) == (TRUE)) {
        QM303_GIVEMILITIAPOTION_CHECKTIME = TRUE;
        QM303_GIVEMILITIAPOTION_CHECKTIME_DAY = WLD_GETDAY();
    };
    B_GIVEINVITEMS(SELF, OTHER, 0x859b, (QM303_FINISHGOLD) * (MARVINCURRENT_ITMIS_QM303_PACKET));
}

var int QM303_FINISHQUEST.MARVINCURRENT_ITMIS_QM303_PACKET = 0;
func void QM303_REMOVENPC() {
    if ((QM303_GIVEMILITIAPOTION) == (FALSE)) {
        B_REMOVENPC(0xdb8f);
    };
    B_STARTOTHERROUTINE(MIL_13589_MILITIA, TOT);
    NPC_REFRESH(MIL_13589_MILITIA);
    TELEPORTNPCTOWP(0xdb8f, MIL_13589_MILITIA.WP);
    FF_APPLYONCEEXTGT(0xf81e, 0, -(1));
}

func void MILITIA_QM303_BACK_TELEPORT() {
    FADESCREENTOBLACKF(1, 0xf828, 1000);
}

func void MILITIA_QM303_BACK_TELEPORT_FADESCREEN() {
    HERO.AIVAR[4] = FALSE;
    TELEPORTNPCTOWP(0x71b, "PARTM3_PATH_04");
    AI_TURNTONPC(HERO, NONE_2009_LENNART);
    FADESCREENFROMBLACK(1);
    B_STARTOTHERROUTINE(MIL_13589_MILITIA, "QM303_CITYWOUNDED");
    NPC_REFRESH(MIL_13589_MILITIA);
    TELEPORTNPCTOWP(0xdb8f, MIL_13589_MILITIA.WP);
}

