instance DIA_JON_Q404_EXIT(C_INFO) {
    NPC = 0xe6cd;
    NR = 999;
    CONDITION = DIA_JON_Q404_EXIT_CONDITION;
    INFORMATION = DIA_JON_Q404_EXIT_INFO;
    PERMANENT = TRUE;
    DESCRIPTION = DIALOG_ENDE;
}

func int DIA_JON_Q404_EXIT_CONDITION() {
    return TRUE;
}

func void DIA_JON_Q404_EXIT_INFO() {
    AI_STOPPROCESSINFOS(SELF);
}

instance DIA_JON_Q404_HELLO(C_INFO) {
    NPC = 0xe6cd;
    NR = 1;
    CONDITION = DIA_JON_Q404_HELLO_CONDITION;
    INFORMATION = DIA_JON_Q404_HELLO_INFO;
    PERMANENT = FALSE;
    IMPORTANT = TRUE;
}

func void DIA_JON_Q404_HELLO_END() {
    INFO_CLEARCHOICES(0x15252);
    AI_STOPPROCESSINFOS(SELF);
    SELF.AIVAR[15] = TRUE;
    NPC_EXCHANGEROUTINE(SELF, "QUEEN");
    AI_FUNCTION(SELF, 0x15254);
}

func void JON_BRINGWOLFSONS() {
    if (HLP_ISVALIDNPC(DJG_10021_WOLFSON)) {
        if (!(NPC_ISDEAD(DJG_10021_WOLFSON))) {
            B_STARTOTHERROUTINE(DJG_10021_WOLFSON, "QUEEN");
            NPC_REFRESH(DJG_10021_WOLFSON);
            DJG_10021_WOLFSON.AIVAR[15] = TRUE;
        };
    };
    if (HLP_ISVALIDNPC(DJG_10022_WOLFSON)) {
        if (!(NPC_ISDEAD(DJG_10022_WOLFSON))) {
            B_STARTOTHERROUTINE(DJG_10022_WOLFSON, "QUEEN");
            NPC_REFRESH(DJG_10022_WOLFSON);
            DJG_10022_WOLFSON.AIVAR[15] = TRUE;
        };
    };
    if (HLP_ISVALIDNPC(DJG_10023_WOLFSON)) {
        if (!(NPC_ISDEAD(DJG_10023_WOLFSON))) {
            B_STARTOTHERROUTINE(DJG_10023_WOLFSON, "QUEEN");
            NPC_REFRESH(DJG_10023_WOLFSON);
            DJG_10023_WOLFSON.AIVAR[15] = TRUE;
        };
    };
}

func int DIA_JON_Q404_HELLO_CONDITION() {
    return TRUE;
}

var int JON_HELLO_NOWAY = 0;
var int JON_HELLO_CITY = 0;
var int JON_HELLO_SECRET = 0;
func void DIA_JON_Q404_HELLO_CHOICES() {
    INFO_CLEARCHOICES(0x15252);
    if ((JON_HELLO_NOWAY) == (FALSE)) {
        INFO_ADDCHOICE(0x15252, "We can't do it.", 0x1525b);
    };
    if ((JON_HELLO_CITY) == (FALSE)) {
        INFO_ADDCHOICE(0x15252, "Yes, it is. It's about certain events in the city.", 0x1525c);
    };
    if ((JON_HELLO_SECRET) == (FALSE)) {
        INFO_ADDCHOICE(0x15252, "Otherwise I wouldn't have mentioned it.", 0x1525d);
    };
    if (((JON_HELLO_CITY) == (TRUE)) || ((JON_HELLO_SECRET) == (TRUE))) {
        INFO_ADDCHOICE(0x15252, "Either you come with me, or I'll drag you.", 0x15261);
    };
    INFO_ADDCHOICE(0x15252, "Let's just get it over with.", 0x15262);
}

func void DIA_JON_Q404_HELLO_INFO() {
    AI_OUTPUT(SELF, OTHER, "DIA_Jon_Q404_HELLO_03_01");
    AI_OUTPUT(OTHER, SELF, "DIA_Jon_Q404_HELLO_15_02");
    if ((Q404_MINEBADROUTE_DEADPEOPLE) < (2)) {
        AI_OUTPUT(SELF, OTHER, "DIA_Jon_Q404_HELLO_03_03");
        AI_OUTPUT(OTHER, SELF, "DIA_Jon_Q404_HELLO_15_04");
        AI_OUTPUT(SELF, OTHER, "DIA_Jon_Q404_HELLO_03_05");
        AI_LOGENTRY(TOPIC_Q404, LOG_Q404_JON_LETSGO_NOCHOICE);
        DIA_JON_Q404_HELLO_END();
    };
    if ((Q404_MINEBADROUTE_DEADPEOPLE) == (2)) {
        AI_OUTPUT(SELF, OTHER, "DIA_Jon_Q404_HELLO_03_06");
        AI_OUTPUT(OTHER, SELF, "DIA_Jon_Q404_HELLO_15_07");
        AI_OUTPUT(SELF, OTHER, "DIA_Jon_Q404_HELLO_03_08");
        DIA_JON_Q404_HELLO_CHOICES();
    };
    if ((Q404_MINEBADROUTE_DEADPEOPLE) == (3)) {
        AI_OUTPUT(SELF, OTHER, "DIA_Jon_Q404_HELLO_03_09");
        AI_OUTPUT(OTHER, SELF, "DIA_Jon_Q404_HELLO_15_10");
        AI_OUTPUT(SELF, OTHER, "DIA_Jon_Q404_HELLO_03_11");
        AI_OUTPUT(OTHER, SELF, "DIA_Jon_Q404_HELLO_15_12");
        AI_OUTPUT(SELF, OTHER, "DIA_Jon_Q404_HELLO_03_13");
        INFO_CLEARCHOICES(0x15252);
        INFO_ADDCHOICE(0x15252, "Either you come with me, or I'll drag you.", 0x15261);
        INFO_ADDCHOICE(0x15252, "Let's just get it over with.", 0x15262);
    };
}

func void DIA_JON_Q404_HELLO_NOWAY() {
    JON_HELLO_NOWAY = TRUE;
    AI_OUTPUT(OTHER, SELF, "DIA_Jon_Q404_HELLO_NoWay_15_01");
    AI_OUTPUT(SELF, OTHER, "DIA_Jon_Q404_HELLO_NoWay_03_02");
    AI_OUTPUT(OTHER, SELF, "DIA_Jon_Q404_HELLO_NoWay_15_03");
    AI_OUTPUT(SELF, OTHER, "DIA_Jon_Q404_HELLO_NoWay_03_04");
    DIA_JON_Q404_HELLO_CHOICES();
}

func void DIA_JON_Q404_HELLO_NOWAY_CITY() {
    JON_HELLO_CITY = TRUE;
    AI_OUTPUT(OTHER, SELF, "DIA_Jon_Q404_HELLO_City_15_01");
    AI_OUTPUT(SELF, OTHER, "DIA_Jon_Q404_HELLO_City_03_02");
    AI_OUTPUT(OTHER, SELF, "DIA_Jon_Q404_HELLO_City_15_03");
    AI_OUTPUT(SELF, OTHER, "DIA_Jon_Q404_HELLO_City_03_04");
    DIA_JON_Q404_HELLO_CHOICES();
}

func void DIA_JON_Q404_HELLO_NOWAY_SECRET() {
    JON_HELLO_SECRET = TRUE;
    AI_OUTPUT(OTHER, SELF, "DIA_Jon_Q404_HELLO_Secret_15_01");
    AI_OUTPUT(SELF, OTHER, "DIA_Jon_Q404_HELLO_Secret_03_02");
    DIA_JON_Q404_HELLO_CHOICES();
}

func void JON_ATTACKMARVIN() {
    SND_PLAY("CS_IAI_ME_WO_A1");
    SND_PLAY("Whoosh");
    SND_PLAY("CS_IAM_ME_FL");
    HERO.ATTRIBUTE[0] = 50;
}

func void JON_APPLYKNEELMDS() {
    MDL_APPLYOVERLAYMDS(DJG_10020_JON, "HumanS_JonKneel.MDS");
}

func void JON_REMOVEKNEELMDS() {
    MDL_REMOVEOVERLAYMDS(DJG_10020_JON, "HumanS_JonKneel.MDS");
}

func void DIA_JON_Q404_HELLO_NOWAY_COMEON() {
    AI_LOOKATNPC(SELF, OTHER);
    AI_OUTPUT(OTHER, SELF, "DIA_Jon_Q404_HELLO_ComeOn_15_01");
    AI_OUTPUT(SELF, OTHER, "DIA_Jon_Q404_HELLO_ComeOn_03_02");
    AI_OUTPUT(OTHER, SELF, "DIA_Jon_Q404_HELLO_ComeOn_15_03");
    AI_OUTPUT(SELF, OTHER, "DIA_Jon_Q404_HELLO_ComeOn_03_04");
    AI_OUTPUT(OTHER, SELF, "DIA_Jon_Q404_HELLO_ComeOn_15_05");
    AI_GOTONPC(SELF, OTHER);
    AI_DRAWWEAPON(SELF);
    AI_WAITTILLEND(SELF, OTHER);
    AI_WAITTILLEND(OTHER, SELF);
    AI_FUNCTION(SELF, 0x1525e);
    AI_PLAYANI(SELF, "T_2HATTACKL");
    AI_WAIT(OTHER, 0x3e4ccccd);
    AI_PLAYANI(OTHER, "T_WOUNDEDB_START");
    AI_WAITTILLEND(SELF, OTHER);
    AI_WAITTILLEND(OTHER, SELF);
    AI_PLAYANI(SELF, "T_JON_KNEEL");
    AI_FUNCTION(SELF, 0x1525f);
    AI_OUTPUT(SELF, OTHER, "DIA_Jon_Q404_HELLO_ComeOn_03_06");
    AI_PLAYANI(SELF, "T_JON_STANDUP");
    AI_FUNCTION(SELF, 0x15260);
    AI_WAITTILLEND(SELF, OTHER);
    AI_WAITTILLEND(OTHER, SELF);
    AI_PLAYANI(HERO, "T_WOUNDEDB_REMOVE");
    AI_TURNTONPC(OTHER, SELF);
    AI_OUTPUT(OTHER, SELF, "DIA_Jon_Q404_HELLO_ComeOn_15_07");
    AI_STOPLOOKAT(SELF);
    AI_LOGENTRY(TOPIC_Q404, LOG_Q404_JON_LETSGO_BAD);
    DIA_JON_Q404_HELLO_END();
}

func void DIA_JON_Q404_HELLO_LETSGO() {
    AI_OUTPUT(OTHER, SELF, "DIA_Jon_Q404_HELLO_LetsGo_15_01");
    AI_OUTPUT(SELF, OTHER, "DIA_Jon_Q404_HELLO_LetsGo_03_02");
    AI_OUTPUT(OTHER, SELF, "DIA_Jon_Q404_HELLO_LetsGo_15_03");
    AI_OUTPUT(SELF, OTHER, "DIA_Jon_Q404_HELLO_LetsGo_03_04");
    AI_LOGENTRY(TOPIC_Q404, LOG_Q404_JON_LETSGO_GOOD);
    DIA_JON_Q404_HELLO_END();
}

instance DIA_JON_Q404_QUEENISDEAD(C_INFO) {
    NPC = 0xe6cd;
    NR = 1;
    CONDITION = DIA_JON_Q404_QUEENISDEAD_CONDITION;
    INFORMATION = DIA_JON_Q404_QUEENISDEAD_INFO;
    PERMANENT = FALSE;
    IMPORTANT = TRUE;
}

func int DIA_JON_Q404_QUEENISDEAD_CONDITION() {
    if ((LOG_GETSTATUS(MIS_Q404)) == (LOG_RUNNING)) {
        if ((((NPC_ISDEAD(MINECRAWLERQUEEN)) && (NPC_ISDEAD(MINECRAWLERWARRIOR_Q404_01))) && (NPC_ISDEAD(MINECRAWLERWARRIOR_Q404_02))) && (NPC_ISDEAD(MINECRAWLERWARRIOR_Q404_03))) {
            return TRUE;
        };
    };
    return 0 /* !broken stack! */;
}

func void DIA_JON_Q404_QUEENISDEAD_INFO() {
    DJG_10020_JON.AIVAR[15] = FALSE;
    if ((DJG_10020_JON.ATTRIBUTE[0]) != (DJG_10020_JON.ATTRIBUTE[1])) {
        DJG_10020_JON.ATTRIBUTE[0] = (DJG_10020_JON.ATTRIBUTE[1]) / (2);
    };
    AI_OUTPUT(SELF, OTHER, "DIA_Jon_Q404_QueenIsDead_03_01");
    AI_OUTPUT(SELF, OTHER, "DIA_Jon_Q404_QueenIsDead_03_02");
    AI_OUTPUT(OTHER, SELF, "DIA_Jon_Q404_QueenIsDead_15_03");
    AI_OUTPUT(SELF, OTHER, "DIA_Jon_Q404_QueenIsDead_03_04");
    AI_OUTPUT(OTHER, SELF, "DIA_Jon_Q404_QueenIsDead_15_05");
    AI_LOGENTRY(TOPIC_Q404, LOG_Q404_JON_QUEENISDEAD);
    B_STANDUP();
    INFO_CLEARCHOICES(0x15263);
    INFO_ADDCHOICE(0x15263, "What do you know about the assassination attempt in the city?", 0x15268);
    INFO_ADDCHOICE(0x15263, "How did you survive a few days in those tunnels?", 0x15267);
    INFO_ADDCHOICE(0x15263, "Do you know how to use a crossbow?", 0x15266);
}

func void DIA_JON_Q404_QUEENISDEAD_CROSSBOW() {
    AI_OUTPUT(OTHER, SELF, "DIA_Jon_Q404_QueenIsDead_Crossbow_15_01");
    AI_OUTPUT(SELF, OTHER, "DIA_Jon_Q404_QueenIsDead_Crossbow_03_02");
    AI_OUTPUT(SELF, OTHER, "DIA_Jon_Q404_QueenIsDead_Crossbow_03_03");
    AI_OUTPUT(OTHER, SELF, "DIA_Jon_Q404_QueenIsDead_Crossbow_15_04");
    AI_OUTPUT(SELF, OTHER, "DIA_Jon_Q404_QueenIsDead_Crossbow_03_05");
    if ((NPC_HASITEMS(OTHER, 0x9b28)) >= (1)) {
        INFO_ADDCHOICE(0x15263, "This is the one you lost in the tunnel?", 0x15269);
    };
}

func void DIA_JON_Q404_QUEENISDEAD_HOW() {
    AI_OUTPUT(OTHER, SELF, "DIA_Jon_Q404_QueenIsDead_How_15_01");
    AI_OUTPUT(SELF, OTHER, "DIA_Jon_Q404_QueenIsDead_How_03_02");
    AI_OUTPUT(SELF, OTHER, "DIA_Jon_Q404_QueenIsDead_How_03_03");
    AI_OUTPUT(OTHER, SELF, "DIA_Jon_Q404_QueenIsDead_How_15_04");
    AI_OUTPUT(SELF, OTHER, "DIA_Jon_Q404_QueenIsDead_How_03_05");
}

func void DIA_JON_Q404_QUEENISDEAD_CITY() {
    Q404_FIGHTWITHJON = 1;
    AI_OUTPUT(OTHER, SELF, "DIA_Jon_Q404_QueenIsDead_City_15_01");
    AI_OUTPUT(SELF, OTHER, "DIA_Jon_Q404_QueenIsDead_City_03_02");
    AI_OUTPUT(OTHER, SELF, "DIA_Jon_Q404_QueenIsDead_City_15_03");
    AI_OUTPUT(OTHER, SELF, "DIA_Jon_Q404_QueenIsDead_City_15_04");
    AI_OUTPUT(SELF, OTHER, "DIA_Jon_Q404_QueenIsDead_City_03_05");
    AI_OUTPUT(OTHER, SELF, "DIA_Jon_Q404_QueenIsDead_City_15_06");
    AI_OUTPUT(SELF, OTHER, "DIA_Jon_Q404_QueenIsDead_City_03_07");
    AI_OUTPUT(OTHER, SELF, "DIA_Jon_Q404_QueenIsDead_City_15_08");
    AI_OUTPUT(SELF, OTHER, "DIA_Jon_Q404_QueenIsDead_City_03_09");
    AI_OUTPUT(OTHER, SELF, "DIA_Jon_Q404_QueenIsDead_City_15_10");
    AI_OUTPUT(SELF, OTHER, "DIA_Jon_Q404_QueenIsDead_City_03_11");
    INFO_CLEARCHOICES(0x15263);
    AI_STOPPROCESSINFOS(SELF);
    B_ATTACK(SELF, OTHER, AR_KILL, 1);
    SELF.AIVAR[96] = 10;
}

func void DIA_JON_Q404_QUEENISDEAD_CROSSBOW_FOUNDIT() {
    AI_OUTPUT(OTHER, SELF, "DIA_Jon_Q404_QueenIsDead_FoundIt_15_01");
    AI_OUTPUT(SELF, OTHER, "DIA_Jon_Q404_QueenIsDead_FoundIt_03_02");
    B_GIVEINVITEMS(OTHER, SELF, 0x9b28, 1);
    B_GIVEPLAYERXP(XP_Q404_FOUNDJONCROSSBOW);
}

instance DIA_JON_Q404_AFTERFIGHT(C_INFO) {
    NPC = 0xe6cd;
    NR = 1;
    CONDITION = DIA_JON_Q404_AFTERFIGHT_CONDITION;
    INFORMATION = DIA_JON_Q404_AFTERFIGHT_INFO;
    PERMANENT = FALSE;
    IMPORTANT = TRUE;
}

func int DIA_JON_Q404_AFTERFIGHT_CONDITION() {
    if (((LOG_GETSTATUS(MIS_Q404)) == (LOG_RUNNING)) && (NPC_KNOWSINFO(OTHER, 0x15263))) {
        if ((Q404_FIGHTWITHJON) == (2)) {
            return TRUE;
        };
    };
    return 0 /* !broken stack! */;
}

func void DIA_JON_Q404_AFTERFIGHT_INFO() {
    Q404_MARVINFINISHEDMINE = TRUE;
    AI_OUTPUT(SELF, OTHER, "DIA_Jon_Q404_AfterFight_03_01");
    AI_OUTPUT(OTHER, SELF, "DIA_Jon_Q404_AfterFight_15_02");
    AI_OUTPUT(SELF, OTHER, "DIA_Jon_Q404_AfterFight_03_03");
    AI_OUTPUT(OTHER, SELF, "DIA_Jon_Q404_AfterFight_15_04");
    AI_OUTPUT(OTHER, SELF, "DIA_Jon_Q404_AfterFight_15_05");
    AI_OUTPUT(SELF, OTHER, "DIA_Jon_Q404_AfterFight_03_06");
    INFO_CLEARCHOICES(0x1526a);
    INFO_ADDCHOICE(0x1526a, "(Kill Jon)", 0x1526f);
    INFO_ADDCHOICE(0x1526a, "(Try to get Jon out of the mine)", 0x15270);
    WLD_INSERTNPC(0xc5d4, "SILVERMINE_JONHELPER_03");
    WLD_INSERTNPC(0xc5d4, "SILVERMINE_PATH_38");
    WLD_INSERTNPC(0xc5d4, "SILVERMINE_PATH_69");
    WLD_INSERTNPC(0xc5d4, "SILVERMINE_PATH_98");
    WLD_INSERTNPC(0xc5d4, "SILVERMINE_PATH_104");
}

func void KILLJON() {
    MDL_APPLYOVERLAYMDS(DJG_10020_JON, "HUMANS_SUDDENDEATH.MDS");
    AI_PLAYANI(DJG_10020_JON, T_DEAD);
    SND_PLAY("FIG_SwordFinal");
    SND_PLAY("SVM_14_DEAD");
    B_MAGICHURTNPC(HERO, DJG_10020_JON, 0x270f);
    AI_REMOVEWEAPON(HERO);
    HERO.AIVAR[4] = FALSE;
}

func void JON_GIVEMISSIONITEMS() {
    CREATEINVITEMS(DJG_10020_JON, 0x91e4, 1);
    B_GIVEINVITEMS(DJG_10020_JON, HERO, 0x91e4, 1);
    CREATEINVITEMS(DJG_10020_JON, 0x91e7, 1);
    B_GIVEINVITEMS(DJG_10020_JON, HERO, 0x91e7, 1);
    CREATEINVITEMS(DJG_10020_JON, 0x9017, 1);
    B_GIVEINVITEMS(DJG_10020_JON, HERO, 0x9017, 1);
}

func void DIA_JON_Q404_AFTERFIGHT_KILL() {
    DJG_10020_JON.FLAGS = 0;
    Q404_JONSTATUS = 1;
    AI_OUTPUT(OTHER, SELF, "DIA_Jon_Q404_AfterFight_Kill_15_01");
    B_MARVIN_ATTACKINDIALOGUE_PREPARE();
    AI_FUNCTION(OTHER, 0x1526d);
    AI_FUNCTION(OTHER, 0x1526e);
    B_MARVIN_ATTACKINDIALOGUE_ATTACK();
    AI_LOGENTRY(TOPIC_Q404, LOG_Q404_JON_KILLJON);
    INFO_CLEARCHOICES(0x1526a);
    AI_STOPPROCESSINFOS(HERO);
}

func void DIA_JON_Q404_AFTERFIGHT_SAVE() {
    Q404_JONSTATUS = 2;
    AI_OUTPUT(OTHER, SELF, "DIA_Jon_Q404_AfterFight_save_15_01");
    AI_OUTPUT(SELF, OTHER, "DIA_Jon_Q404_AfterFight_save_03_02");
    AI_OUTPUT(OTHER, SELF, "DIA_Jon_Q404_AfterFight_save_15_03");
    AI_OUTPUT(SELF, OTHER, "DIA_Jon_Q404_AfterFight_save_03_04");
    AI_FUNCTION(SELF, 0x1526e);
    INFO_CLEARCHOICES(0x1526a);
    AI_STOPPROCESSINFOS(SELF);
    AI_LOGENTRY(TOPIC_Q404, LOG_Q404_JON_HELPJON);
    SELF.AIVAR[15] = TRUE;
    SELF.FLAGS = 2;
    NPC_EXCHANGEROUTINE(SELF, FOLLOW);
    SELF.ATTRIBUTE[0] = 100;
    SELF.ATTRIBUTE[1] = 100;
}

