var int PICKLOCKBONUS = 0;
func string RANDOMIZEPICKLOCKSTRING(var int LENGTH) {
    BUF = SB_NEW();
    INDEX = 0;
    LOOPSTART = MEM_STACKPOS.POSITION;
    if ((INDEX) < (LENGTH)) {
        RND = HLP_RANDOM(100);
        if ((RND) <= (50)) {
            SB("L");
        } else {
            SB("R");
        } else {
            INDEX += 1;
        } else {
            MEM_STACKPOS.POSITION = LOOPSTART;
        };
    };
    S = SB_TOSTRING();
    SB_DESTROY();
    return S;
}

var int RANDOMIZEPICKLOCKSTRING.BUF = 0;
var int RANDOMIZEPICKLOCKSTRING.INDEX = 0;
var int RANDOMIZEPICKLOCKSTRING.LOOPSTART = 0;
var int RANDOMIZEPICKLOCKSTRING.RND = 0;
var string RANDOMIZEPICKLOCKSTRING.S = "";
func void RANDOMIZEPICKLOCKS_SUB(var int NODE) {
    L = _^(NODE);
    if (L.DATA) {
        if (HLP_IS_OCMOBLOCKABLE(L.DATA)) {
            MOB = _^(L.DATA);
            LENGTH = STR_LEN(MOB.PICKLOCKSTR);
            if ((LENGTH) > (0)) {
                MOB.PICKLOCKSTR = RANDOMIZEPICKLOCKSTRING(LENGTH);
            };
        };
    };
}

instance RANDOMIZEPICKLOCKS_SUB.L(ZCLISTSORT)
instance RANDOMIZEPICKLOCKS_SUB.MOB(OCMOBLOCKABLE)
var int RANDOMIZEPICKLOCKS_SUB.LENGTH = 0;
func int GETPICKLOCKSTRLEN(var string ORIGINALPICKLOCKSTR) {
    PICKLOCKSTRLEN = STR_LEN(ORIGINALPICKLOCKSTR);
    SKILLLEVEL = NPC_GETTALENTSKILL(HERO, NPC_TALENT_PICKLOCK);
    if ((SKILLLEVEL) == (2)) {
        PICKLOCKSTRLEN -= 2;
    };
    if ((SKILLLEVEL) == (3)) {
        PICKLOCKSTRLEN -= 4;
    };
    if ((PICKLOCKBONUS) > (0)) {
        PICKLOCKSTRLEN -= PICKLOCKBONUS;
    };
    if ((PICKLOCKSTRLEN) < (0)) {
        PICKLOCKSTRLEN = 0;
    };
    return PICKLOCKSTRLEN;
}

var int GETPICKLOCKSTRLEN.PICKLOCKSTRLEN = 0;
var int GETPICKLOCKSTRLEN.SKILLLEVEL = 0;
func void HANDLE_RANDOMIZEPICKLOCKS() {
    if (MEM_WORLD.VOBLIST) {
        LIST_FORFS(MEM_WORLD.VOBLIST, 0x5081);
    };
}

func void HANDLE_CANOPEN() {
    MOB = _^(ECX);
    if ((MOB.BITFIELD) & (OCMOBLOCKABLE_BITFIELD_LOCKED)) {
        if ((STR_LEN(MOB.PICKLOCKSTR)) > (0)) {
            PICKLOCKSTRLEN = GETPICKLOCKSTRLEN(MOB.PICKLOCKSTR);
            if ((PICKLOCKSTRLEN) == (0)) {
                PRINT(PRINT_PICKLOCK_AUTOMATIC);
                MOB.BITFIELD = (MOB.BITFIELD) & (~(OCMOBLOCKABLE_BITFIELD_LOCKED));
            };
        };
    };
}

instance HANDLE_CANOPEN.MOB(OCMOBLOCKABLE)
var int HANDLE_CANOPEN.PICKLOCKSTRLEN = 0;
func void HANDLE_SETPROPERPICKLOCKSTRLEN() {
    MOB = _^(ESI);
    PICKLOCKSTRLEN = GETPICKLOCKSTRLEN(MOB.PICKLOCKSTR);
    ECX = PICKLOCKSTRLEN;
}

instance HANDLE_SETPROPERPICKLOCKSTRLEN.MOB(OCMOBLOCKABLE)
var int HANDLE_SETPROPERPICKLOCKSTRLEN.PICKLOCKSTRLEN = 0;
func void INIT_RANDOMIZEPICKLOCKS_GAMESTART() {
    HOOKENGINEF(0x7244f0, 7, 0x508b);
    WRITENOP(0x723ee2, 6);
    HOOKENGINEF(0x723ee2, 6, 0x508e);
}

func void INIT_RANDOMIZEPICKLOCKS_ALWAYS() {
    FF_APPLYEXT(0x508a, 1, 1);
}

