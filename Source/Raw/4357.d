instance DIA_IVY_Q602_EXIT(C_INFO) {
    NPC = 0xea0c;
    NR = 999;
    CONDITION = DIA_IVY_Q602_EXIT_CONDITION;
    INFORMATION = DIA_IVY_Q602_EXIT_INFO;
    PERMANENT = TRUE;
    DESCRIPTION = DIALOG_ENDE;
}

func int DIA_IVY_Q602_EXIT_CONDITION() {
    return TRUE;
}

func void DIA_IVY_Q602_EXIT_INFO() {
    AI_STOPPROCESSINFOS(SELF);
}

instance DIA_IVY_Q602_HELLO(C_INFO) {
    NPC = 0xea0c;
    NR = 1;
    CONDITION = DIA_IVY_Q602_HELLO_CONDITION;
    INFORMATION = DIA_IVY_Q602_HELLO_INFO;
    PERMANENT = FALSE;
    IMPORTANT = TRUE;
}

func int DIA_IVY_Q602_HELLO_CONDITION() {
    if ((LOG_GETSTATUS(MIS_Q602)) == (LOG_RUNNING)) {
        return TRUE;
    };
    return 0 /* !broken stack! */;
}

var int IVY_Q602_HELLO_TRAITOR = 0;
var int IVY_Q602_HELLO_WHERE = 0;
var int IVY_Q602_HELLO_VOLKER = 0;
func void Q602_CHECKIFIVYDEAD_APPLY() {
    if ((CURRENTLEVEL) == (ARCHOLOS_ENDGAME_ZEN)) {
        if (NPC_ISDEAD(NONE_16_IVY_Q602)) {
            PRINTD("Mo¿esz iœæ");
            WLD_SENDTRIGGER("Q602_MOVER_WALL_IVY");
            FINALBOARDS_IVYSTATUS = 3;
            FF_REMOVE(0x16180);
        };
    };
}

func void IVY_FINALFIGHT() {
    FF_APPLYONCEEXTGT(0x16180, 0, -(1));
    INFO_CLEARCHOICES(0x1617b);
    AI_STOPPROCESSINFOS(SELF);
    B_ATTACK(SELF, OTHER, AR_KILL, 1);
    NONE_16_IVY_Q602.FLAGS = 0;
    NONE_16_IVY_Q602.AIVAR[15] = FALSE;
    SELF.AIVAR[52] = TRUE;
    AI_LOGENTRY(TOPIC_Q602, LOG_Q602_IVYFIGHT);
}

func void DIA_IVY_Q602_HELLO_CHOICES() {
    INFO_CLEARCHOICES(0x1617b);
    INFO_ADDCHOICE(0x1617b, "Enough of this talk.", 0x1618b);
    if ((IVY_Q602_HELLO_VOLKER) == (FALSE)) {
        INFO_ADDCHOICE(0x1617b, "Do you know where the Usurer is?", 0x16189);
    };
    if ((IVY_Q602_HELLO_WHERE) == (FALSE)) {
        INFO_ADDCHOICE(0x1617b, "Where have you been all this time?", 0x16186);
    };
    if ((IVY_Q602_HELLO_TRAITOR) == (FALSE)) {
        INFO_ADDCHOICE(0x1617b, "You're the one who sent those people in the Wolf's Den after me!", 0x16184);
    };
}

func void DIA_IVY_Q602_HELLO_INFO() {
    if ((Q602_ELEVATORCHECK) == (1)) {
        Q602_ELEVATORCHECK = 0;
        WLD_SENDUNTRIGGER("Q602_SEWERS_ELEVATOR");
    };
    AI_STARTFACEANI(SELF, S_ANGRY, 1, -(1));
    AI_OUTPUT(SELF, OTHER, "DIA_Ivy_Q602_Hello_03_01");
    AI_OUTPUT(SELF, OTHER, "DIA_Ivy_Q602_Hello_03_02");
    DIA_IVY_Q602_HELLO_CHOICES();
}

func void DIA_IVY_Q602_HELLO_TRAITOR() {
    IVY_Q602_HELLO_TRAITOR = TRUE;
    AI_STARTFACEANI(OTHER, S_ANGRY, 1, -(1));
    AI_OUTPUT(OTHER, SELF, "DIA_Ivy_Q602_Hello_Traitor_15_01");
    AI_RESETFACEANI(SELF);
    AI_OUTPUT(SELF, OTHER, "DIA_Ivy_Q602_Hello_Traitor_03_02");
    AI_OUTPUT(SELF, OTHER, "DIA_Ivy_Q602_Hello_Traitor_03_03");
    if ((IVYREPUTATION) >= (5)) {
        AI_OUTPUT(SELF, OTHER, "DIA_Ivy_Q602_Hello_Traitor_03_04");
    };
    INFO_CLEARCHOICES(0x1617b);
    INFO_ADDCHOICE(0x1617b, "I think I understand everything now...", 0x16185);
}

func void DIA_IVY_Q602_HELLO_TRAITOR_UNDERSTAND() {
    AI_STARTFACEANI(OTHER, S_SERIOUS, 1, -(1));
    AI_OUTPUT(OTHER, SELF, "DIA_Ivy_Q602_Hello_Understand_15_01");
    AI_OUTPUT(OTHER, SELF, "DIA_Ivy_Q602_Hello_Understand_15_02");
    AI_OUTPUT(OTHER, SELF, "DIA_Ivy_Q602_Hello_Understand_15_03");
    if ((IVYREPUTATION) >= (5)) {
        AI_STARTFACEANI(SELF, S_TIRED, 1, -(1));
        AI_OUTPUT(SELF, OTHER, "DIA_Ivy_Q602_Hello_Understand_03_04");
        AI_OUTPUT(SELF, OTHER, "DIA_Ivy_Q602_Hello_Understand_03_05");
        AI_OUTPUT(SELF, OTHER, "DIA_Ivy_Q602_Hello_Understand_03_06");
    };
    AI_STARTFACEANI(SELF, S_ANGRY, 1, -(1));
    AI_OUTPUT(SELF, OTHER, "DIA_Ivy_Q602_Hello_Understand_03_07");
    AI_OUTPUT(SELF, OTHER, "DIA_Ivy_Q602_Hello_Understand_03_08");
    AI_OUTPUT(SELF, OTHER, "DIA_Ivy_Q602_Hello_Understand_03_09");
    DIA_IVY_Q602_HELLO_CHOICES();
}

func void DIA_IVY_Q602_HELLO_WHERE() {
    IVY_Q602_HELLO_WHERE = TRUE;
    AI_OUTPUT(OTHER, SELF, "DIA_Ivy_Q602_Hello_Where_15_01");
    AI_OUTPUT(SELF, OTHER, "DIA_Ivy_Q602_Hello_Where_03_02");
    AI_OUTPUT(SELF, OTHER, "DIA_Ivy_Q602_Hello_Where_03_03");
    AI_OUTPUT(SELF, OTHER, "DIA_Ivy_Q602_Hello_Where_03_04");
    INFO_CLEARCHOICES(0x1617b);
    INFO_ADDCHOICE(0x1617b, "What did he do to you?", 0x16187);
}

func void DIA_IVY_Q602_HELLO_WHERE_WHAT() {
    AI_OUTPUT(OTHER, SELF, "DIA_Ivy_Q602_Hello_What_15_01");
    AI_STARTFACEANI(SELF, S_ANGRY, 1, -(1));
    AI_OUTPUT(SELF, OTHER, "DIA_Ivy_Q602_Hello_What_03_02");
    AI_OUTPUT(SELF, OTHER, "DIA_Ivy_Q602_Hello_What_03_03");
    if ((NPC_ISDEAD(NONE_2246_BRADLOCK_Q602)) && ((Q305_JAVAD_WENTTONEWHOME) != (2))) {
        INFO_CLEARCHOICES(0x1617b);
        INFO_ADDCHOICE(0x1617b, "I killed Bradlock.", 0x16188);
    };
    DIA_IVY_Q602_HELLO_CHOICES();
}

func void DIA_IVY_Q602_HELLO_WHERE_WHAT_BRADLOCK() {
    IVYREPUTATION = (IVYREPUTATION) + (1);
    PRINTD(CS2("Relacja z Ivy: ", INTTOSTRING(IVYREPUTATION)));
    AI_OUTPUT(OTHER, SELF, "DIA_Ivy_Q602_Hello_Bradlock_15_01");
    AI_STARTFACEANI(SELF, S_SURPRISE, 1, -(1));
    AI_PLAYANI(SELF, T_JUMPB);
    AI_OUTPUT(SELF, OTHER, "DIA_Ivy_Q602_Hello_Bradlock_03_02");
    AI_OUTPUT(SELF, OTHER, "DIA_Ivy_Q602_Hello_Bradlock_03_03");
    AI_RESETFACEANI(SELF);
    DIA_IVY_Q602_HELLO_CHOICES();
}

func void DIA_IVY_Q602_HELLO_VOLKER() {
    IVY_Q602_HELLO_VOLKER = TRUE;
    AI_OUTPUT(OTHER, SELF, "DIA_Ivy_Q602_Hello_Volker_15_01");
    AI_OUTPUT(SELF, OTHER, "DIA_Ivy_Q602_Hello_Volker_03_02");
    INFO_CLEARCHOICES(0x1617b);
    INFO_ADDCHOICE(0x1617b, "You're the one who killed his men?", 0x1618a);
}

func void DIA_IVY_Q602_HELLO_VOLKER_YOU() {
    AI_OUTPUT(OTHER, SELF, "DIA_Ivy_Q602_Hello_You_15_01");
    AI_OUTPUT(SELF, OTHER, "DIA_Ivy_Q602_Hello_You_03_02");
    AI_OUTPUT(SELF, OTHER, "DIA_Ivy_Q602_Hello_You_03_03");
    DIA_IVY_Q602_HELLO_CHOICES();
}

func void DIA_IVY_Q602_HELLO_FINISH() {
    INFO_CLEARCHOICES(0x1617b);
    INFO_ADDCHOICE(0x1617b, DIALOG_BACK, 0x1618c);
    INFO_ADDCHOICE(0x1617b, "We both want to get rid of the Usurer, let's join forces.", 0x1618f);
    INFO_ADDCHOICE(0x1617b, "I'm giving you one chance to disappear forever.", 0x1618e);
    INFO_ADDCHOICE(0x1617b, "You contributed to Jorn's death, you have to pay for it.", 0x1618d);
}

func void DIA_IVY_Q602_HELLO_DIALOG_BACK() {
    DIA_IVY_Q602_HELLO_CHOICES();
}

func void DIA_IVY_Q602_HELLO_FINISH_JORN() {
    AI_STARTFACEANI(OTHER, S_ANGRY, 1, -(1));
    AI_OUTPUT(OTHER, SELF, "DIA_Ivy_Q602_Hello_Jorn_15_01");
    AI_OUTPUT(OTHER, SELF, "DIA_Ivy_Q602_Hello_Jorn_15_02");
    AI_OUTPUT(OTHER, SELF, "DIA_Ivy_Q602_Hello_Jorn_15_03");
    AI_OUTPUT(OTHER, SELF, "DIA_Ivy_Q602_Hello_Jorn_15_04");
    AI_OUTPUT(OTHER, SELF, "DIA_Ivy_Q602_Hello_Jorn_15_05");
    if ((IVYREPUTATION) >= (5)) {
        AI_STARTFACEANI(SELF, S_TIRED, 1, -(1));
        AI_OUTPUT(SELF, OTHER, "DIA_Ivy_Q602_Hello_Jorn_03_06");
        AI_WAITTILLEND(OTHER, SELF);
        AI_DRAWWEAPON(OTHER);
        AI_OUTPUT(OTHER, SELF, "DIA_Ivy_Q602_Hello_Jorn_15_07");
    };
    AI_STARTFACEANI(OTHER, S_ANGRY, 1, -(1));
    AI_OUTPUT(SELF, OTHER, "DIA_Ivy_Q602_Hello_Jorn_03_08");
    IVY_FINALFIGHT();
}

func void DIA_IVY_Q602_HELLO_FINISH_LEAVE() {
    AI_RESETFACEANI(OTHER);
    AI_OUTPUT(OTHER, SELF, "DIA_Ivy_Q602_Hello_Leave_15_01");
    AI_OUTPUT(OTHER, SELF, "DIA_Ivy_Q602_Hello_Leave_15_02");
    AI_OUTPUT(OTHER, SELF, "DIA_Ivy_Q602_Hello_Leave_15_03");
    AI_OUTPUT(OTHER, SELF, "DIA_Ivy_Q602_Hello_Leave_15_04");
    if ((IVYREPUTATION) >= (5)) {
        PRINTD("Mo¿esz iœæ");
        WLD_SENDTRIGGER("Q602_MOVER_WALL_IVY");
        FINALBOARDS_IVYSTATUS = 2;
        AI_STARTFACEANI(SELF, S_TIRED, 1, -(1));
        AI_OUTPUT(SELF, OTHER, "DIA_Ivy_Q602_Hello_Leave_03_05");
        AI_OUTPUT(SELF, OTHER, "DIA_Ivy_Q602_Hello_Leave_03_06");
        AI_FUNCTION(SELF, 0x16190);
        AI_SETWALKMODE(SELF, NPC_WALK);
        AI_GOTOWP(SELF, "PARTE5_SEWERS_12");
        AI_FUNCTION(SELF, 0x16191);
        AI_USEMOB(SELF, "LEVER", -(1));
        AI_FUNCTION(SELF, 0x16192);
        AI_USEMOB(SELF, "LEVER", 1);
        AI_TURNTONPC(SELF, OTHER);
        AI_PLAYANI(SELF, "T_STAND_2_LGUARD");
        AI_OUTPUT(SELF, OTHER, "DIA_Ivy_Q602_Hello_Leave_03_07");
        INFO_CLEARCHOICES(0x1617b);
        AI_STOPPROCESSINFOS(SELF);
        AI_FUNCTION(SELF, 0x16193);
    };
    AI_OUTPUT(SELF, OTHER, "DIA_Ivy_Q602_Hello_Leave_03_08");
    AI_STARTFACEANI(SELF, S_ANGRY, 1, -(1));
    AI_DRAWWEAPON(SELF);
    AI_OUTPUT(SELF, OTHER, "DIA_Ivy_Q602_Hello_Leave_03_09");
    AI_OUTPUT(SELF, OTHER, "DIA_Ivy_Q602_Hello_Leave_03_10");
    IVY_FINALFIGHT();
}

func void DIA_IVY_Q602_HELLO_FINISH_TOGETHER() {
    AI_RESETFACEANI(SELF);
    AI_RESETFACEANI(OTHER);
    AI_OUTPUT(OTHER, SELF, "DIA_Ivy_Q602_Hello_Together_15_02");
    AI_OUTPUT(OTHER, SELF, "DIA_Ivy_Q602_Hello_Together_15_03");
    INFO_CLEARCHOICES(0x1617b);
    INFO_ADDCHOICE(0x1617b, "I don't blame you... I've done a lot of bad things myself lately...", 0x16198);
    INFO_ADDCHOICE(0x1617b, "We'll get that bastard and we'll each go our separate ways.", 0x16199);
}

func void IVY_Q602_CAMERA_01() {
    TELEPORTNPCTOWP(0x71b, "PARTE5_SEWERS_14");
    TELEPORTNPCTOWP(0xea0c, "PARTE5_IVY");
    AI_TURNAWAY(NONE_16_IVY_Q602, HERO);
    DIACAM_DISABLE();
    WLD_SENDTRIGGER("Q602_IVY_01");
}

func void IVY_Q602_CAMERA_02() {
    TELEPORTNPCTOWP(0x71b, "PARTE5_IVY");
    AI_TURNTONPC(HERO, NONE_16_IVY_Q602);
    WLD_SENDTRIGGER("Q602_IVY_02");
    WLD_SENDUNTRIGGER("Q602_IVY_01");
    TELEPORTNPCTOWP(0xea0c, "PARTE5_SEWERS_12");
}

func void IVY_Q602_CAMERA_03() {
    WLD_SENDTRIGGER("Q602_IVY_03");
    WLD_SENDUNTRIGGER("Q602_IVY_02");
    TELEPORTNPCTOWP(0xea0c, "PARTE5_SEWERS_12");
}

func void IVY_Q602_CAMERA_END() {
    FF_APPLYONCEEXTGT(0x16194, 75, 4);
}

func void IVY_Q602_CAMERA_END_APPLY() {
    IVY_Q602_CAMERA_END_COUNT = (IVY_Q602_CAMERA_END_COUNT) + (1);
    if ((IVY_Q602_CAMERA_END_COUNT) == (4)) {
        IVY_Q602_CAMERA_END_COUNT = 0;
        WLD_SENDUNTRIGGER("Q602_IVY_01");
        WLD_SENDUNTRIGGER("Q602_IVY_02");
        WLD_SENDUNTRIGGER("Q602_IVY_03");
        DIACAM_ENABLE();
        B_REMOVENPC(0xea0c);
        TELEPORTNPCTOWP(0xea0c, TOT);
        AI_TELEPORTALWAYS(NONE_16_IVY_Q602, TOT, FALSE);
        WLD_SENDTRIGGER("Q602_SEWERS_ELEVATOR");
        CHANGEVOBCOLLISION("Q602_IVY", FALSE, FALSE, FALSE, TRUE);
        HERO.AIVAR[4] = FALSE;
    };
}

var int IVY_Q602_CAMERA_END_APPLY.IVY_Q602_CAMERA_END_COUNT = 0;
var int IVY_Q602_JOINEDTEAM = 0;
func void DIA_IVY_Q602_HELLO_NEXT() {
    if ((IVYREPUTATION) >= (8)) {
        PRINTD("Mo¿esz iœæ");
        WLD_SENDTRIGGER("Q602_MOVER_WALL_IVY");
        FINALBOARDS_IVYSTATUS = 1;
        IVY_Q602_JOINEDTEAM = TRUE;
        AI_STARTFACEANI(SELF, S_SMILE, 1, -(1));
        AI_OUTPUT(SELF, OTHER, "DIA_Ivy_Q602_Hello_Next_03_01");
        AI_OUTPUT(SELF, OTHER, "DIA_Ivy_Q602_Hello_Next_03_02");
        AI_OUTPUT(SELF, OTHER, "DIA_Ivy_Q602_Hello_Next_03_03");
        INFO_CLEARCHOICES(0x1617b);
        AI_STOPPROCESSINFOS(SELF);
        SELF.AIVAR[15] = TRUE;
        SELF.NPCTYPE = NPCTYPE_FRIEND;
        NPC_EXCHANGEROUTINE(SELF, "Q602_FOLLOW");
        AI_LOGENTRY(TOPIC_Q602, LOG_Q602_IVYJOIN);
    };
    AI_STARTFACEANI(SELF, S_ANGRY, 1, -(1));
    AI_OUTPUT(SELF, OTHER, "DIA_Ivy_Q602_Hello_Next_03_04");
    AI_OUTPUT(SELF, OTHER, "DIA_Ivy_Q602_Hello_Next_03_05");
    IVY_FINALFIGHT();
}

func void DIA_IVY_Q602_HELLO_FINISH_TOGETHER_GUILTY() {
    AI_OUTPUT(OTHER, SELF, "DIA_Ivy_Q602_Hello_Guilty_15_01");
    if ((IVY_DATELOCATION) >= (1)) {
        AI_STARTFACEANI(OTHER, S_SMILE, 1, -(1));
        AI_OUTPUT(OTHER, SELF, "DIA_Ivy_Q602_Hello_Guilty_15_02");
    };
    DIA_IVY_Q602_HELLO_NEXT();
}

func void DIA_IVY_Q602_HELLO_FINISH_TOGETHER_BASTARD() {
    AI_OUTPUT(OTHER, SELF, "DIA_Ivy_Q602_Hello_Bastard_15_01");
    DIA_IVY_Q602_HELLO_NEXT();
}

instance DIA_IVY_Q602_AMBIENT(C_INFO) {
    NPC = 0xea0c;
    NR = 1;
    CONDITION = DIA_IVY_Q602_AMBIENT_CONDITION;
    INFORMATION = DIA_IVY_Q602_AMBIENT_INFO;
    PERMANENT = TRUE;
    IMPORTANT = TRUE;
}

func int DIA_IVY_Q602_AMBIENT_CONDITION() {
    if ((NPC_ISINSTATE(SELF, 0xf09f)) && ((IVY_Q602_JOINEDTEAM) == (TRUE))) {
        return TRUE;
    };
    return 0 /* !broken stack! */;
}

func void DIA_IVY_Q602_AMBIENT_INFO() {
    AI_STARTFACEANI(SELF, "S_SURPRISE", 1, -(1));
    AI_OUTPUT(SELF, OTHER, "DIA_Ivy_Q602_Ambient_03_01");
    AI_OUTPUT(SELF, OTHER, "DIA_Ivy_Q602_Ambient_03_02");
    AI_OUTPUT(SELF, OTHER, "DIA_Ivy_Q602_Ambient_03_03");
    AI_RESETFACEANI(SELF);
    AI_STOPPROCESSINFOS(SELF);
}

