func void SQ417_FAILEDQUEST() {
    if (((SQ417_PATROLTIME) >= (1)) && ((SQ417_PATROLTIME) != (10))) {
        B_LOGENTRY(TOPIC_SQ417, LOG_SQ417_FAILED_V2);
        SETHOLDTIME(FALSE);
        CHANGETIMESPEED(100);
    };
    B_LOGENTRY(TOPIC_SQ417, LOG_SQ417_FAILED_V1);
    LOG_SETSTATUS(_@(MIS_SQ417), TOPIC_SQ417, LOG_FAILED);
    B_STARTOTHERROUTINE(DJG_10012_ARETHE, START);
    NPC_REFRESH(DJG_10012_ARETHE);
    B_IMMEDIATEATTACKPLAYER(DJG_10012_ARETHE, AR_NONE);
}

func void SQ417_REMOVEWOLFSONS() {
    if (HLP_ISVALIDNPC(DJG_10010_GUARD)) {
        B_STARTOTHERROUTINE(DJG_10010_GUARD, "SQ417_WAIT");
        NPC_REFRESH(DJG_10010_GUARD);
    };
    if (HLP_ISVALIDNPC(DJG_10009_WOLFSON)) {
        B_STARTOTHERROUTINE(DJG_10009_WOLFSON, "SQ417_WAIT");
        NPC_REFRESH(DJG_10009_WOLFSON);
    };
    if (HLP_ISVALIDNPC(DJG_10007_WOLFSON)) {
        B_STARTOTHERROUTINE(DJG_10007_WOLFSON, "SQ417_WAIT");
        NPC_REFRESH(DJG_10007_WOLFSON);
    };
    if (HLP_ISVALIDNPC(DJG_10005_WOLFSON)) {
        B_STARTOTHERROUTINE(DJG_10005_WOLFSON, "SQ417_WAIT");
        NPC_REFRESH(DJG_10005_WOLFSON);
    };
    if (HLP_ISVALIDNPC(DJG_10008_WOLFSON)) {
        B_STARTOTHERROUTINE(DJG_10008_WOLFSON, "SQ417_WAIT");
        NPC_REFRESH(DJG_10008_WOLFSON);
    };
    if (HLP_ISVALIDNPC(DJG_10015_BAES)) {
        B_STARTOTHERROUTINE(DJG_10015_BAES, "SQ417_WAIT");
        NPC_REFRESH(DJG_10015_BAES);
    };
    if (HLP_ISVALIDNPC(DJG_10006_WOLFSON)) {
        B_STARTOTHERROUTINE(DJG_10006_WOLFSON, "SQ417_WAIT");
        NPC_REFRESH(DJG_10006_WOLFSON);
    };
    if (HLP_ISVALIDNPC(DJG_10017_LEGRIF)) {
        B_STARTOTHERROUTINE(DJG_10017_LEGRIF, "SQ417_WAIT");
        NPC_REFRESH(DJG_10017_LEGRIF);
    };
    if (HLP_ISVALIDNPC(DJG_10014_VAHRAL)) {
        B_STARTOTHERROUTINE(DJG_10014_VAHRAL, "SQ417_WAIT");
        NPC_REFRESH(DJG_10014_VAHRAL);
    };
    if (HLP_ISVALIDNPC(BAU_16005_FORAL)) {
        B_STARTOTHERROUTINE(BAU_16005_FORAL, "SQ417_WAIT");
        NPC_REFRESH(BAU_16005_FORAL);
    };
    HERO.AIVAR[4] = FALSE;
}

func void SQ417_BRINGBACKWOLFSONS() {
    if (HLP_ISVALIDNPC(DJG_10010_GUARD)) {
        B_STARTOTHERROUTINE(DJG_10010_GUARD, START);
        NPC_REFRESH(DJG_10010_GUARD);
    };
    if (HLP_ISVALIDNPC(DJG_10009_WOLFSON)) {
        B_STARTOTHERROUTINE(DJG_10009_WOLFSON, START);
        NPC_REFRESH(DJG_10009_WOLFSON);
    };
    if (HLP_ISVALIDNPC(DJG_10007_WOLFSON)) {
        B_STARTOTHERROUTINE(DJG_10007_WOLFSON, START);
        NPC_REFRESH(DJG_10007_WOLFSON);
    };
    if (HLP_ISVALIDNPC(DJG_10005_WOLFSON)) {
        B_STARTOTHERROUTINE(DJG_10005_WOLFSON, START);
        NPC_REFRESH(DJG_10005_WOLFSON);
    };
    if (HLP_ISVALIDNPC(DJG_10008_WOLFSON)) {
        B_STARTOTHERROUTINE(DJG_10008_WOLFSON, START);
        NPC_REFRESH(DJG_10008_WOLFSON);
    };
    if (HLP_ISVALIDNPC(DJG_10015_BAES)) {
        B_STARTOTHERROUTINE(DJG_10015_BAES, START);
        NPC_REFRESH(DJG_10015_BAES);
    };
    if (HLP_ISVALIDNPC(DJG_10006_WOLFSON)) {
        B_STARTOTHERROUTINE(DJG_10006_WOLFSON, START);
        NPC_REFRESH(DJG_10006_WOLFSON);
    };
    if (HLP_ISVALIDNPC(DJG_10017_LEGRIF)) {
        B_STARTOTHERROUTINE(DJG_10017_LEGRIF, "NORMALDAY");
        NPC_REFRESH(DJG_10017_LEGRIF);
    };
    if (HLP_ISVALIDNPC(DJG_10014_VAHRAL)) {
        B_STARTOTHERROUTINE(DJG_10014_VAHRAL, "NORMALDAY");
        NPC_REFRESH(DJG_10014_VAHRAL);
    };
    if (HLP_ISVALIDNPC(BAU_16005_FORAL)) {
        B_STARTOTHERROUTINE(BAU_16005_FORAL, START);
        NPC_REFRESH(BAU_16005_FORAL);
    };
    HERO.AIVAR[4] = FALSE;
}

func void SQ417_REMOVETRAPS() {
    SQ417_BLOCKRANDOMEVENTS = TRUE;
    if ((TRAP45_SPAWNED) == (TRUE)) {
        if ((NPC_ISDEAD(DJG_13620_WOLFSON)) == (FALSE)) {
            TELEPORTNPCTOWP(0xe40e, TOT);
            NPC_EXCHANGEROUTINE(DJG_13620_WOLFSON, TOT);
        };
        if ((NPC_ISDEAD(DJG_13621_WOLFSON)) == (FALSE)) {
            TELEPORTNPCTOWP(0xe411, TOT);
            NPC_EXCHANGEROUTINE(DJG_13621_WOLFSON, TOT);
        };
        TRAP45_HIDDEN = TRUE;
    };
    if ((NS16_SPAWNED) == (TRUE)) {
        if ((NPC_ISDEAD(DJG_13357_WOLFSON)) == (FALSE)) {
            TELEPORTNPCTOWP(0xe407, TOT);
            NPC_EXCHANGEROUTINE(DJG_13357_WOLFSON, TOT);
        };
        NS16_HIDDEN = TRUE;
    };
    if ((NS37_SPAWNED) == (TRUE)) {
        if ((NPC_ISDEAD(DJG_13619_WOLFSON)) == (FALSE)) {
            TELEPORTNPCTOWP(0xe40a, TOT);
            NPC_EXCHANGEROUTINE(DJG_13619_WOLFSON, TOT);
        };
        NS37_HIDDEN = TRUE;
    };
    if ((NS44_SPAWNED) == (TRUE)) {
        if ((NPC_ISDEAD(DJG_13699_CRAZYWOLFSON)) == (FALSE)) {
            TELEPORTNPCTOWP(0xe414, TOT);
            NPC_EXCHANGEROUTINE(DJG_13699_CRAZYWOLFSON, TOT);
        };
        NS44_HIDDEN = TRUE;
    };
    if ((TRAP42_SPAWNED) == (TRUE)) {
        if ((NPC_ISDEAD(BDT_13501_REFUGEE)) == (FALSE)) {
            TELEPORTNPCTOWP(0xe405, TOT);
            NPC_EXCHANGEROUTINE(BDT_13501_REFUGEE, TOT);
        };
        TRAP_P16_CH5_HIDDEN = TRUE;
    };
    HERO.AIVAR[4] = FALSE;
}

func void SQ417_BRINGBACKTRAPS() {
    SQ417_BLOCKRANDOMEVENTS = FALSE;
    if ((TRAP45_HIDDEN) == (TRUE)) {
        if ((WOLFSONS_RESULT) == (0)) {
            if ((NPC_ISDEAD(DJG_13620_WOLFSON)) == (FALSE)) {
                TELEPORTNPCTOWP(0xe40e, DJG_13620_WOLFSON.WP);
                NPC_EXCHANGEROUTINE(DJG_13620_WOLFSON, START);
            };
            if ((NPC_ISDEAD(DJG_13621_WOLFSON)) == (FALSE)) {
                TELEPORTNPCTOWP(0xe411, DJG_13621_WOLFSON.WP);
                NPC_EXCHANGEROUTINE(DJG_13621_WOLFSON, START);
            };
            TRAP45_HIDDEN = FALSE;
        };
    };
    if ((NS16_HIDDEN) == (TRUE)) {
        if ((NPC_KNOWSINFO(HERO, 0x141d9)) == (FALSE)) {
            if ((NPC_ISDEAD(DJG_13357_WOLFSON)) == (FALSE)) {
                TELEPORTNPCTOWP(0xe407, DJG_13357_WOLFSON.WP);
                NPC_EXCHANGEROUTINE(DJG_13357_WOLFSON, START);
            };
        };
        NS16_HIDDEN = FALSE;
    };
    if ((NS37_HIDDEN) == (TRUE)) {
        if ((NPC_KNOWSINFO(HERO, 0x141e8)) == (FALSE)) {
            if ((NPC_ISDEAD(DJG_13619_WOLFSON)) == (FALSE)) {
                TELEPORTNPCTOWP(0xe40a, DJG_13619_WOLFSON.WP);
                NPC_EXCHANGEROUTINE(DJG_13619_WOLFSON, START);
            };
        };
        NS37_HIDDEN = FALSE;
    };
    if ((NS44_HIDDEN) == (TRUE)) {
        if (((NPC_KNOWSINFO(HERO, 0x14227)) == (FALSE)) && ((NS44_TRANSFORM) == (FALSE))) {
            if ((NPC_ISDEAD(DJG_13699_CRAZYWOLFSON)) == (FALSE)) {
                TELEPORTNPCTOWP(0xe414, DJG_13699_CRAZYWOLFSON.WP);
                NPC_EXCHANGEROUTINE(DJG_13699_CRAZYWOLFSON, START);
            };
        };
        NS44_HIDDEN = FALSE;
    };
    if ((TRAP_P16_CH5_HIDDEN) == (TRUE)) {
        if ((NPC_ISDEAD(BDT_13501_REFUGEE)) == (FALSE)) {
            TELEPORTNPCTOWP(0xe405, BDT_13501_REFUGEE.WP);
            NPC_EXCHANGEROUTINE(BDT_13501_REFUGEE, START);
        };
        TRAP_P16_CH5_HIDDEN = FALSE;
    };
    HERO.AIVAR[4] = FALSE;
}

func void SQ417_SPAWNWOLFSON() {
    WLD_INSERTNPC(0xe336, RNG_TRAP42_WAYPOINT);
}

func void SQ417_FIRSTBEARATTACK_APPLY() {
    if ((SQ417_FIRSTBEARATTACK_COUNT) == (0)) {
        PRINTD("Rozpoczynam - SQ417_FirstBearAttack_Apply");
        MOVPTR1 = MEM_SEARCHVOBBYNAME("SQ417_MOVER_SCRATCH_01");
        MOVER1 = MEM_PTRTOINST(MOVPTR1);
        MOVPTR2 = MEM_SEARCHVOBBYNAME("SQ417_MOVER_SCRATCH_02");
        MOVER2 = MEM_PTRTOINST(MOVPTR2);
        MOVPTR3 = MEM_SEARCHVOBBYNAME("SQ417_MOVER_BENCH_01");
        MOVER3 = MEM_PTRTOINST(MOVPTR3);
        MOVPTR4 = MEM_SEARCHVOBBYNAME("SQ417_MOVER_BENCH_02");
        MOVER4 = MEM_PTRTOINST(MOVPTR4);
        CHANGEVOBCOLLISION("SQ417_BENCH_01", FALSE, FALSE, FALSE, TRUE);
        CHANGEVOBCOLLISION("SQ417_BENCH_02", FALSE, FALSE, FALSE, TRUE);
        WLD_SENDTRIGGER("SQ417_MOVER_SCRATCH_01");
        WLD_SENDTRIGGER("SQ417_MOVER_SCRATCH_02");
        WLD_SENDTRIGGER("SQ417_MOVER_BENCH_01");
        WLD_SENDTRIGGER("SQ417_MOVER_BENCH_02");
        SQ417_FIRSTBEARATTACK_COUNT = 1;
    };
    if (((((((((MOVER1.MOVERSTATE) != (MOVER_STATE_OPENING)) && ((MOVER1.MOVERSTATE) != (MOVER_STATE_CLOSING))) && ((MOVER2.MOVERSTATE) != (MOVER_STATE_OPENING))) && ((MOVER2.MOVERSTATE) != (MOVER_STATE_CLOSING))) && ((MOVER3.MOVERSTATE) != (MOVER_STATE_OPENING))) && ((MOVER3.MOVERSTATE) != (MOVER_STATE_CLOSING))) && ((MOVER4.MOVERSTATE) != (MOVER_STATE_OPENING))) && ((MOVER4.MOVERSTATE) != (MOVER_STATE_CLOSING))) {
        PRINTD("Skoñczy³em - SQ417_FirstBearAttack_Apply");
        CHANGEVOBCOLLISION("SQ417_BENCH_01", TRUE, TRUE, TRUE, TRUE);
        CHANGEVOBCOLLISION("SQ417_BENCH_02", TRUE, TRUE, TRUE, TRUE);
        FF_REMOVE(0xf877);
        SQ417_FIRSTBEARATTACK_COUNT = 0;
    };
}

var int SQ417_FIRSTBEARATTACK_APPLY.SQ417_FIRSTBEARATTACK_COUNT = 0;
instance SQ417_FIRSTBEARATTACK_APPLY.MOVER1(ZCMOVER)
instance SQ417_FIRSTBEARATTACK_APPLY.MOVER2(ZCMOVER)
instance SQ417_FIRSTBEARATTACK_APPLY.MOVER3(ZCMOVER)
instance SQ417_FIRSTBEARATTACK_APPLY.MOVER4(ZCMOVER)
var int SQ417_FIRSTBEARATTACK_APPLY.MOVPTR1 = 0;
var int SQ417_FIRSTBEARATTACK_APPLY.MOVPTR2 = 0;
var int SQ417_FIRSTBEARATTACK_APPLY.MOVPTR3 = 0;
var int SQ417_FIRSTBEARATTACK_APPLY.MOVPTR4 = 0;
func void SQ417_PATROLTIME_FADESCREEN() {
    SQ417_BRINGBACKWOLFSONS();
    SQ417_BRINGBACKTRAPS();
    B_LOGENTRY(TOPIC_SQ417, LOG_SQ417_PATROL_END);
    B_STARTOTHERROUTINE(DJG_10012_ARETHE, "SQ417_SMALLTALK");
    NPC_REFRESH(DJG_10012_ARETHE);
    B_STARTOTHERROUTINE(DJG_13632_WOLFSON, "SQ417_SMALLTALK");
    NPC_REFRESH(DJG_13632_WOLFSON);
    TELEPORTNPCTOWP(0xe336, DJG_13632_WOLFSON.WP);
    WLD_SETTIME(7, 20);
    FADESCREENFROMBLACK(1);
    SETHOLDTIME(FALSE);
    CHANGETIMESPEED(100);
    HERO.AIVAR[4] = FALSE;
}

func void SQ417_ARETHEPLAN_EVENTS_FADESCREEN() {
    AI_OUTPUT(HERO, HERO, "DIA_MARVIN_SQ417_PATROL_15_05");
    B_LOGENTRY(TOPIC_SQ417, LOG_SQ417_EVENTS_NOISE);
    WLD_SENDTRIGGER("SQ417_SOUND_FIRSTATTEMPT");
    WLD_SENDTRIGGER("SQ417_MOVER_EVENT_01");
    WLD_SENDTRIGGER("SQ417_MOVER_EVENT_02");
    WLD_SENDTRIGGER("SQ417_MOVER_EVENT_03");
    WLD_SENDTRIGGER("SQ417_MOVER_SCRATCH_03");
    WLD_SENDTRIGGER("SQ417_MOVER_SCRATCH_04");
    WLD_SETTIME(23, 20);
    FADESCREENFROMBLACK(1);
    SETHOLDTIME(TRUE);
    HERO.AIVAR[4] = FALSE;
    WLD_INSERTNPC(0xe33d, "WOLFSDEN_SQ417_EVENT_02");
    WLD_INSERTNPC(0xe33a, "WOLFSDEN_SQ417_EVENT_03");
    WLD_INSERTNPC(0xc48d, "WOLFSDEN_BASEMENT_03");
}

func void SQ417_LEVER_APPLY() {
    if ((SQ417_LEVER_COUNT) == (0)) {
        PRINTD("Rozpoczynam - SQ417_LEVER_APPLY");
        MOVPTR1 = MEM_SEARCHVOBBYNAME("SQ417_MOVER_DOOR_01");
        MOVER1 = MEM_PTRTOINST(MOVPTR1);
        MOVPTR2 = MEM_SEARCHVOBBYNAME("SQ417_MOVER_DOOR_02");
        MOVER2 = MEM_PTRTOINST(MOVPTR2);
        CHANGEVOBCOLLISION("SQ417_DOOR_01", FALSE, FALSE, FALSE, TRUE);
        CHANGEVOBCOLLISION("SQ417_DOOR_02", FALSE, FALSE, FALSE, TRUE);
        WLD_SENDTRIGGER("SQ417_MOVER_DOOR_01");
        WLD_SENDTRIGGER("SQ417_MOVER_DOOR_02");
        SQ417_LEVER_COUNT = 1;
    };
    if (((((MOVER1.MOVERSTATE) != (MOVER_STATE_OPENING)) && ((MOVER1.MOVERSTATE) != (MOVER_STATE_CLOSING))) && ((MOVER2.MOVERSTATE) != (MOVER_STATE_OPENING))) && ((MOVER2.MOVERSTATE) != (MOVER_STATE_CLOSING))) {
        PRINTD("Skoñczy³em - SQ417_LEVER_APPLY");
        CHANGEVOBCOLLISION("SQ417_DOOR_01", TRUE, TRUE, TRUE, TRUE);
        CHANGEVOBCOLLISION("SQ417_DOOR_02", TRUE, TRUE, TRUE, TRUE);
        FF_REMOVE(0xf883);
        SQ417_LEVER_COUNT = 0;
        B_STARTOTHERROUTINE(DJG_10015_BAES, "SQ417_FOLLOW");
        NPC_REFRESH(DJG_10015_BAES);
        TELEPORTNPCTOWP(0xe3b2, DJG_10015_BAES.WP);
    };
}

var int SQ417_LEVER_APPLY.SQ417_LEVER_COUNT = 0;
instance SQ417_LEVER_APPLY.MOVER1(ZCMOVER)
instance SQ417_LEVER_APPLY.MOVER2(ZCMOVER)
var int SQ417_LEVER_APPLY.MOVPTR1 = 0;
var int SQ417_LEVER_APPLY.MOVPTR2 = 0;
func void SQ417_HIDEDOOR_APPLY() {
    if ((SQ417_HIDEDOOR_APPLY_COUNT) == (0)) {
        PRINTD("Rozpoczynam - SQ417_HIDEDOOR_APPLY");
        MOVPTR1 = MEM_SEARCHVOBBYNAME("SQ417_MOVER_DOOR_02");
        MOVER1 = MEM_PTRTOINST(MOVPTR1);
        MOVPTR2 = MEM_SEARCHVOBBYNAME("SQ417_MOVER_DOOR_03");
        MOVER2 = MEM_PTRTOINST(MOVPTR2);
        CHANGEVOBCOLLISION("SQ417_DOOR_02", FALSE, FALSE, FALSE, TRUE);
        CHANGEVOBCOLLISION("SQ417_DOOR_03", FALSE, FALSE, FALSE, TRUE);
        WLD_SENDTRIGGER("SQ417_MOVER_DOOR_02");
        WLD_SENDTRIGGER("SQ417_MOVER_DOOR_03");
        SQ417_HIDEDOOR_APPLY_COUNT = 1;
    };
    if (((((MOVER1.MOVERSTATE) != (MOVER_STATE_OPENING)) && ((MOVER1.MOVERSTATE) != (MOVER_STATE_CLOSING))) && ((MOVER2.MOVERSTATE) != (MOVER_STATE_OPENING))) && ((MOVER2.MOVERSTATE) != (MOVER_STATE_CLOSING))) {
        PRINTD("Skoñczy³em - SQ417_HIDEDOOR_APPLY");
        CHANGEVOBCOLLISION("SQ417_DOOR_02", TRUE, TRUE, TRUE, TRUE);
        CHANGEVOBCOLLISION("SQ417_DOOR_03", TRUE, TRUE, TRUE, TRUE);
        FF_REMOVE(0xf889);
        SQ417_HIDEDOOR_APPLY_COUNT = 0;
        if ((SQ417_FINISHCHECK) != (2)) {
            B_STARTOTHERROUTINE(DJG_10015_BAES, TOT);
            NPC_REFRESH(DJG_10015_BAES);
            TELEPORTNPCTOWP(0xe3b2, DJG_10015_BAES.WP);
        };
        B_STARTOTHERROUTINE(BEAR_SQ417, TOT);
        NPC_REFRESH(BEAR_SQ417);
        TELEPORTNPCTOWP(0xc48d, BEAR_SQ417.WP);
    };
}

var int SQ417_HIDEDOOR_APPLY.SQ417_HIDEDOOR_APPLY_COUNT = 0;
instance SQ417_HIDEDOOR_APPLY.MOVER1(ZCMOVER)
instance SQ417_HIDEDOOR_APPLY.MOVER2(ZCMOVER)
var int SQ417_HIDEDOOR_APPLY.MOVPTR1 = 0;
var int SQ417_HIDEDOOR_APPLY.MOVPTR2 = 0;
func void SQ417_REMOVENPC_PART1() {
    if (HLP_ISVALIDNPC(DJG_13635_WOLFSON)) {
        B_REMOVENPC(0xe33d);
    };
    if (HLP_ISVALIDNPC(DJG_13634_WOLFSON)) {
        B_REMOVENPC(0xe33a);
    };
    B_STARTOTHERROUTINE(DJG_10012_ARETHE, "SQ417_SEARCH");
    NPC_REFRESH(DJG_10012_ARETHE);
    TELEPORTNPCTOWP(0xe39f, DJG_10012_ARETHE.WP);
}

func void SQ417_REMOVENPC_PART2() {
    SQ417_BRINGBACKWOLFSONS();
    SQ417_BRINGBACKTRAPS();
    WLD_SENDTRIGGER("SQ417_MOVER_SCRATCH_01");
    WLD_SENDTRIGGER("SQ417_MOVER_SCRATCH_02");
    WLD_SENDTRIGGER("SQ417_MOVER_SCRATCH_03");
    WLD_SENDTRIGGER("SQ417_MOVER_SCRATCH_04");
    WLD_SENDTRIGGER("SQ417_MOVER_EVENT_01");
    WLD_SENDTRIGGER("SQ417_MOVER_EVENT_02");
    WLD_SENDTRIGGER("SQ417_MOVER_EVENT_03");
    FF_APPLYONCEEXTGT(0xf889, 0, -(1));
    DJG_10015_BAES.AIVAR[96] = 0;
    B_STARTOTHERROUTINE(DJG_10015_BAES, START);
    NPC_REFRESH(DJG_10015_BAES);
    TELEPORTNPCTOWP(0xe3b2, DJG_10015_BAES.WP);
    Q402_REMOVESPILLEDWINE();
}

