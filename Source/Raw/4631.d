instance SQ311_DOORCLOSED(CUTSCENE) {
    ONSTART = FUNCTION(0x16aff);
}

func void SQ311_DOORCLOSED_WAIT() {
    AI_WAITTILLEND(MIL_11130_LEWKO, HERO);
    AI_WAITTILLEND(HERO, MIL_11130_LEWKO);
}

func void SQ311_DOORCLOSED_START() {
    B_STARTOTHERROUTINE(MIL_11131_ELWART, "SQ311_MALENDEAD");
    NPC_REFRESH(MIL_11131_ELWART);
    TELEPORTNPCTOWP(0xdf79, MIL_11131_ELWART.WP);
    WLD_SENDTRIGGER("SQ311_DOORCLOSED_01");
    TELEPORTNPCTOWP(0xdf74, "PART10_HOUSE2_04");
    TELEPORTNPCTOWP(0x71b, "PART10_HOUSE2_SQ311_HERO");
    NPC_CLEARAIQUEUE(MIL_11130_LEWKO);
    MIL_11130_LEWKO.AIVAR[92] = TRUE;
    AI_TURNTONPC(HERO, NOV_205_NOVIZE);
    AI_TURNTONPC(MIL_11130_LEWKO, HERO);
    SQ311_DOORCLOSED_WAIT();
    AI_FUNCTION(HERO, 0x16b02);
    AI_PLAYANI(HERO, "T_EXPLOSION_SCARED_HERO");
    AI_WAIT(MIL_11130_LEWKO, 0x40000000);
    AI_FUNCTION(MIL_11130_LEWKO, 0x16b00);
    AI_WAIT(MIL_11130_LEWKO, 0x40200000);
    AI_FUNCTION(MIL_11130_LEWKO, 0x16b01);
    AI_WAIT(MIL_11130_LEWKO, 0x3f800000);
    AI_DRAWWEAPON(MIL_11130_LEWKO);
    AI_WAIT(MIL_11130_LEWKO, 0x3f000000);
    SQ311_DOORCLOSED_WAIT();
    AI_FUNCTION(MIL_11130_LEWKO, 0x16b07);
}

func void SQ311_DOORCLOSED_CAMERA_01() {
    WLD_SENDTRIGGER("SQ311_DOORCLOSED_02");
    WLD_SENDUNTRIGGER("SQ311_DOORCLOSED_01");
}

func void SQ311_DOORCLOSED_CAMERA_02() {
    WLD_SENDTRIGGER("SQ311_DOORCLOSED_03");
    WLD_SENDUNTRIGGER("SQ311_DOORCLOSED_02");
}

func void SQ311_DOORCLOSED_EVENT() {
    SND_PLAY("DOOR_SLAM");
    CHANGEVOBCOLLISION("SQ311_LEWKODOOR_01", FALSE, FALSE, FALSE, FALSE);
    FF_APPLYONCEEXTGT(0x16b03, 0, -(1));
}

func void SQ311_DOORCLOSED_APPLY() {
    if ((SQ311_DOORCLOSED_COLLISION) == (0)) {
        PRINTD("Rozpoczynam - SQ311_DoorClosed_Apply");
        MOVPTR1 = MEM_SEARCHVOBBYNAME("SQ311_MOVER_LEWKODOOR");
        MOVER1 = MEM_PTRTOINST(MOVPTR1);
        CHANGEVOBCOLLISION("SQ311_LEWKODOOR_02", FALSE, FALSE, FALSE, TRUE);
        WLD_SENDTRIGGER("SQ311_MOVER_LEWKODOOR");
        SQ311_DOORCLOSED_COLLISION = 1;
    };
    if (((MOVER1.MOVERSTATE) != (MOVER_STATE_OPENING)) && ((MOVER1.MOVERSTATE) != (MOVER_STATE_CLOSING))) {
        PRINTD("Skoñczy³em - SQ311_DoorClosed_Apply");
        CHANGEVOBCOLLISION("SQ311_LEWKODOOR_02", TRUE, TRUE, TRUE, TRUE);
        FF_REMOVE(0x16b03);
        SQ311_DOORCLOSED_COLLISION = 0;
    };
}

var int SQ311_DOORCLOSED_APPLY.SQ311_DOORCLOSED_COLLISION = 0;
instance SQ311_DOORCLOSED_APPLY.MOVER1(ZCMOVER)
var int SQ311_DOORCLOSED_APPLY.MOVPTR1 = 0;
func void SQ311_DOORCLOSED_FINISH() {
    HERO.AIVAR[4] = TRUE;
    FF_APPLYONCEEXT(0x16b08, 75, 4);
}

func void SQ311_DOORCLOSED_FINISH_APPLY() {
    SQ311_DOORCLOSED_FINISH_COUNT = (SQ311_DOORCLOSED_FINISH_COUNT) + (1);
    if ((SQ311_DOORCLOSED_FINISH_COUNT) == (4)) {
        CREATEINVITEMS(MIL_11130_LEWKO, 0x902e, 1);
        WLD_SENDUNTRIGGER("SQ311_DOORCLOSED_01");
        WLD_SENDUNTRIGGER("SQ311_DOORCLOSED_02");
        WLD_SENDUNTRIGGER("SQ311_DOORCLOSED_03");
        HERO.AIVAR[4] = FALSE;
        SQ311_FIGHTWITHLEWKO = 1;
        MIL_11130_LEWKO.FLAGS = 0;
        MIL_11130_LEWKO.GUILD = GIL_BDT;
        NPC_SETTRUEGUILD(MIL_11130_LEWKO, GIL_BDT);
        MIL_11131_ELWART.FLAGS = 0;
        MIL_11131_ELWART.GUILD = GIL_BDT;
        NPC_SETTRUEGUILD(MIL_11131_ELWART, GIL_BDT);
        B_IMMEDIATEATTACKPLAYER(MIL_11130_LEWKO, AR_KILL);
    };
}

var int SQ311_DOORCLOSED_FINISH_APPLY.SQ311_DOORCLOSED_FINISH_COUNT = 0;
