instance DIA_KAF_EXIT(C_INFO) {
    NPC = 0xd0b5;
    NR = 999;
    CONDITION = DIA_KAF_EXIT_CONDITION;
    INFORMATION = DIA_KAF_EXIT_INFO;
    PERMANENT = TRUE;
    DESCRIPTION = DIALOG_ENDE;
}

func int DIA_KAF_EXIT_CONDITION() {
    return TRUE;
}

func void DIA_KAF_EXIT_INFO() {
    AI_STOPPROCESSINFOS(SELF);
}

instance DIA_KAF_HELLO(C_INFO) {
    NPC = 0xd0b5;
    NR = 1;
    CONDITION = DIA_KAF_HELLO_CONDITION;
    INFORMATION = DIA_KAF_HELLO_INFO;
    PERMANENT = FALSE;
    IMPORTANT = TRUE;
}

func int DIA_KAF_HELLO_CONDITION() {
    if ((LOG_GETSTATUS(MIS_FAQ002)) == (LOG_RUNNING)) {
        if (NPC_KNOWSINFO(OTHER, 0x10ef8)) {
            return TRUE;
        };
    };
    return 0 /* !broken stack! */;
}

func void KAF_ARENAFIGHT() {
    SELF.AIVAR[45] = AF_RUNNING;
    AI_STOPPROCESSINFOS(SELF);
    B_ATTACK(SELF, OTHER, AR_NONE, 1);
}

func void DIA_KAF_HELLO_INFO() {
    FAQ002_FIGHTWITHKAF = 1;
    AI_OUTPUT(SELF, OTHER, "DIA_Kaf_Hello_03_01");
    AI_OUTPUT(OTHER, SELF, "DIA_Kaf_Hello_15_02");
    AI_OUTPUT(SELF, OTHER, "DIA_Kaf_Hello_03_03");
    AI_OUTPUT(OTHER, SELF, "DIA_Kaf_Hello_15_04");
    AI_OUTPUT(SELF, OTHER, "DIA_Kaf_Hello_03_05");
    AI_OUTPUT(OTHER, SELF, "DIA_Kaf_Hello_15_06");
    AI_OUTPUT(SELF, OTHER, "DIA_Kaf_Hello_03_07");
    AI_STOPPROCESSINFOS(SELF);
    KAF_ARENAFIGHT();
}

instance DIA_KAF_FAQ002_MEMORY(C_INFO) {
    NPC = 0xd0b5;
    NR = 2;
    CONDITION = DIA_KAF_FAQ002_MEMORY_CONDITION;
    INFORMATION = DIA_KAF_FAQ002_MEMORY_INFO;
    PERMANENT = FALSE;
    IMPORTANT = TRUE;
}

func int DIA_KAF_FAQ002_MEMORY_CONDITION() {
    if ((LOG_GETSTATUS(MIS_FAQ002)) == (LOG_RUNNING)) {
        if ((FAQ002_FIGHTWITHKAF) == (1)) {
            if (((SELF.AIVAR[64]) == (FALSE)) && ((SELF.AIVAR[0]) != (FIGHT_NONE))) {
                if ((SELF.AIVAR[45]) != (AF_NONE)) {
                    if ((SELF.AIVAR[0]) == (FIGHT_LOST)) {
                        return TRUE;
                    };
                };
            };
        };
    };
    return 0 /* !broken stack! */;
}

func void KAF_HEALHIM() {
    SELF.ATTRIBUTE[0] = SELF.ATTRIBUTE[1];
}

func void DIA_KAF_FAQ002_MEMORY_INFO() {
    VLK_6249_KAF.AIVAR[15] = TRUE;
    FAQ002_FIGHTWITHKAF = 2;
    AI_OUTPUT(OTHER, SELF, "DIA_Kaf_FAQ002_Memory_15_01");
    AI_OUTPUT(SELF, OTHER, "DIA_Kaf_FAQ002_Memory_03_02");
    AI_OUTPUT(SELF, OTHER, "DIA_Kaf_FAQ002_Memory_03_03");
    AI_OUTPUT(OTHER, SELF, "DIA_Kaf_FAQ002_Memory_15_04");
    AI_OUTPUT(SELF, OTHER, "DIA_Kaf_FAQ002_Memory_03_05");
    AI_WAITTILLEND(OTHER, SELF);
    AI_DRAWWEAPON(OTHER);
    AI_WAITTILLEND(SELF, OTHER);
    AI_PLAYANI(SELF, T_STAND_2_SCAREDDIALOGUE);
    AI_OUTPUT(OTHER, SELF, "DIA_Kaf_FAQ002_Memory_15_06");
    AI_OUTPUT(OTHER, SELF, "DIA_Kaf_FAQ002_Memory_15_07");
    AI_OUTPUT(SELF, OTHER, "DIA_Kaf_FAQ002_Memory_03_08");
    AI_OUTPUT(SELF, OTHER, "DIA_Kaf_FAQ002_Memory_03_09");
    AI_WAITTILLEND(OTHER, SELF);
    AI_REMOVEWEAPON(OTHER);
    AI_PLAYANI(SELF, "T_REMOVE_SCAREDDIALOGUE");
    AI_PLAYANI(VLK_6249_KAF, T_PLUNDER);
    AI_FUNCTION(SELF, 0x12731);
    AI_LOGENTRY(TOPIC_FAQ002, LOG_FAQ002_KAF_AFTERFIGHT);
    AI_STOPPROCESSINFOS(SELF);
    NPC_EXCHANGEROUTINE(VLK_6249_KAF, "GUIDE");
    KAF_HEALHIM();
    SELF.AIVAR[45] = AF_NONE;
    SELF.AIVAR[64] = TRUE;
}

func void KAF_EQUIPARMOR() {
    CREATEINVITEM(VLK_6249_KAF, 0x8a63);
    NPC_REMOVEINVITEMS(VLK_6249_KAF, 0x8ae1, 1);
    AI_EQUIPARMOR(VLK_6249_KAF, 0x8a63);
}

instance DIA_KAF_FAQ002_TRAP(C_INFO) {
    NPC = 0xd0b5;
    NR = 3;
    CONDITION = DIA_KAF_FAQ002_TRAP_CONDITION;
    INFORMATION = DIA_KAF_FAQ002_TRAP_INFO;
    PERMANENT = FALSE;
    IMPORTANT = TRUE;
}

func int DIA_KAF_FAQ002_TRAP_CONDITION() {
    if ((FAQ002_FIGHTWITHKAF) == (2)) {
        if (((NPC_GETDISTTOWP(SELF, RNG_TRAP07_WAYPOINT)) < (500)) && (NPC_KNOWSINFO(OTHER, 0x1272d))) {
            return TRUE;
        };
    };
    return 0 /* !broken stack! */;
}

func void JEFANDROFCAM_DISABLE() {
    WLD_SENDUNTRIGGER("KM_KAFTRAP");
    DIACAM_ENABLE();
}

func void DIA_KAF_FAQ002_TRAP_INFO() {
    VLK_6249_KAF.AIVAR[15] = FALSE;
    AI_OUTPUT(SELF, OTHER, "DIA_Kaf_FAQ002_Trap_03_01");
    AI_OUTPUT(OTHER, SELF, "DIA_Kaf_FAQ002_Trap_15_02");
    AI_OUTPUT(SELF, OTHER, "DIA_Kaf_FAQ002_Trap_03_03");
    AI_OUTPUT(OTHER, SELF, "DIA_Kaf_FAQ002_Trap_15_04");
    AI_WAITTILLEND(SELF, OTHER);
    if ((NPC_HASITEMS(SELF, 0x84d1)) == (0)) {
        CREATEINVITEMS(SELF, 0x84d1, 1);
    };
    AI_PLAYANI(SELF, T_LAUGH);
    AI_OUTPUT(OTHER, SELF, "DIA_Kaf_FAQ002_Trap_15_05");
    AI_OUTPUT(SELF, OTHER, "DIA_Kaf_FAQ002_Trap_03_06");
    AI_FUNCTION(SELF, 0x1273b);
    AI_FUNCTION(SELF, 0x1273a);
    AI_OUTPUT(SELF, OTHER, "DIA_Kaf_FAQ002_Trap_03_07");
    AI_WAITTILLEND(OTHER, SELF);
    AI_TURNAWAY(OTHER, SELF);
    AI_OUTPUT(SELF, OTHER, "DIA_Kaf_FAQ002_Trap_03_08");
    AI_OUTPUT(OTHER, SELF, "DIA_Kaf_FAQ002_Trap_15_09");
    AI_OUTPUT(SELF, OTHER, "DIA_Kaf_FAQ002_Trap_03_10");
    AI_WAITTILLEND(OTHER, SELF);
    AI_TURNTONPC(OTHER, SELF);
    AI_OUTPUT(SELF, OTHER, "DIA_Kaf_FAQ002_Trap_03_11");
    AI_OUTPUT(SELF, OTHER, "DIA_Kaf_FAQ002_Trap_03_12");
    AI_OUTPUT(SELF, OTHER, "DIA_Kaf_FAQ002_Trap_03_13");
    INFO_CLEARCHOICES(0x12732);
    INFO_ADDCHOICE(0x12732, "Why is Ernesto so important to you?", 0x12738);
    INFO_ADDCHOICE(0x12732, "Who's your boss?", 0x12739);
}

func void DIA_KAF_FAQ002_TRAP_END() {
    AI_OUTPUT(SELF, OTHER, "DIA_Kaf_FAQ002_Trap_Ernesto_03_04");
    AI_OUTPUT(SELF, OTHER, "DIA_Kaf_FAQ002_Trap_Ernesto_03_05");
    AI_OUTPUT(OTHER, SELF, "DIA_Kaf_FAQ002_Trap_Ernesto_15_06");
    AI_OUTPUT(SELF, OTHER, "DIA_Kaf_FAQ002_Trap_Ernesto_03_07");
    AI_OUTPUT(SELF, OTHER, "DIA_Kaf_FAQ002_Trap_Ernesto_03_08");
    INFO_CLEARCHOICES(0x12732);
    AI_STOPPROCESSINFOS(SELF);
    AI_FUNCTION(SELF, 0x1273c);
}

func void DIA_KAF_FAQ002_TRAP_COUNT() {
    FAQ002_KAFINFORMATION = (FAQ002_KAFINFORMATION) + (1);
    if ((FAQ002_KAFINFORMATION) == (2)) {
        DIA_KAF_FAQ002_TRAP_END();
    };
}

func void DIA_KAF_FAQ002_TRAP_ERNESTO() {
    JEFANDROFCAM_DISABLE();
    AI_OUTPUT(OTHER, SELF, "DIA_Kaf_FAQ002_Trap_Ernesto_15_01");
    AI_OUTPUT(SELF, OTHER, "DIA_Kaf_FAQ002_Trap_Ernesto_03_02");
    AI_OUTPUT(SELF, OTHER, "DIA_Kaf_FAQ002_Trap_Ernesto_03_03");
    DIA_KAF_FAQ002_TRAP_COUNT();
}

func void DIA_KAF_FAQ002_TRAP_BOSS() {
    JEFANDROFCAM_DISABLE();
    AI_OUTPUT(OTHER, SELF, "DIA_Kaf_FAQ002_Trap_Boss_15_01");
    AI_OUTPUT(SELF, OTHER, "DIA_Kaf_FAQ002_Trap_Boss_03_02");
    AI_OUTPUT(SELF, OTHER, "DIA_Kaf_FAQ002_Trap_Boss_03_03");
    DIA_KAF_FAQ002_TRAP_COUNT();
}

func void INSERJEFANDROF() {
    WLD_INSERTNPC(0xd0bc, "PARTM3_PATH_34");
    WLD_INSERTNPC(0xd0b9, "PARTM3_PATH_43");
}

func void JEFANDROFCAM() {
    TELEPORTNPCTOWP(0x71b, "PARTM3_KAFTRAP_05");
    TELEPORTNPCTOWP(0xd0b5, VLK_6249_KAF.WP);
    DIACAM_DISABLE();
    WLD_SENDTRIGGER("KM_KAFTRAP");
}

func void BROTHERSATTACK() {
    FAQ002_FIGHTWITHBROTHERS = 1;
    VLK_6249_KAF.AIVAR[52] = TRUE;
    VLK_6251_ROF.AIVAR[52] = TRUE;
    VLK_6250_JEF.AIVAR[52] = TRUE;
    B_IMMEDIATEATTACKPLAYER(VLK_6249_KAF, AR_KILL);
    B_IMMEDIATEATTACKPLAYER(VLK_6251_ROF, AR_KILL);
    B_IMMEDIATEATTACKPLAYER(VLK_6250_JEF, AR_KILL);
    VLK_6249_KAF.FLAGS = 0;
    VLK_6249_KAF.AIVAR[45] = AF_RUNNING;
    VLK_6251_ROF.AIVAR[45] = AF_RUNNING;
    VLK_6250_JEF.AIVAR[45] = AF_RUNNING;
}

