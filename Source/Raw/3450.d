func void KQ402_PREPAREBARRACKS() {
    KQ402_ARWIDCUTSCENE = 1;
    KQ402_LEAVEGUILD_MOVER_01 = TRUE;
    WLD_SENDTRIGGER("KQ402_WOODCHEST_ARMORS_01");
    WLD_SENDTRIGGER("KQ402_WOODCHEST_ARMORS_02");
    B_STARTOTHERROUTINE(NONE_2009_LENNART, "KQ402_ARMORS");
    B_STARTOTHERROUTINE(MIL_4040_CABI, "KQ402_LAUGH");
    B_STARTOTHERROUTINE(MIL_4041_LEVE, "KQ402_LAUGH");
    B_STARTOTHERROUTINE(MIL_4017_ARWID, TOT);
    KQ402_ARWID_RTNCHECK = 1;
    TELEPORTNPCTOWP(0xcca0, TOT);
    TELEPORTNPCTOWP(0xcf09, NONE_2009_LENNART.WP);
    TELEPORTNPCTOWP(0xcea7, MIL_4040_CABI.WP);
    TELEPORTNPCTOWP(0xcec1, MIL_4041_LEVE.WP);
    WLD_INSERTNPC(0xccbc, "PARTM3_KQ402_ARWID");
}

func void KQ402_CLEARARWIDCUTSCENE() {
    KQ402_ARWIDCUTSCENE = 3;
    NPC_EXCHANGEROUTINE(MIL_4000_RODERICH, START);
    NPC_EXCHANGEROUTINE(NONE_2009_LENNART, START);
    NPC_EXCHANGEROUTINE(MIL_4017_ARWID_KQ402, "KQ402_PATROL");
    NPC_EXCHANGEROUTINE(MIL_4040_CABI, START);
    NPC_EXCHANGEROUTINE(MIL_4041_LEVE, START);
}

func void ARWID_KQ402_DISABLECAMERA_START() {
    ARWID_KQ402_DISABLECAMERA_COUNT = (ARWID_KQ402_DISABLECAMERA_COUNT) + (1);
    if ((ARWID_KQ402_DISABLECAMERA_COUNT) == (4)) {
        FADESCREENTOBLACKF(1, 0xf1e7, 1000);
    };
}

var int ARWID_KQ402_DISABLECAMERA_START.ARWID_KQ402_DISABLECAMERA_COUNT = 0;
func void ARWID_KQ402_DISABLECAMERA_FADESCREEN() {
    B_STARTOTHERROUTINE(MIL_4000_RODERICH, "KQ402_OBSERVE");
    NPC_REFRESH(MIL_4000_RODERICH);
    TELEPORTNPCTOWP(0x71b, "PARTM3_RODERICH_04");
    TELEPORTNPCTOWP(0xce47, MIL_4000_RODERICH.WP);
    WLD_SETTIME(12, 0);
    HERO.AIVAR[4] = FALSE;
    WLD_SENDUNTRIGGER("KQ402_ARWID_01");
    WLD_SENDUNTRIGGER("KQ402_ARWID_02");
    WLD_SENDUNTRIGGER("KQ402_ARWID_03");
    DIACAM_ENABLE();
    FADESCREENFROMBLACK(1);
    HERO.AIVAR[4] = FALSE;
    AI_TURNTONPC(HERO, MIL_4000_RODERICH);
    AI_TURNTONPC(MIL_4000_RODERICH, HERO);
}

func void KQ402_PREPARELENNART() {
    PRINTD("Lennart przebrany");
    KQ402_LEAVEGUILD_MOVER_01 = FALSE;
    WLD_SENDTRIGGER("KQ402_WOODCHEST_ARMORS_01");
    WLD_SENDTRIGGER("KQ402_WOODCHEST_ARMORS_02");
    B_STARTOTHERROUTINE(NONE_2009_LENNART, TOT);
    TELEPORTNPCTOWP(0xcf09, TOT);
    WLD_INSERTNPC(0xcf10, "PARTM3_BARRACK_HOUSE2_LENNART");
    WLD_REMOVEITEM(ITAR_MIL_L_KQ402_02);
    B_STARTOTHERROUTINE(NONE_2009_LENNART_KQ402, "KQ402_PATROL");
    WLD_REMOVEITEM(ITAR_MIL_L_KQ402_01);
}

func void KQ402_PREPARECITIZEN() {
    PRINTD("4 mieszkañców zmieni³o RTN");
    B_STARTOTHERROUTINE(VLK_6115_GUY, "KQ402");
    B_STARTOTHERROUTINE(VLK_6120_GUY, "KQ402");
    B_STARTOTHERROUTINE(VLK_6072_GIRL, "KQ402");
    B_STARTOTHERROUTINE(VLK_6076_GUY, "KQ402");
}

func void KQ402_CLEARCITIZENRTN() {
    PRINTD("4 mieszkañców zmieni³o RTN");
    B_STARTOTHERROUTINE(VLK_6115_GUY, START);
    B_STARTOTHERROUTINE(VLK_6120_GUY, START);
    B_STARTOTHERROUTINE(VLK_6072_GIRL, START);
    B_STARTOTHERROUTINE(VLK_6076_GUY, START);
}

func void KQ402_CHANGENAMEWOODCHEST() {
    if ((KQ402_CHANGENAMEWOODCHEST_COUNT) == (1)) {
        MOB_CHANGEFOCUSNAME("KQ402_CHEST_05", "MOBNAME_NOTHING");
        KQ402_CHANGENAMEWOODCHEST_COUNT = 0;
    };
    MOB_CHANGEFOCUSNAME("KQ402_CHEST_05", "MOBNAME_WOODCHEST_KQ402");
    KQ402_CHANGENAMEWOODCHEST_COUNT = 1;
    MOB_CHANGEFOCUSNAME("KQ402_CHEST_04", "MOBNAME_WOODCHEST_KQ402");
    PRINTD("Zmiana nazewnictwa skrzynek");
    MOB_CHANGEFOCUSNAME("KQ402_CHEST_03", "MOBNAME_WOODCHEST_KQ402");
}

var int KQ402_CHANGENAMEWOODCHEST.KQ402_CHANGENAMEWOODCHEST_COUNT = 0;
func void KQ402_CHANGEWOODCHESTS() {
    FF_APPLYONCEEXTGT(0xf139, 0, -(1));
    FF_APPLYONCEEXTGT(0xf1ee, 0, -(1));
}

func void KQ402_CHANGEWOODCHESTS_APPLY() {
    if ((KQ402_CHANGEWOODCHESTS_APPLY_COLLISION) == (0)) {
        PRINTD("Rozpoczynam - KQ402_ChangeWoodChests_Apply");
        MOVPTR1 = MEM_SEARCHVOBBYNAME("KM_KQ402_CHEST_01_RUST");
        MOVER1 = MEM_PTRTOINST(MOVPTR1);
        MOVPTR2 = MEM_SEARCHVOBBYNAME("KM_KQ402_CHEST_02_RUST");
        MOVER2 = MEM_PTRTOINST(MOVPTR2);
        MOVPTR3 = MEM_SEARCHVOBBYNAME("KM_KQ402_CHEST_03_RUST");
        MOVER3 = MEM_PTRTOINST(MOVPTR3);
        MOVPTR4 = MEM_SEARCHVOBBYNAME("KM_KQ402_CHEST_04_RUST");
        MOVER4 = MEM_PTRTOINST(MOVPTR4);
        MOVPTR5 = MEM_SEARCHVOBBYNAME("KM_KQ402_CHEST_05_RUST");
        MOVER5 = MEM_PTRTOINST(MOVPTR5);
        CHANGEVOBCOLLISION("KQ402_CHEST_01_RUST", FALSE, FALSE, FALSE, TRUE);
        CHANGEVOBCOLLISION("KQ402_CHEST_02_RUST", FALSE, FALSE, FALSE, TRUE);
        CHANGEVOBCOLLISION("KQ402_CHEST_03_RUST", FALSE, FALSE, FALSE, TRUE);
        CHANGEVOBCOLLISION("KQ402_CHEST_04_RUST", FALSE, FALSE, FALSE, TRUE);
        CHANGEVOBCOLLISION("KQ402_CHEST_05_RUST", FALSE, FALSE, FALSE, TRUE);
        WLD_SENDTRIGGER("KM_KQ402_CHEST_01_RUST");
        WLD_SENDTRIGGER("KM_KQ402_CHEST_02_RUST");
        WLD_SENDTRIGGER("KM_KQ402_CHEST_03_RUST");
        WLD_SENDTRIGGER("KM_KQ402_CHEST_04_RUST");
        WLD_SENDTRIGGER("KM_KQ402_CHEST_05_RUST");
        KQ402_CHANGEWOODCHESTS_APPLY_COLLISION = 1;
        if ((KQ402_LEAVEGUILD_MOVER_02) == (TRUE)) {
            KQ402_LEAVEGUILD_MOVER_02 = FALSE;
        };
    };
    if (((((((((((MOVER1.MOVERSTATE) != (MOVER_STATE_OPENING)) && ((MOVER1.MOVERSTATE) != (MOVER_STATE_CLOSING))) && ((MOVER2.MOVERSTATE) != (MOVER_STATE_OPENING))) && ((MOVER2.MOVERSTATE) != (MOVER_STATE_CLOSING))) && ((MOVER3.MOVERSTATE) != (MOVER_STATE_OPENING))) && ((MOVER3.MOVERSTATE) != (MOVER_STATE_CLOSING))) && ((MOVER4.MOVERSTATE) != (MOVER_STATE_OPENING))) && ((MOVER4.MOVERSTATE) != (MOVER_STATE_CLOSING))) && ((MOVER5.MOVERSTATE) != (MOVER_STATE_OPENING))) && ((MOVER5.MOVERSTATE) != (MOVER_STATE_CLOSING))) {
        PRINTD("Skoñczy³em - KQ402_ChangeWoodChests_Apply");
        CHANGEVOBCOLLISION("KQ402_CHEST_01_RUST", TRUE, TRUE, TRUE, TRUE);
        CHANGEVOBCOLLISION("KQ402_CHEST_02_RUST", TRUE, TRUE, TRUE, TRUE);
        CHANGEVOBCOLLISION("KQ402_CHEST_03_RUST", TRUE, TRUE, TRUE, TRUE);
        CHANGEVOBCOLLISION("KQ402_CHEST_04_RUST", TRUE, TRUE, TRUE, TRUE);
        CHANGEVOBCOLLISION("KQ402_CHEST_05_RUST", TRUE, TRUE, TRUE, TRUE);
        FF_REMOVE(0xf1ee);
        KQ402_CHANGEWOODCHESTS_APPLY_COLLISION = 0;
        if ((KQ402_LEAVEGUILD_MOVER_02) == (FALSE)) {
            KQ402_LEAVEGUILD_MOVER_02 = TRUE;
        };
    };
}

var int KQ402_CHANGEWOODCHESTS_APPLY.KQ402_CHANGEWOODCHESTS_APPLY_COLLISION = 0;
instance KQ402_CHANGEWOODCHESTS_APPLY.MOVER1(ZCMOVER)
instance KQ402_CHANGEWOODCHESTS_APPLY.MOVER2(ZCMOVER)
instance KQ402_CHANGEWOODCHESTS_APPLY.MOVER3(ZCMOVER)
instance KQ402_CHANGEWOODCHESTS_APPLY.MOVER4(ZCMOVER)
instance KQ402_CHANGEWOODCHESTS_APPLY.MOVER5(ZCMOVER)
var int KQ402_CHANGEWOODCHESTS_APPLY.MOVPTR1 = 0;
var int KQ402_CHANGEWOODCHESTS_APPLY.MOVPTR2 = 0;
var int KQ402_CHANGEWOODCHESTS_APPLY.MOVPTR3 = 0;
var int KQ402_CHANGEWOODCHESTS_APPLY.MOVPTR4 = 0;
var int KQ402_CHANGEWOODCHESTS_APPLY.MOVPTR5 = 0;
func void KQ402_UGLYARMOR_SHOW() {
    ITM = NPC_GETEQUIPPEDARMOR(OTHER);
    if (((NPC_HASEQUIPPEDARMOR(OTHER)) == (TRUE)) && ((HLP_ISITEM(ITM, 0x91cc)) == (TRUE))) {
        AI_PLAYANI(OTHER, "T_STAND_2_KILLME");
    };
    B_GIVEINVITEMS(OTHER, SELF, 0x91cc, 1);
    AI_REMOVEWEAPON(SELF);
    CREATEINVITEM(SELF, 0x8cf9);
    B_STOPLOOKAT(SELF);
    AI_USEITEMTOSTATE(SELF, 0x8cf9, 1);
}

instance KQ402_UGLYARMOR_SHOW.ITM(C_ITEM)
func void KQ402_UGLYARMOR_HIDE() {
    ITM = NPC_GETEQUIPPEDARMOR(OTHER);
    if (((NPC_HASEQUIPPEDARMOR(OTHER)) == (TRUE)) && ((HLP_ISITEM(ITM, 0x91cc)) == (TRUE))) {
        AI_PLAYANI(OTHER, "T_REMOVE_KILLME");
    };
    B_GIVEINVITEMS(SELF, OTHER, 0x91cc, 1);
    AI_USEITEMTOSTATE(SELF, 0x8cf9, -(1));
}

instance KQ402_UGLYARMOR_HIDE.ITM(C_ITEM)
func void KQ402_BRINKARWIDLENNARTBACK() {
    PRINTD("Arwid i Lennart wrócili");
    B_STARTOTHERROUTINE(NONE_2009_LENNART, START);
    B_STARTOTHERROUTINE(MIL_4017_ARWID, "KQ402_FINAL");
    KQ402_ARWID_RTNCHECK = 2;
    KQ402_RODERICH_RTNCHECK = 2;
    NPC_EXCHANGEROUTINE(MIL_4000_RODERICH, "KQ402_FINAL");
    B_REMOVENPC(0xccbc);
    B_REMOVEALLINVENTORY(NONE_2009_LENNART_KQ402);
    B_STARTOTHERROUTINE(NONE_2009_LENNART_KQ402, RESERVED_CONST_STRING_24);
    TELEPORTNPCTOWP(0xcf10, NONE_2009_LENNART_KQ402.WP);
    B_REMOVENPC(0xcf10);
}

func void KQ402_FINISHQUEST() {
    KQ402_FINISH = TRUE;
    KQ402_FINISH_DAY = WLD_GETDAY();
    if ((LOG_GETSTATUS(MIS_KQ402)) == (LOG_RUNNING)) {
        LOG_SETSTATUS(_@(MIS_KQ402), TOPIC_KQ402, LOG_SUCCESS);
    };
    RESTOREROUTINE_RODERICH();
    RESTOREROUTINE_ARWID();
    KQ404_PREPAREHOUSE();
    KQ404_SPAWNNPC();
}

func void KQ402_CHECKCHEST() {
    KQ402_ENOUGHPOTIONS_COUNT = (KQ402_ENOUGHPOTIONS_COUNT) + (1);
    if (((KQ402_ENOUGHPOTIONS_COUNT) == (1)) && ((KQ402_FIRSTBOXENTRY) == (FALSE))) {
        B_LOGENTRY(TOPIC_KQ402, LOG_KQ402_STORAGE_FIRST);
        KQ402_FIRSTBOXENTRY = TRUE;
    };
    if ((KQ402_ENOUGHPOTIONS_COUNT) == (5)) {
        B_SAY(HERO, HERO, "$MARVIN_Done");
        B_LOGENTRY(TOPIC_KQ402, LOG_KQ402_STORAGE_DONE);
    };
    RND = HLP_RANDOM(3);
    if ((RND) == (0)) {
        B_SAY(HERO, HERO, "$MARVIN_Yes");
    };
    if ((RND) == (1)) {
        B_SAY(HERO, HERO, "$MARVIN_ThinkingEmoji");
    };
    if ((RND) == (2)) {
        B_SAY(HERO, HERO, "$MARVIN_AllClear");
    };
    B_GIVEPLAYERXP(XP_Q501_BOOKSHELF);
}

var int KQ402_CHECKCHEST.RND = 0;
