const int SPRITEMAP_SIZE = 512;
const int SPRITEMAP_POSX = 0;
const int SPRITEMAP_POSY = 0;
const int SPRITEMAP_TEXSIZE = 512;
const string SPRITEMAP_ARROW = "L.tga";
const string SPRITEMAP_MARKER = "U.tga";
var int SPRITEMAP_SPRITEHNDL = 0;
var int SPRITEMAP_SPRITECURSORHNDL = 0;
var int SPRITEMAP_SPRITEMARKERHNDL = 0;
var int SPRITEMAP_MINXF = 0;
var int SPRITEMAP_MINYF = 0;
var int SPRITEMAP_DISTXF = 0;
var int SPRITEMAP_DISTYF = 0;
var int SPRITEMAP_SIZEF = 0;
var int SPRITEMAP_UVDISTF = 0;
var int SPRITEMAP_UVDISTHALFF = 0;
var int SPRITEMAP_MARKERS = 0;
var int SPRITEMAP_POSXF = 0;
var int SPRITEMAP_POSYF = 0;
var int SPRITEMAP_MAXXF = 0;
var int SPRITEMAP_MAXYF = 0;
var int SPRITEMAP_ROTATE90 = 0;
func void SPRITEMAP_DESTROY() {
    FF_REMOVE(0x5524);
    if (SPRITEMAP_SPRITEHNDL) {
        DELETE(SPRITEMAP_SPRITEHNDL);
        SPRITEMAP_SPRITEHNDL = 0;
    };
    if (SPRITEMAP_SPRITECURSORHNDL) {
        DELETE(SPRITEMAP_SPRITECURSORHNDL);
        SPRITEMAP_SPRITECURSORHNDL = 0;
    };
}

func void SPRITEMAP_CREATE(var string MAPTEX, var int SHOWCURSOR) {
    SPRITEMAP_SPRITEHNDL = SPRITE_CREATEPXL(SPRITEMAP_POSX, SPRITEMAP_POSY, SPRITEMAP_SIZE, SPRITEMAP_SIZE, COL_WHITE, MAPTEX);
    SPRITE_SETUV(SPRITEMAP_SPRITEHNDL, FLOATNULL, FLOATNULL, FLOATEINS, FLOATEINS);
    if (SHOWCURSOR) {
        SPRITEMAP_SPRITECURSORHNDL = SPRITE_CREATEPXL(0, 0, 16, 16, COL_WHITE, SPRITEMAP_ARROW);
        SPRITE_SETPRIO(SPRITEMAP_SPRITECURSORHNDL, 100);
    };
    FF_APPLYONCE(0x5524);
}

func void SPRITEMAP_INIT(var int MINX, var int MAXY, var int MAXX, var int MINY, var string MAPTEX, var int ROTATE90, var int CURRENTLEVEL, var int MAPLEVEL) {
    SPRITEMAP_DESTROY();
    PRINT_GETSCREENSIZE();
    SPRITEMAP_POSX = (PRINT_SCREEN[0]) / (2);
    SPRITEMAP_POSY = (PRINT_SCREEN[1]) / (2);
    SPRITEMAP_SIZE = PRINT_SCREEN[1];
    SPRITEMAP_MINXF = MKF(MINX);
    SPRITEMAP_MINYF = MKF(MINY);
    SPRITEMAP_DISTXF = MKF((MAXX) - (MINX));
    SPRITEMAP_DISTYF = MKF((MAXY) - (MINY));
    SPRITEMAP_SIZEF = MKF(SPRITEMAP_SIZE);
    SPRITEMAP_POSXF = MKF(SPRITEMAP_POSX);
    SPRITEMAP_POSYF = MKF(SPRITEMAP_POSY);
    SPRITEMAP_MAXXF = ADDF(SPRITEMAP_POSX, SPRITEMAP_SIZEF);
    SPRITEMAP_MAXYF = ADDF(SPRITEMAP_POSY, SPRITEMAP_SIZEF);
    SPRITEMAP_UVDISTF = MULF(FRACF(1, SPRITEMAP_TEXSIZE), SPRITEMAP_SIZEF);
    SPRITEMAP_UVDISTHALFF = DIVF(SPRITEMAP_UVDISTF, MKF(2));
    SPRITEMAP_ROTATE90 = ROTATE90;
    SHOWCURSOR = ((MINX) != (0)) && ((CURRENTLEVEL) == (MAPLEVEL));
    SPRITEMAP_CREATE(MAPTEX, SHOWCURSOR);
}

var int SPRITEMAP_INIT.SHOWCURSOR = 0;
func void _SPRITEMAP_SETSPRITEPOSITION(var int SPRITE, var int POSX, var int POSY) {
    POSX = DIVF(SUBF(POSX, SPRITEMAP_MINXF), SPRITEMAP_DISTXF);
    POSY = SUBF(FLOATEINS, DIVF(SUBF(POSY, SPRITEMAP_MINYF), SPRITEMAP_DISTYF));
    if (LF(POSX, FLOATNULL)) {
        POSX = FLOATNULL;
    };
    if (GF(POSX, FLOATEINS)) {
        POSX = FLOATEINS;
    };
    if (LF(POSY, FLOATNULL)) {
        POSY = FLOATNULL;
    };
    if (GF(POSY, FLOATEINS)) {
        POSY = FLOATEINS;
    };
    POSX = MULF(POSX, SPRITEMAP_SIZEF);
    POSY = MULF(POSY, SPRITEMAP_SIZEF);
    if (SPRITEMAP_ROTATE90) {
        POSY = SUBF(SPRITEMAP_SIZE, POSY);
        SPRITE_SETPOSPXLF(SPRITE, ADDF(MKF((SPRITEMAP_POSX) + ((SPRITEMAP_SIZE) / (2))), POSY), ADDF(MKF((SPRITEMAP_POSY) - ((SPRITEMAP_SIZE) / (2))), POSX));
    };
    SPRITE_SETPOSPXLF(SPRITE, ADDF(MKF((SPRITEMAP_POSX) - ((SPRITEMAP_SIZE) / (2))), POSX), ADDF(MKF((SPRITEMAP_POSY) - ((SPRITEMAP_SIZE) / (2))), POSY));
}

func void SPRITEMAP_LOOP() {
    if ((((((((MEM_KEYSTATE(KEY_ESCAPE)) == (KEY_PRESSED)) || ((MEM_KEYSTATE(KEY_RETURN)) == (KEY_PRESSED))) || ((MEM_KEYSTATE(MOUSE_BUTTONRIGHT)) == (KEY_PRESSED))) || ((MEM_KEYSTATE(MEM_GETKEY("keyInventory"))) == (KEY_PRESSED))) || ((MEM_KEYSTATE(MEM_GETSECONDARYKEY("keyInventory"))) == (KEY_PRESSED))) || ((MEM_KEYSTATE(MEM_GETKEY("keyShowMap"))) == (KEY_PRESSED))) || ((MEM_KEYSTATE(MEM_GETSECONDARYKEY("keyShowMap"))) == (KEY_PRESSED))) {
        MEM_ARRAYREMOVEVALUEONCE(MEMINT_KEYBUFFER_OFFSET, KEY_ESCAPE);
        SPRITEMAP_DESTROY();
        return;
    };
    if (SPRITEMAP_SPRITECURSORHNDL) {
        HER = HLP_GETNPC(0x71b);
        SPRITE_SETROTATIONSC(SPRITEMAP_SPRITECURSORHNDL, HER.TRAFOOBJTOWORLD[0], HER.TRAFOOBJTOWORLD[8]);
        if (SPRITEMAP_ROTATE90) {
            SPRITE_ROTATE(SPRITEMAP_SPRITECURSORHNDL, 90);
        };
        _SPRITEMAP_SETSPRITEPOSITION(SPRITEMAP_SPRITECURSORHNDL, HER.TRAFOOBJTOWORLD[3], HER.TRAFOOBJTOWORLD[11]);
    };
}

instance SPRITEMAP_LOOP.HER(ZCVOB)
