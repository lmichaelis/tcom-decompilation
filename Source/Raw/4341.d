instance DIA_TRIMEGISTO_Q602_EXIT(C_INFO) {
    NPC = 0xe8ed;
    NR = 999;
    CONDITION = DIA_TRIMEGISTO_Q602_EXIT_CONDITION;
    INFORMATION = DIA_TRIMEGISTO_Q602_EXIT_INFO;
    PERMANENT = TRUE;
    DESCRIPTION = DIALOG_ENDE;
}

func int DIA_TRIMEGISTO_Q602_EXIT_CONDITION() {
    return TRUE;
}

func void DIA_TRIMEGISTO_Q602_EXIT_INFO() {
    AI_STOPPROCESSINFOS(SELF);
}

instance DIA_TRIMEGISTO_Q602_DEATH(C_INFO) {
    NPC = 0xe8ed;
    NR = 1;
    CONDITION = DIA_TRIMEGISTO_Q602_DEATH_CONDITION;
    INFORMATION = DIA_TRIMEGISTO_Q602_DEATH_INFO;
    PERMANENT = FALSE;
    IMPORTANT = TRUE;
}

func int DIA_TRIMEGISTO_Q602_DEATH_CONDITION() {
    if ((LOG_GETSTATUS(MIS_Q602)) == (LOG_RUNNING)) {
        return TRUE;
    };
    return 0 /* !broken stack! */;
}

func void DIA_TRIMEGISTO_Q602_DEATH_INFO() {
    KDF_6404_TRIMEGISTO_Q602.NPCTYPE = NPCTYPE_MAIN;
    KDF_6404_TRIMEGISTO_Q602.FLAGS = 0;
    AI_STARTFACEANI(SELF, S_SAD, 1, -(1));
    AI_OUTPUT(SELF, OTHER, "DIA_Trimegisto_Q602_Death_03_01");
    INFO_CLEARCHOICES(0x16026);
    INFO_ADDCHOICE(0x16026, "What are you talking about?", 0x1602a);
    INFO_ADDCHOICE(0x16026, "Purified?", 0x1602d);
}

func void DIA_TRIMEGISTO_Q602_DEATH_ADDCHOICE() {
    INFO_ADDCHOICE(0x16026, "In that case, I won't bother you.", 0x1602c);
}

func void DIA_TRIMEGISTO_Q602_DEATH_NO() {
    AI_STARTFACEANI(SELF, S_ANGRY, 1, -(1));
    AI_STARTFACEANI(OTHER, S_ANGRY, 1, -(1));
    AI_OUTPUT(OTHER, SELF, "DIA_Trimegisto_Q602_Death_No_15_01");
    AI_OUTPUT(SELF, OTHER, "DIA_Trimegisto_Q602_Death_No_03_02");
    AI_OUTPUT(SELF, OTHER, "DIA_Trimegisto_Q602_Death_No_03_03");
    INFO_CLEARCHOICES(0x16026);
    INFO_ADDCHOICE(0x16026, "These people need to be escorted to safety immediately!", 0x1602b);
    DIA_TRIMEGISTO_Q602_DEATH_ADDCHOICE();
}

func void DIA_TRIMEGISTO_Q602_DEATH_NO_NOV2() {
    AI_STARTFACEANI(SELF, "S_HOSTILE", 1, -(1));
    AI_RESETFACEANI(OTHER);
    AI_OUTPUT(OTHER, SELF, "DIA_Trimegisto_Q602_Death_NoV2_15_01");
    AI_OUTPUT(SELF, OTHER, "DIA_Trimegisto_Q602_Death_NoV2_03_03");
    INFO_CLEARCHOICES(0x16026);
    AI_STOPPROCESSINFOS(SELF);
    AI_FUNCTION(SELF, 0x16031);
}

func void DIA_TRIMEGISTO_Q602_DEATH_NO_LEAVE() {
    Q602_TRIMEGISTO_CUTSCENEENABLE = 3;
    AI_STARTFACEANI(SELF, S_SAD, 1, -(1));
    AI_RESETFACEANI(OTHER);
    AI_OUTPUT(OTHER, SELF, "DIA_Trimegisto_Q602_Death_Leave_15_01");
    AI_WAITTILLEND(SELF, OTHER);
    AI_TURNTONPC(SELF, VLK_6300_GROEN_Q602);
    AI_OUTPUT(SELF, OTHER, "DIA_Trimegisto_Q602_Death_Leave_03_02");
    INFO_CLEARCHOICES(0x16026);
    AI_STOPPROCESSINFOS(SELF);
}

func void DIA_TRIMEGISTO_Q602_DEATH_PURE() {
    AI_STARTFACEANI(OTHER, S_WHAT, 1, -(1));
    AI_OUTPUT(OTHER, SELF, "DIA_Trimegisto_Q602_Death_Pure_15_01");
    AI_OUTPUT(SELF, OTHER, "DIA_Trimegisto_Q602_Death_Pure_03_02");
    AI_OUTPUT(SELF, OTHER, "DIA_Trimegisto_Q602_Death_Pure_03_03");
    INFO_CLEARCHOICES(0x16026);
    DIA_TRIMEGISTO_Q602_DEATH_ADDCHOICE();
    INFO_ADDCHOICE(0x16026, "I can't let you do that.", 0x1602f);
    INFO_ADDCHOICE(0x16026, "Tengral survived, maybe you should talk to him.", 0x1602e);
    if ((NPC_HASITEMS(OTHER, 0x8787)) >= (1)) {
        INFO_ADDCHOICE(0x16026, "(Distract and put to sleep)", 0x16030);
    };
}

func void DIA_TRIMEGISTO_Q602_DEATH_PURE_TENGRAL() {
    AI_RESETFACEANI(OTHER);
    AI_OUTPUT(OTHER, SELF, "DIA_Trimegisto_Q602_Death_Tengral_15_01");
    AI_OUTPUT(SELF, OTHER, "DIA_Trimegisto_Q602_Death_Tengral_03_02");
}

func void DIA_TRIMEGISTO_Q602_DEATH_PURE_FIGHT() {
    KDF_6404_TRIMEGISTO_Q602.AIVAR[15] = FALSE;
    AI_STARTFACEANI(OTHER, S_ANGRY, 1, -(1));
    Q602_TRIMEGISTO_FIGHT = 1;
    AI_OUTPUT(OTHER, SELF, "DIA_Trimegisto_Q602_Death_Fight_15_01");
    AI_OUTPUT(SELF, OTHER, "DIA_Trimegisto_Q602_Death_Fight_03_02");
    INFO_CLEARCHOICES(0x16026);
    AI_STOPPROCESSINFOS(SELF);
    B_ATTACK(SELF, OTHER, AR_KILL, 1);
    AI_RESETFACEANI(OTHER);
}

func void DIA_TRIMEGISTO_Q602_DEATH_PURE_SLEEP() {
    AI_RESETFACEANI(OTHER);
    AI_STARTFACEANI(SELF, S_THINK, 1, -(1));
    AI_OUTPUT(OTHER, SELF, "DIA_Trimegisto_Q602_Death_Sleep_15_01");
    AI_TURNAWAY(SELF, OTHER);
    B_READYSPELL(OTHER, SPL_SLEEP, SPL_COST_SCROLL);
    AI_PLAYANI(OTHER, "T_MAGRUN_2_SLESHOOT");
    AI_FUNCTION(OTHER, 0x16032);
    AI_PLAYANI(OTHER, "T_SLESHOOT_2_STAND");
    AI_UNREADYSPELL(OTHER);
    AI_OUTPUT(SELF, OTHER, "DIA_Trimegisto_Q602_Death_Sleep_03_02");
    AI_WAITTILLEND(SELF, OTHER);
    INFO_CLEARCHOICES(0x16026);
    AI_STOPPROCESSINFOS(SELF);
    AI_FUNCTION(SELF, 0x16033);
}

func void TRIMEGISTO_Q602_FIRERING() {
    Q602_TRIMEGISTO_CUTSCENEENABLE = 1;
}

func void TRIMEGISTO_Q602_SLEEP_EFFECT() {
    WLD_PLAYEFFECT("FX_SLEEP_ORIGIN", HERO, HERO, 0, 0, 0, FALSE);
    WLD_PLAYEFFECT("FX_SLEEP_TARGET", KDF_6404_TRIMEGISTO_Q602, KDF_6404_TRIMEGISTO_Q602, 0, 0, 0, FALSE);
    SND_PLAY("MFX_Sleep_Cast");
}

func void TRIMEGISTO_Q602_SLEEP() {
    Q602_TELEPORTTENGRAL = 1;
    Q602_TRIMEGISTO_FINISHWAY = 2;
    NPC_EXCHANGEROUTINE(KDF_6404_TRIMEGISTO_Q602, "Q602_SLEEP");
    NPC_REMOVEINVITEMS(HERO, 0x8787, 1);
    HERO.ATTRIBUTE[2] = (HERO.ATTRIBUTE[2]) - (5);
}

