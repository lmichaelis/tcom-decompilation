instance Q308_TOTHEOLDTOWN(CUTSCENE) {
    ONSTART = FUNCTION(0x169a9);
}

func void Q308_TOTHEOLDTOWN_START() {
    MIL_4000_RODERICH.AIVAR[5] = TRUE;
    Q308_REMOVECITIZENSOLDCITY();
    B_STARTOTHERROUTINE(VLK_6388_MORRIS, "Q308");
    NPC_REFRESH(VLK_6388_MORRIS);
    TELEPORTNPCTOWP(0xd22c, VLK_6388_MORRIS.WP);
    HERO.AIVAR[4] = TRUE;
    Q308_TOTHEOLDTOWN_EVENTS = 1;
    FF_APPLYONCEEXT(0x169aa, 0x5dc, 20);
    WLD_SENDTRIGGER("Q308_TOWN_01");
    FADESCREENFROMBLACK(2);
    if ((HERO.GUILD) == (GIL_MIL)) {
        Q308_LORENZO_RTNCHECK = 1;
        NPC_EXCHANGEROUTINE(SLD_5000_LORENZO, "Q308");
    };
    if ((HERO.GUILD) == (GIL_SLD)) {
        Q308_RODERICH_RTNCHECK = 1;
        NPC_EXCHANGEROUTINE(MIL_4000_RODERICH, "Q308");
    };
    TELEPORTNPCTOWP(0x71b, "PARTM5_PATH_105");
    TELEPORTNPCTOWP(0xce47, MIL_4000_RODERICH.WP);
    TELEPORTNPCTOWP(0xcb64, SLD_5000_LORENZO.WP);
    SLD_5000_LORENZO.AIVAR[92] = TRUE;
    MIL_4000_RODERICH.AIVAR[92] = TRUE;
}

func void Q308_TOTHEOLDTOWN_APPLY() {
    Q308_TOTHEOLDTOWN_COUNT = (Q308_TOTHEOLDTOWN_COUNT) + (1);
    if ((Q308_TOTHEOLDTOWN_COUNT) == (3)) {
        WLD_SENDTRIGGER("Q308_TOWN_02_A");
        WLD_SENDUNTRIGGER("Q308_TOWN_01");
    };
    if ((Q308_TOTHEOLDTOWN_COUNT) == (8)) {
        WLD_SENDTRIGGER("Q308_TOWN_03");
        WLD_SENDUNTRIGGER("Q308_TOWN_02_A");
    };
    if ((Q308_TOTHEOLDTOWN_COUNT) == (12)) {
        Q308_TOTHEOLDTOWN_EVENTS = 2;
        TELEPORTNPCTOWP(0x71b, "PARTM5_CITYHALL_02");
        if ((HERO.GUILD) == (GIL_MIL)) {
            TELEPORTNPCTOWP(0xce47, "PARTM5_CITYHALL_03");
        } else if ((HERO.GUILD) == (GIL_SLD)) {
            TELEPORTNPCTOWP(0xcb64, "PARTM5_CITYHALL_03");
        };
    };
    if ((Q308_TOTHEOLDTOWN_COUNT) == (13)) {
        WLD_SENDTRIGGER("Q308_TOWN_04");
        WLD_SENDUNTRIGGER("Q308_TOWN_03");
    };
    if ((Q308_TOTHEOLDTOWN_COUNT) == (17)) {
        WLD_SENDTRIGGER("Q308_TOWN_05");
        WLD_SENDUNTRIGGER("Q308_TOWN_04");
        TELEPORTNPCTOWP(0x71b, "PARTM5_CITYHALL_19");
        NPC_CLEARAIQUEUE(HERO);
        if ((HERO.GUILD) == (GIL_MIL)) {
            TELEPORTNPCTOWP(0xce47, MIL_4000_RODERICH.WP);
            NPC_CLEARAIQUEUE(MIL_4000_RODERICH);
        } else if ((HERO.GUILD) == (GIL_SLD)) {
            TELEPORTNPCTOWP(0xcb64, SLD_5000_LORENZO.WP);
            NPC_CLEARAIQUEUE(SLD_5000_LORENZO);
        };
        TELEPORTNPCTOWP(0xd243, VLK_6503_GOLAR.WP);
        TELEPORTNPCTOWP(0xd23d, VLK_6454_DANIS.WP);
    };
    if ((Q308_TOTHEOLDTOWN_COUNT) == (20)) {
        FF_APPLYONCEEXT(0x169ac, 75, 4);
    };
}

var int Q308_TOTHEOLDTOWN_APPLY.Q308_TOTHEOLDTOWN_COUNT = 0;
func void Q308_TOTHEOLDTOWN_END() {
    Q308_TOTHEOLDTOWN_END_COUNT = (Q308_TOTHEOLDTOWN_END_COUNT) + (1);
    if ((Q308_TOTHEOLDTOWN_END_COUNT) == (4)) {
        Q308_TOTHEOLDTOWN_END_COUNT = 0;
        Q308_TOTHEOLDTOWN_EVENTS = 4;
        SLD_5000_LORENZO.AIVAR[92] = FALSE;
        MIL_4000_RODERICH.AIVAR[92] = FALSE;
        WLD_SENDUNTRIGGER("Q308_TOWN_01");
        WLD_SENDUNTRIGGER("Q308_TOWN_02_A");
        WLD_SENDUNTRIGGER("Q308_TOWN_03");
        WLD_SENDUNTRIGGER("Q308_TOWN_04");
        WLD_SENDUNTRIGGER("Q308_TOWN_05");
        NPC_CLEARAIQUEUE(MIL_4000_RODERICH);
        NPC_CLEARAIQUEUE(SLD_5000_LORENZO);
        NPC_CLEARAIQUEUE(VLK_6503_GOLAR);
        NPC_CLEARAIQUEUE(VLK_6454_DANIS);
        NPC_CLEARAIQUEUE(VLK_6388_MORRIS);
        AI_TURNTONPC(HERO, MIL_4000_RODERICH);
        HERO.AIVAR[4] = FALSE;
    };
}

var int Q308_TOTHEOLDTOWN_END.Q308_TOTHEOLDTOWN_END_COUNT = 0;
