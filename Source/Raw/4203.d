var int LENA_SQ316_FIRSTLOG = 0;
func void SQ316_PREPARECORTEZ() {
    B_STARTOTHERROUTINE(PIR_1303_CORTEZ, "SQ316");
    SQ316_CORTEZ_RTNCHECK = 1;
    NPC_REFRESH(PIR_1303_CORTEZ);
    TELEPORTNPCTOWP(0xe514, PIR_1303_CORTEZ.WP);
    HERO.AIVAR[4] = FALSE;
}

instance DIA_LENA_EXIT(C_INFO) {
    NPC = 0xe5d3;
    NR = 999;
    CONDITION = DIA_LENA_EXIT_CONDITION;
    INFORMATION = DIA_LENA_EXIT_INFO;
    PERMANENT = TRUE;
    DESCRIPTION = DIALOG_ENDE;
}

func int DIA_LENA_EXIT_CONDITION() {
    return TRUE;
}

func void DIA_LENA_EXIT_INFO() {
    AI_STOPPROCESSINFOS(SELF);
}

instance DIA_LENA_HELPME(C_INFO) {
    NPC = 0xe5d3;
    NR = 1;
    CONDITION = DIA_LENA_HELPME_CONDITION;
    INFORMATION = DIA_LENA_HELPME_INFO;
    IMPORTANT = TRUE;
}

func int DIA_LENA_HELPME_CONDITION() {
    if ((SQ316_CANUSELEVER) == (FALSE)) {
        if (NPC_ISINSTATE(SELF, 0xf09f)) {
            if ((SQ507_STARTINGPOINT) == (0)) {
                return TRUE;
            };
        };
    };
    return 0 /* !broken stack! */;
}

func void DIA_LENA_HELPME_INFO() {
    MDL_STARTFACEANI(SELF, S_FRIGHTENED, 0x3f800000, -1082130432);
    AI_OUTPUT(SELF, OTHER, "DIA_Lena_Helpme_16_01");
    if ((LOG_GETSTATUS(MIS_SQ316)) == (LOG_RUNNING)) {
        if ((LENA_SQ316_FIRSTLOG) == (FALSE)) {
            AI_LOGENTRY(TOPIC_SQ316, LOG_SQ316_FRIGHTENEDGIRL);
            LENA_SQ316_FIRSTLOG = TRUE;
        };
    };
}

instance DIA_LENA_SQ316_YOUAREFREE(C_INFO) {
    NPC = 0xe5d3;
    NR = 1;
    CONDITION = DIA_LENA_SQ316_YOUAREFREE_CONDITION;
    INFORMATION = DIA_LENA_SQ316_YOUAREFREE_INFO;
    PERMANENT = FALSE;
    DESCRIPTION = "You're free.";
}

func int DIA_LENA_SQ316_YOUAREFREE_CONDITION() {
    if ((SQ316_CANUSELEVER) == (TRUE)) {
        if ((SQ507_STARTINGPOINT) == (0)) {
            return TRUE;
        };
    };
    return 0 /* !broken stack! */;
}

func void DIA_LENA_SQ316_YOUAREFREE_INFO() {
    AI_OUTPUT(OTHER, SELF, "DIA_Lena_SQ316_YouAreFree_15_01");
    AI_OUTPUT(SELF, OTHER, "DIA_Lena_SQ316_YouAreFree_03_02");
    AI_OUTPUT(OTHER, SELF, "DIA_Lena_SQ316_YouAreFree_15_03");
    AI_OUTPUT(SELF, OTHER, "DIA_Lena_SQ316_YouAreFree_03_04");
    AI_OUTPUT(SELF, OTHER, "DIA_Lena_SQ316_YouAreFree_03_05");
    AI_LOGENTRY(TOPIC_SQ316, LOG_SQ316_LENAISHURT);
    NPC_EXCHANGEROUTINE(SELF, FOLLOW);
    AI_FUNCTION(SELF, 0x14cdd);
    AI_STOPPROCESSINFOS(SELF);
}

instance DIA_LENA_SQ316_IMUSTSTAY(C_INFO) {
    NPC = 0xe5d3;
    NR = 1;
    CONDITION = DIA_LENA_SQ316_IMUSTSTAY_CONDITION;
    INFORMATION = DIA_LENA_SQ316_IMUSTSTAY_INFO;
    PERMANENT = FALSE;
    IMPORTANT = TRUE;
}

func int DIA_LENA_SQ316_IMUSTSTAY_CONDITION() {
    if (NPC_KNOWSINFO(OTHER, 0x14791)) {
        if ((SQ507_STARTINGPOINT) == (0)) {
            return TRUE;
        };
    };
    return 0 /* !broken stack! */;
}

func void DIA_LENA_SQ316_IMUSTSTAY_INFO() {
    AI_OUTPUT(SELF, OTHER, "DIA_Lena_SQ316_IMustStay_03_01");
    INFO_CLEARCHOICES(0x14ce7);
    INFO_ADDCHOICE(0x14ce7, "There must be some way to get you out of here...", 0x14cea);
}

func void DIA_LENA_SQ316_WAYTOGETYOUOUT() {
    AI_OUTPUT(OTHER, SELF, "DIA_Lena_SQ316_WayToGetYouOut_15_01");
    AI_OUTPUT(SELF, OTHER, "DIA_Lena_SQ316_WayToGetYouOut_03_02");
    AI_OUTPUT(SELF, OTHER, "DIA_Lena_SQ316_WayToGetYouOut_03_03");
    AI_OUTPUT(SELF, OTHER, "DIA_Lena_SQ316_WayToGetYouOut_03_04");
    AI_OUTPUT(SELF, OTHER, "DIA_Lena_SQ316_WayToGetYouOut_03_05");
    AI_OUTPUT(OTHER, SELF, "DIA_Lena_SQ316_WayToGetYouOut_15_06");
    CREATEINVITEMS(SELF, 0x894d, 1);
    B_GIVEINVITEMS(SELF, OTHER, 0x894d, 1);
    NPC_EXCHANGEROUTINE(SELF, "AFTERQUEST");
    AI_LOGENTRY(TOPIC_SQ316, LOG_SQ316_LENAISSAVE);
    AI_STOPPROCESSINFOS(SELF);
}

instance DIA_LENA_SQ507_ASSAULTINCOMING(C_INFO) {
    NPC = 0xe5d3;
    NR = 1;
    CONDITION = DIA_LENA_SQ507_ASSAULTINCOMING_CONDITION;
    INFORMATION = DIA_LENA_SQ507_ASSAULTINCOMING_INFO;
    PERMANENT = TRUE;
    IMPORTANT = TRUE;
}

func int DIA_LENA_SQ507_ASSAULTINCOMING_CONDITION() {
    if ((SQ507_STARTINGPOINT) != (0)) {
        if (!(NPC_ISDEAD(PIR_1303_CORTEZ))) {
            return TRUE;
        };
    };
    return 0 /* !broken stack! */;
}

func void DIA_LENA_SQ507_ASSAULTINCOMING_INFO() {
    AI_OUTPUT(SELF, OTHER, "DIA_Lena_SQ507_AssaultIncoming_03_01");
    AI_STOPPROCESSINFOS(SELF);
}

instance DIA_LENA_SQ507_STARTINGPOINT(C_INFO) {
    NPC = 0xe5d3;
    NR = 2;
    CONDITION = DIA_LENA_SQ507_STARTINGPOINT_CONDITION;
    INFORMATION = DIA_LENA_SQ507_STARTINGPOINT_INFO;
    PERMANENT = FALSE;
    IMPORTANT = TRUE;
}

func int DIA_LENA_SQ507_STARTINGPOINT_CONDITION() {
    if ((SQ507_STARTINGPOINT) != (0)) {
        if (NPC_ISDEAD(PIR_1303_CORTEZ)) {
            return TRUE;
        };
    };
    return 0 /* !broken stack! */;
}

func void DIA_LENA_SQ507_STARTINGPOINT_INFO() {
    AI_OUTPUT(SELF, OTHER, "DIA_Lena_SQ507_StartingPoint_03_01");
}

instance DIA_LENA_SQ507_CORTEZISDEAD(C_INFO) {
    NPC = 0xe5d3;
    NR = 3;
    CONDITION = DIA_LENA_SQ507_CORTEZISDEAD_CONDITION;
    INFORMATION = DIA_LENA_SQ507_CORTEZISDEAD_INFO;
    PERMANENT = FALSE;
    DESCRIPTION = "Yes, Cortez is dead. This is the end of the Haven.";
}

func int DIA_LENA_SQ507_CORTEZISDEAD_CONDITION() {
    if (NPC_KNOWSINFO(OTHER, 0x14cee)) {
        return TRUE;
    };
    return 0 /* !broken stack! */;
}

func void DIA_LENA_SQ507_CORTEZISDEAD_INFO() {
    AI_OUTPUT(OTHER, SELF, "DIA_Lena_SQ507_CortezIsDead_15_01");
    if ((SQ507_STARTINGPOINT) == (1)) {
        AI_OUTPUT(OTHER, SELF, "DIA_Lena_SQ507_CortezIsDead_15_02");
        AI_OUTPUT(SELF, OTHER, "DIA_Lena_SQ507_CortezIsDead_03_03");
    };
    if ((SQ507_STARTINGPOINT) == (3)) {
        VLK_6126_LENA.NAME[0] = NPCNAME_LENA;
        VLK_6126_LENA.AIVAR[79] = 1;
        AI_OUTPUT(OTHER, SELF, "DIA_Lena_SQ507_CortezIsDead_15_04");
        AI_OUTPUT(SELF, OTHER, "DIA_Lena_SQ507_CortezIsDead_03_05");
        AI_OUTPUT(SELF, OTHER, "DIA_Lena_SQ507_CortezIsDead_03_06");
        AI_OUTPUT(SELF, OTHER, "DIA_Lena_SQ507_CortezIsDead_03_07");
        AI_OUTPUT(SELF, OTHER, "DIA_Lena_SQ507_CortezIsDead_03_08");
    };
    if ((SQ507_STARTINGPOINT) == (2)) {
        VLK_6126_LENA.NAME[0] = NPCNAME_LENA;
        VLK_6126_LENA.AIVAR[79] = 1;
        if ((NPC_KNOWSINFO(OTHER, 0x147c7)) && (!(NPC_KNOWSINFO(OTHER, 0x14791)))) {
            AI_OUTPUT(OTHER, SELF, "DIA_Lena_SQ507_CortezIsDead_15_09");
            AI_OUTPUT(SELF, OTHER, "DIA_Lena_SQ507_CortezIsDead_03_10");
        } else if ((!(NPC_KNOWSINFO(OTHER, 0x147c7))) && (!(NPC_KNOWSINFO(OTHER, 0x14791)))) {
            AI_OUTPUT(OTHER, SELF, "DIA_Lena_SQ507_CortezIsDead_15_11");
            AI_OUTPUT(SELF, OTHER, "DIA_Lena_SQ507_CortezIsDead_03_12");
        };
        AI_OUTPUT(OTHER, SELF, "DIA_Lena_SQ507_CortezIsDead_15_13");
        LOG_SETSTATUS(_@(MIS_SQ316), TOPIC_SQ316, LOG_SUCCESS);
        AI_LOGENTRY(TOPIC_SQ316, LOG_SQ316_FINISHUNUSSUALWAY);
    };
    AI_OUTPUT(SELF, OTHER, "DIA_Lena_SQ507_CortezIsDead_03_14");
}

instance DIA_LENA_SQ507_REALSTART(C_INFO) {
    NPC = 0xe5d3;
    NR = 4;
    CONDITION = DIA_LENA_SQ507_REALSTART_CONDITION;
    INFORMATION = DIA_LENA_SQ507_REALSTART_INFO;
    PERMANENT = FALSE;
    DESCRIPTION = "All right, let's go!";
}

func int DIA_LENA_SQ507_REALSTART_CONDITION() {
    if (NPC_KNOWSINFO(OTHER, 0x14cf1)) {
        return TRUE;
    };
    return 0 /* !broken stack! */;
}

func void DIA_LENA_SQ507_REALSTART_INFO() {
    AI_OUTPUT(OTHER, SELF, "DIA_Lena_SQ507_RealStart_15_01");
    NPC_EXCHANGEROUTINE(SELF, "FOLLOW2");
    LOG_CREATETOPIC(TOPIC_SQ507, LOG_MISSION);
    LOG_SETSTATUS(_@(MIS_SQ507), TOPIC_SQ507, LOG_RUNNING);
    AI_LOGENTRY(TOPIC_SQ507, LOG_SQ507_START);
    AI_STOPPROCESSINFOS(SELF);
    WLD_INSERTNPC(0xe491, "P17_HAVEN_CELL_06");
}

instance DIA_LENA_SQ507_RUNE(C_INFO) {
    NPC = 0xe5d3;
    NR = 5;
    CONDITION = DIA_LENA_SQ507_RUNE_CONDITION;
    INFORMATION = DIA_LENA_SQ507_RUNE_INFO;
    PERMANENT = FALSE;
    DESCRIPTION = "Maybe you want to use a teleportation rune to get home?";
}

func int DIA_LENA_SQ507_RUNE_CONDITION() {
    if ((NPC_KNOWSINFO(OTHER, 0x14cf1)) && ((LOG_GETSTATUS(MIS_SQ507)) == (LOG_RUNNING))) {
        return TRUE;
    };
    return 0 /* !broken stack! */;
}

func void DIA_LENA_SQ507_RUNE_INFO() {
    AI_OUTPUT(OTHER, SELF, "DIA_Lena_SQ507_Rune_15_01");
    AI_OUTPUT(SELF, OTHER, "DIA_Lena_SQ507_Rune_03_02");
    AI_OUTPUT(SELF, OTHER, "DIA_Lena_SQ507_Rune_03_03");
}

func void DIA_LENA_SQ507_NEWWEAPON_GO() {
    SQ507_FIGHTWITHBOUNTYHUNTERS = 1;
    NPC_EXCHANGEROUTINE(SELF, "FOLLOWBARRY2");
    B_STARTOTHERROUTINE(MIL_13698_BARRY, "GUIDE2");
    NPC_REFRESH(MIL_13698_BARRY);
    WLD_INSERTNPC(0xe41a, "PART17_PATH_175A");
    WLD_INSERTNPC(0xe41c, "PART17_PATH_175B");
    WLD_INSERTNPC(0xe41e, "PART17_PATH_175C");
}

instance DIA_LENA_SQ507_NEWWEAPON(C_INFO) {
    NPC = 0xe5d3;
    NR = 1;
    CONDITION = DIA_LENA_SQ507_NEWWEAPON_CONDITION;
    INFORMATION = DIA_LENA_SQ507_NEWWEAPON_INFO;
    PERMANENT = FALSE;
    IMPORTANT = TRUE;
}

func int DIA_LENA_SQ507_NEWWEAPON_CONDITION() {
    if (((NPC_KNOWSINFO(OTHER, 0x14366)) && ((NPC_GETDISTTOWP(SELF, "P17_HAVEN_OUT_06")) <= (600))) && ((LOG_GETSTATUS(MIS_SQ507)) == (LOG_RUNNING))) {
        return TRUE;
    };
    return 0 /* !broken stack! */;
}

func void DIA_LENA_SQ507_NEWWEAPON_INFO() {
    NPC_EXCHANGEROUTINE(SELF, "LAYOVER");
    B_STARTOTHERROUTINE(MIL_13698_BARRY, "LAYOVER");
    NPC_REFRESH(MIL_13698_BARRY);
    AI_OUTPUT(SELF, OTHER, "DIA_Lena_SQ507_NewWeapon_03_01");
    AI_OUTPUT(OTHER, SELF, "DIA_Lena_SQ507_NewWeapon_15_02");
    AI_OUTPUT(SELF, OTHER, "DIA_Lena_SQ507_NewWeapon_03_03");
    INFO_CLEARCHOICES(0x14cfb);
    INFO_ADDCHOICE(0x14cfb, "Well, let's see...", 0x14cfe);
}

func void DIA_LENA_SQ507_GIVEWEAPON() {
    AI_OUTPUT(OTHER, SELF, "DIA_Lena_SQ507_GiveWeapon_15_01");
    INFO_CLEARCHOICES(0x14cfb);
    INFO_ADDCHOICE(0x14cfb, "I don't think I have any extra weapons.", 0x14d09);
    if ((NPC_HASITEMS(OTHER, 0x9a58)) > (0)) {
        INFO_ADDCHOICE(0x14cfb, "(Give a knife)", 0x14d00);
    };
    if ((NPC_HASITEMS(OTHER, 0x84d0)) > (0)) {
        INFO_ADDCHOICE(0x14cfb, "(Give a heavy branch)", 0x14d01);
    };
    if ((NPC_HASITEMS(OTHER, 0x84cb)) > (0)) {
        INFO_ADDCHOICE(0x14cfb, "(Give a dagger)", 0x14d02);
    };
    if ((NPC_HASITEMS(OTHER, 0x83b7)) > (0)) {
        INFO_ADDCHOICE(0x14cfb, "(Give a wolf knife)", 0x14d03);
    };
    if ((NPC_HASITEMS(OTHER, 0x84cf)) > (0)) {
        INFO_ADDCHOICE(0x14cfb, "(Give a club)", 0x14d04);
    };
    if ((NPC_HASITEMS(OTHER, 0x84cc)) > (0)) {
        INFO_ADDCHOICE(0x14cfb, "(Give a poker)", 0x14d05);
    };
    if ((NPC_HASITEMS(OTHER, 0x84d1)) > (0)) {
        INFO_ADDCHOICE(0x14cfb, "(Give an axe)", 0x14d06);
    };
    if ((NPC_HASITEMS(OTHER, 0x84cd)) > (0)) {
        INFO_ADDCHOICE(0x14cfb, "(Give a scythe)", 0x14d07);
    };
    if ((NPC_HASITEMS(OTHER, 0x84d5)) > (0)) {
        INFO_ADDCHOICE(0x14cfb, "(Give a spiked club)", 0x14d08);
    };
}

func void B_LENA_EQUIPWEAPON() {
    AI_EQUIPBESTMELEEWEAPON(SELF);
    AI_OUTPUT(SELF, OTHER, "DIA_Lena_SQ507_GiveWeapon_03_02");
    AI_OUTPUT(SELF, OTHER, "DIA_Lena_SQ507_GiveWeapon_03_04");
    AI_LOGENTRY(TOPIC_SQ507, LOG_SQ507_LENAWEAPONV1);
    B_GIVEPLAYERXP(XP_SQ507_LENAWEAPON);
    AI_STOPPROCESSINFOS(SELF);
    DIA_LENA_SQ507_NEWWEAPON_GO();
}

func void DIA_LENA_SQ507_GIVEWEAPON_ITMW_1H_BAU_KNIFE() {
    B_GIVEINVITEMS(OTHER, SELF, 0x9a58, 1);
    B_LENA_EQUIPWEAPON();
}

func void DIA_LENA_SQ507_GIVEWEAPON_ITMW_1H_BAU_MACE() {
    B_GIVEINVITEMS(OTHER, SELF, 0x84d0, 1);
    B_LENA_EQUIPWEAPON();
}

func void DIA_LENA_SQ507_GIVEWEAPON_ITMW_1H_VLK_DAGGER() {
    B_GIVEINVITEMS(OTHER, SELF, 0x84cb, 1);
    B_LENA_EQUIPWEAPON();
}

func void DIA_LENA_SQ507_GIVEWEAPON_ITMW_ADDON_KNIFE01() {
    B_GIVEINVITEMS(OTHER, SELF, 0x83b7, 1);
    B_LENA_EQUIPWEAPON();
}

func void DIA_LENA_SQ507_GIVEWEAPON_ITMW_1H_MACE_L_03() {
    B_GIVEINVITEMS(OTHER, SELF, 0x84cf, 1);
    B_LENA_EQUIPWEAPON();
}

func void DIA_LENA_SQ507_GIVEWEAPON_ITMW_1H_MACE_L_01() {
    B_GIVEINVITEMS(OTHER, SELF, 0x84cc, 1);
    B_LENA_EQUIPWEAPON();
}

func void DIA_LENA_SQ507_GIVEWEAPON_ITMW_1H_VLK_AXE() {
    B_GIVEINVITEMS(OTHER, SELF, 0x84d1, 1);
    B_LENA_EQUIPWEAPON();
}

func void DIA_LENA_SQ507_GIVEWEAPON_ITMW_1H_BAU_AXE() {
    B_GIVEINVITEMS(OTHER, SELF, 0x84cd, 1);
    B_LENA_EQUIPWEAPON();
}

func void DIA_LENA_SQ507_GIVEWEAPON_ITMW_NAGELKNUEPPEL() {
    B_GIVEINVITEMS(OTHER, SELF, 0x84d5, 1);
    B_LENA_EQUIPWEAPON();
}

func void DIA_LENA_SQ507_GIVEWEAPON_NOWEAPON() {
    AI_OUTPUT(OTHER, SELF, "DIA_Lena_SQ507_GiveWeapon_NoWeapon_15_01");
    AI_OUTPUT(SELF, OTHER, "DIA_Lena_SQ507_GiveWeapon_NoWeapon_03_02");
    AI_LOGENTRY(TOPIC_SQ507, LOG_SQ507_LENAWEAPONV2);
    AI_STOPPROCESSINFOS(SELF);
    DIA_LENA_SQ507_NEWWEAPON_GO();
}

