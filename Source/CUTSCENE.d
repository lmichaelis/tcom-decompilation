class CUTSCENE {
	var int ONSTART;
};
func void CUTSCENE_START(var int CUTSCENE) {
    var CUTSCENE C;
    var int CUTSCENEPTR;
    PRINTD(CS2("Start cutscenki: ", _PM_INSTNAME(CUTSCENE)));
    CUTSCENEPTR = CREATE(CUTSCENE);
    C = MEM_PTRTOINST(CUTSCENEPTR);
    MEM_CALLBYID(C.ONSTART);
}

func void KILLSUMMONEDNPCS(var int NODE) {
    var OCNPC NPC;
    var ZCLISTSORT L;
    L = _^(NODE);
    if (L.DATA) {
        NPC = _^(L.DATA);
        if (((NPC.BITFIELD[0]) & (OCNPC_BITFIELD0_ISSUMMONED)) == (OCNPC_BITFIELD0_ISSUMMONED)) {
            NPC.ATTRIBUTE[0] = 0;
        };
    };
}

var int CURRENTTRIGGEREDCAMERAPTR;
var int ISINCAMERA;
var int ISINFINALBOARDS;
func void ZCCSCAMERA__ONTRIGGER_HOOK() {
    if ((((CURRENTLEVEL) != (ARCHOLOS_VOLFZACKE_ZEN)) && ((CURRENTLEVEL) != (ARCHOLOS_ENDGAME_ZEN))) && ((RESERVED_VAR_INT_13) != (TRUE))) {
        LIST_FORFS(MEM_WORLD.VOBLIST_NPCS, 21822);
        if (NPC_HASREADIEDWEAPON(HERO)) {
            AI_REMOVEWEAPON(HERO);
        };
        if ((NPC_GETACTIVESPELL(HERO)) != (-(1))) {
            AI_UNREADYSPELL(HERO);
        };
    };
    ISINCAMERA = TRUE;
    ENABLELOADSAVEGAME(FALSE);
    CURRENTTRIGGEREDCAMERAPTR = EAX;
}

func void ZCCSCAMERA__ONUNTRIGGER_HOOK() {
    if ((EAX) == (CURRENTTRIGGEREDCAMERAPTR)) {
        ISINCAMERA = FALSE;
        ENABLELOADSAVEGAME(TRUE);
        CURRENTTRIGGEREDCAMERAPTR = 0;
    };
}

func void ZCVIEW__DIALOGMESSAGECXY_HOOK() {
    var int COLOR;
    var string NPCNAME;
    if (ISINFINALBOARDS) {
        MEM_WRITEINT(MEM_READINT((ESP) + (16)), RGBA(255, 255, 0, 255));
        MEM_WRITESTRING(MEM_READINT((ESP) + (4)), "");
    };
    if (ISINCAMERA) {
        if ((ECX) == (MEM_GAME.ARRAY_VIEW[5])) {
            ECX = MEM_GAME.ARRAY_VIEW[1];
            NPCNAME = MEM_READSTRING(MEM_READINT((ESP) + (4)));
            if ((STR_LEN(NPCNAME)) == (0)) {
                COLOR = RGBA(255, 255, 255, 255);
            } else {
                COLOR = RGBA(255, 255, 0, 255);
            };
            MEM_WRITEINT(MEM_READINT((ESP) + (16)), COLOR);
        };
    };
}

func void OCGAME__UPDATEPLAYERSTATUS_REPLACECHECKINGGLOBALCUTSCENE() {
    EAX = (ISINCAMERA) || (ISINFINALBOARDS);
}

func void OCAIHUMAN__MOVING_REPLACECHECKINGGLOBALCUTSCENE() {
    EAX = (ISINCAMERA) || (ISINFINALBOARDS);
}

func void CGAMEMANAGER__MENUENABLED_REPLACECHECKINGGLOBALCUTSCENE() {
    EAX = (ISINCAMERA) || (ISINFINALBOARDS);
}

func void OCNPC__STOPRUNNINGOU_REPLACEKILLOUSOUND() {
    var int G_BDONTKILLOUSOUND;
    G_BDONTKILLOUSOUND = MEM_READINT(11216536);
    EAX = ((G_BDONTKILLOUSOUND) || (ISINCAMERA)) || (ISINFINALBOARDS);
}

func void CUTSCENESYSTEM_INIT() {
    HOOKENGINEF(8032832, 6, 21831);
    HOOKENGINEF(4993648, 7, 21829);
    HOOKENGINEF(4995776, 7, 21830);
    MEMORYPROTECTIONOVERRIDE(7090646, 5);
    WRITENOP(7090646, 5);
    HOOKENGINEF(7090646, 5, 21836);
    MEMORYPROTECTIONOVERRIDE(4369383, 5);
    WRITENOP(4369383, 5);
    HOOKENGINEF(4369383, 5, 21838);
    MEMORYPROTECTIONOVERRIDE(6928881, 5);
    WRITENOP(6928881, 5);
    HOOKENGINEF(6928881, 5, 21837);
}

