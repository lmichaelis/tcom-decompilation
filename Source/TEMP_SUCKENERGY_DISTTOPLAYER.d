var int TEMP_SUCKENERGY_DISTTOPLAYER;
func void B_RESTARTSUCKENERGY() {
    if ((NPC_GETLASTHITSPELLID(SELF)) == (SPL_SUCKENERGY)) {
        NPC_SETSTATETIME(SELF, 0);
        AI_PLAYANI(SELF, "T_STAND_2_SUCKENERGY_VICTIM");
    };
}

func void B_STOPSUCKENERGY() {
    NPC_PERCENABLE(SELF, PERC_ASSESSMAGIC, 43309);
    NPC_CLEARAIQUEUE(SELF);
    AI_STANDUP(SELF);
    if ((SELF.GUILD) < (GIL_SEPERATOR_HUM)) {
        B_ASSESSDAMAGE();
    };
    NPC_SETTEMPATTITUDE(SELF, ATT_HOSTILE);
}

func int ZS_SUCKENERGY() {
    NPC_PERCENABLE(SELF, PERC_ASSESSMAGIC, 43893);
    NPC_STOPANI(SELF, "S_SUCKENERGY_VICTIM");
    NPC_CLEARAIQUEUE(SELF);
    AI_STANDUP(SELF);
    SELF.AIVAR[79] = 1;
    TEMP_SUCKENERGY_DISTTOPLAYER = NPC_GETDISTTOPLAYER(SELF);
    return 0 /* !broken stack! */;
}

func int ZS_SUCKENERGY_LOOP() {
    if (((NPC_GETSTATETIME(SELF)) > (SPL_TIME_SUCKENERGY)) || ((TEMP_SUCKENERGY_DISTTOPLAYER) >= ((NPC_GETDISTTOPLAYER(SELF)) + (100)))) {
        B_STOPSUCKENERGY();
        return LOOP_END;
    };
    if ((NPC_GETSTATETIME(SELF)) != (SELF.AIVAR[79])) {
        if ((NPC_GETSTATETIME(SELF)) == (0)) {
            if (!(C_BODYSTATECONTAINS(SELF, BS_UNCONSCIOUS))) {
                AI_PLAYANIBS(SELF, "T_STAND_2_SUCKENERGY_VICTIM", BS_UNCONSCIOUS);
            };
            WLD_PLAYEFFECT("spellFX_SuckEnergy_BloodFly", SELF, HERO, 0, 0, 0, FALSE);
        };
        SELF.AIVAR[79] = NPC_GETSTATETIME(SELF);
        if ((SELF.ATTRIBUTE[0]) > (SPL_SUCKENERGY_DAMAGE)) {
            B_MAGICHURTNPC(OTHER, SELF, SPL_SUCKENERGY_DAMAGE);
            NPC_CHANGEATTRIBUTE(OTHER, ATR_HITPOINTS, SPL_SUCKENERGY_DAMAGE);
        } else {
            B_MAGICHURTNPC(OTHER, SELF, (SELF.ATTRIBUTE[0]) - (1));
        };
    };
    return LOOP_CONTINUE;
}

func void ZS_SUCKENERGY_END() {
}

