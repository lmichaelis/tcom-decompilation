func int DIA_FINBARBODYGUARD_EXIT_CONDITION() {
    return TRUE;
}

func void DIA_FINBARBODYGUARD_EXIT_INFO() {
    AI_STOPPROCESSINFOS(SELF);
    AI_RESETFACEANI(SELF);
}

const string FINBARBODYGUARD_CHECKPOINT_01 = "HARBOUR_CUTSCENE_FINBAR_MILITIA_01";
const string FINBARBODYGUARD_CHECKPOINT_02 = "HARBOUR_PATH_102";
instance DIA_FINBARBODYGUARD_FIRSTWARN(C_INFO) {
    NR = 1;
    CONDITION = DIA_FINBARBODYGUARD_FIRSTWARN_CONDITION;
    INFORMATION = DIA_FINBARBODYGUARD_FIRSTWARN_INFO;
    PERMANENT = TRUE;
    IMPORTANT = TRUE;
}

var int FINBARBODYGUARD_ALLOWSUSGO;
var int FINBARBODYGUARD_THEYKNOWYOURGUILD;
func int DIA_FINBARBODYGUARD_FIRSTWARN_CONDITION() {
    if (((Q206_KNOWSFINBAR) == (TRUE)) && ((LOG_GETSTATUS(MIS_Q206)) == (LOG_RUNNING))) {
        if ((FINBARBODYGUARD_ALLOWSUSGO) == (TRUE)) {
            SELF.AIVAR[14] = TRUE;
        } else {
            SELF.AIVAR[14] = FALSE;
        };
        if ((NPC_GETDISTTONPC(SELF, HERO)) <= (700)) {
            if (((((SELF.AIVAR[12]) == (GP_NONE)) && ((SELF.AIVAR[14]) == (FALSE))) && ((HLP_STRCMP(NPC_GETNEARESTWP(SELF), SELF.WP)) == (TRUE))) && ((NPC_REFUSETALK(SELF)) == (FALSE))) {
                return TRUE;
            };
        };
    };
    return 0 /* !broken stack! */;
}

func void FINBARBODYGUARD_KILLHERO() {
    OTHER.AIVAR[13] = 0;
    SELF.AIVAR[12] = GP_NONE;
    AI_DRAWWEAPON(SELF);
    AI_STOPPROCESSINFOS(SELF);
    B_ATTACK(SELF, OTHER, AR_GUARDSTOPSINTRUDER, 1);
}

func void FINBARBODYGUARD_CHECKLASTDISTWP() {
    if ((HLP_GETINSTANCEID(SELF)) == (HLP_GETINSTANCEID(MIL_4009_HARBGUARD))) {
        OTHER.AIVAR[13] = NPC_GETDISTTOWP(OTHER, FINBARBODYGUARD_CHECKPOINT_01);
    };
    if ((HLP_GETINSTANCEID(SELF)) == (HLP_GETINSTANCEID(MIL_4008_HARBGUARD))) {
        OTHER.AIVAR[13] = NPC_GETDISTTOWP(OTHER, FINBARBODYGUARD_CHECKPOINT_02);
    };
}

func void DIA_FINBARBODYGUARD_GUILDFUCKOFF() {
    AI_STARTFACEANI(SELF, S_ANGRY, 1, -(1));
    AI_OUTPUT(SELF, OTHER, "DIA_FinbarBodyGuard_GuildFuckOff_03_01");
    AI_STOPPROCESSINFOS(SELF);
    AI_RESETFACEANI(SELF);
    if ((FINBARBODYGUARD_THEYKNOWYOURGUILD) == (FALSE)) {
        if ((Q206_MARVINISSPY) == (FALSE)) {
            Q206_MARVINISSPY = TRUE;
        };
        FINBARBODYGUARD_THEYKNOWYOURGUILD = TRUE;
        AI_LOGENTRY(TOPIC_Q206, LOG_Q206_GUARD_NOENTRY);
    };
}

func void DIA_FINBARBODYGUARD_FIRSTWARN_INFO() {
    INFO_CLEARCHOICES(42685);
    if ((FINBARBODYGUARD_THEYKNOWYOURGUILD) == (FALSE)) {
        if (NPC_HASGUILDARMOREQUIPPED(OTHER, GIL_SLD)) {
            DIA_FINBARBODYGUARD_GUILDFUCKOFF();
        } else {
            AI_OUTPUT(SELF, OTHER, "DIA_FinbarBodyGuard_FirstWarn_03_01");
        };
    };
    DIA_FINBARBODYGUARD_GUILDFUCKOFF();
    FINBARBODYGUARD_CHECKLASTDISTWP();
    SELF.AIVAR[12] = GP_FIRSTWARNGIVEN;
}

func void DIA_FINBARBODYGUARD_FIRSTWARN_DIALOG_ENDE() {
    DIA_FINBARBODYGUARD_EXIT_INFO();
}

instance DIA_FINBARBODYGUARD_SECONDWARN(C_INFO) {
    NR = 1;
    CONDITION = DIA_FINBARBODYGUARD_SECONDWARN_CONDITION;
    INFORMATION = DIA_FINBARBODYGUARD_SECONDWARN_INFO;
    PERMANENT = TRUE;
    IMPORTANT = TRUE;
}

func int DIA_FINBARBODYGUARD_SECONDWARN_CONDITION() {
    if (((Q206_KNOWSFINBAR) == (TRUE)) && ((LOG_GETSTATUS(MIS_Q206)) == (LOG_RUNNING))) {
        if ((((SELF.AIVAR[12]) == (GP_FIRSTWARNGIVEN)) && ((SELF.AIVAR[14]) == (FALSE))) && ((HLP_STRCMP(NPC_GETNEARESTWP(SELF), SELF.WP)) == (TRUE))) {
            if ((((HLP_GETINSTANCEID(SELF)) == (HLP_GETINSTANCEID(MIL_4009_HARBGUARD))) && ((NPC_GETDISTTOWP(OTHER, FINBARBODYGUARD_CHECKPOINT_01)) < ((OTHER.AIVAR[13]) - (50)))) || (((HLP_GETINSTANCEID(SELF)) == (HLP_GETINSTANCEID(MIL_4008_HARBGUARD))) && ((NPC_GETDISTTOWP(OTHER, FINBARBODYGUARD_CHECKPOINT_02)) < ((OTHER.AIVAR[13]) - (50))))) {
                return TRUE;
            };
        };
    };
    return 0 /* !broken stack! */;
}

func void DIA_FINBARBODYGUARD_SECONDWARN_INFO() {
    if (NPC_HASGUILDARMOREQUIPPED(OTHER, GIL_SLD)) {
        DIA_FINBARBODYGUARD_GUILDFUCKOFF();
    };
    AI_STARTFACEANI(SELF, S_SERIOUS, 1, -(1));
    AI_OUTPUT(SELF, OTHER, "DIA_FinbarBodyGuard_SecondWarn_03_01");
    AI_RESETFACEANI(SELF);
    FINBARBODYGUARD_CHECKLASTDISTWP();
    SELF.AIVAR[12] = GP_SECONDWARNGIVEN;
    if ((FINBARBODYGUARD_THEYKNOWYOURGUILD) == (TRUE)) {
        AI_STOPPROCESSINFOS(SELF);
    };
}

instance DIA_FINBARBODYGUARD_LASTWARN(C_INFO) {
    NR = 1;
    CONDITION = DIA_FINBARBODYGUARD_LASTWARN_CONDITION;
    INFORMATION = DIA_FINBARBODYGUARD_LASTWARN_INFO;
    PERMANENT = TRUE;
    IMPORTANT = TRUE;
}

func int DIA_FINBARBODYGUARD_LASTWARN_CONDITION() {
    if (((Q206_KNOWSFINBAR) == (TRUE)) && ((LOG_GETSTATUS(MIS_Q206)) == (LOG_RUNNING))) {
        if ((((SELF.AIVAR[12]) == (GP_SECONDWARNGIVEN)) && ((SELF.AIVAR[14]) == (FALSE))) && ((HLP_STRCMP(NPC_GETNEARESTWP(SELF), SELF.WP)) == (TRUE))) {
            if ((((HLP_GETINSTANCEID(SELF)) == (HLP_GETINSTANCEID(MIL_4009_HARBGUARD))) && ((NPC_GETDISTTOWP(OTHER, FINBARBODYGUARD_CHECKPOINT_01)) < ((OTHER.AIVAR[13]) - (50)))) || (((HLP_GETINSTANCEID(SELF)) == (HLP_GETINSTANCEID(MIL_4008_HARBGUARD))) && ((NPC_GETDISTTOWP(OTHER, FINBARBODYGUARD_CHECKPOINT_02)) < ((OTHER.AIVAR[13]) - (50))))) {
                return TRUE;
            };
        };
    };
    return 0 /* !broken stack! */;
}

func void DIA_FINBARBODYGUARD_LASTWARN_INFO() {
    AI_STARTFACEANI(SELF, S_SERIOUS, 1, -(1));
    B_SAY(SELF, OTHER, "$Alarm");
    AI_STOPPROCESSINFOS(SELF);
    FINBARBODYGUARD_KILLHERO();
}

instance DIA_FINBARBODYGUARD_GUILD(C_INFO) {
    NR = 1;
    CONDITION = DIA_FINBARBODYGUARD_GUILD_CONDITION;
    INFORMATION = DIA_FINBARBODYGUARD_GUILD_INFO;
    PERMANENT = FALSE;
    DESCRIPTION = "I'm from the Merchant's Guild, investigating.";
}

func int DIA_FINBARBODYGUARD_GUILD_CONDITION() {
    if ((((Q206_KNOWSFINBAR) == (TRUE)) && ((FINBARBODYGUARD_ALLOWSUSGO) == (FALSE))) && ((LOG_GETSTATUS(MIS_Q206)) == (LOG_RUNNING))) {
        return TRUE;
    };
    return 0 /* !broken stack! */;
}

func void DIA_FINBARBODYGUARD_GUILD_INFO() {
    AI_OUTPUT(OTHER, SELF, "DIA_FinbarBodyGuard_Guild_15_01");
    AI_STARTFACEANI(SELF, S_SURPRISE, 1, -(1));
    AI_OUTPUT(SELF, OTHER, "DIA_FinbarBodyGuard_Guild_03_02");
    DIA_FINBARBODYGUARD_GUILDFUCKOFF();
}

instance DIA_FINBARBODYGUARD_FRIEND(C_INFO) {
    NR = 1;
    CONDITION = DIA_FINBARBODYGUARD_FRIEND_CONDITION;
    INFORMATION = DIA_FINBARBODYGUARD_FRIEND_INFO;
    PERMANENT = FALSE;
    DESCRIPTION = "A friend of mine went missing and the tracks led me here.";
}

func int DIA_FINBARBODYGUARD_FRIEND_CONDITION() {
    if ((((Q206_KNOWSFINBAR) == (TRUE)) && ((FINBARBODYGUARD_ALLOWSUSGO) == (FALSE))) && ((LOG_GETSTATUS(MIS_Q206)) == (LOG_RUNNING))) {
        return TRUE;
    };
    return 0 /* !broken stack! */;
}

func void DIA_FINBARBODYGUARD_FRIEND_INFO() {
    AI_OUTPUT(OTHER, SELF, "DIA_FinbarBodyGuard_Friend_15_01");
    AI_STARTFACEANI(SELF, S_TIRED, 1, -(1));
    AI_OUTPUT(SELF, OTHER, "DIA_FinbarBodyGuard_Friend_03_02");
    AI_RESETFACEANI(SELF);
}

instance DIA_FINBARBODYGUARD_PAY(C_INFO) {
    NR = 1;
    CONDITION = DIA_FINBARBODYGUARD_PAY_CONDITION;
    INFORMATION = DIA_FINBARBODYGUARD_PAY_INFO;
    PERMANENT = TRUE;
    DESCRIPTION = "I really need to look at this body... (Pay 50 GP)";
}

func int DIA_FINBARBODYGUARD_PAY_CONDITION() {
    if ((((Q206_KNOWSFINBAR) == (TRUE)) && ((FINBARBODYGUARD_ALLOWSUSGO) == (FALSE))) && ((LOG_GETSTATUS(MIS_Q206)) == (LOG_RUNNING))) {
        return TRUE;
    };
    return 0 /* !broken stack! */;
}

func void DIA_FINBARBODYGUARD_PAY_INFO() {
    AI_OUTPUT(OTHER, SELF, "DIA_FinbarBodyGuard_Pay_15_01");
    B_MARVIN_USEFAKEBAG_THROW();
    if ((NPC_HASITEMS(OTHER, 34203)) >= (Q206_GOLDFORINFO)) {
        B_GIVEINVITEMS(OTHER, SELF, 34203, Q206_GOLDFORINFO);
        AI_STARTFACEANI(SELF, S_THINK, 1, -(1));
        AI_PLAYANI(SELF, T_SEARCH);
        AI_STARTFACEANI(SELF, S_SURPRISE, 1, -(1));
        AI_OUTPUT(SELF, OTHER, "DIA_FinbarBodyGuard_Pay_03_02");
        FINBARBODYGUARD_ALLOWSUSGO = TRUE;
        AI_STOPPROCESSINFOS(SELF);
        AI_RESETFACEANI(SELF);
    };
    AI_STARTFACEANI(SELF, S_ANGRY, 1, -(1));
    B_SAY(SELF, OTHER, "$NOGOLD_BRIBE");
    AI_RESETFACEANI(SELF);
}

instance DIA_FINBARBODYGUARD_BUSY(C_INFO) {
    NR = 999;
    CONDITION = DIA_FINBARBODYGUARD_BUSY_CONDITION;
    INFORMATION = DIA_FINBARBODYGUARD_BUSY_INFO;
    PERMANENT = TRUE;
    IMPORTANT = TRUE;
}

func int DIA_FINBARBODYGUARD_BUSY_CONDITION() {
    if (NPC_ISINSTATE(SELF, 61599)) {
        if ((((Q206_KNOWSFINBAR) == (FALSE)) || (((Q206_KNOWSFINBAR) == (TRUE)) && ((LOG_GETSTATUS(MIS_Q206)) != (LOG_RUNNING)))) || (((LOG_GETSTATUS(MIS_Q206)) == (LOG_RUNNING)) && ((FINBARBODYGUARD_ALLOWSUSGO) == (TRUE)))) {
            return TRUE;
        };
    };
    return 0 /* !broken stack! */;
}

func void DIA_FINBARBODYGUARD_BUSY_INFO() {
    var int RND_FINBARBODYGUARD;
    RND_FINBARBODYGUARD = HLP_RANDOM(2);
    if ((RND_FINBARBODYGUARD) == (0)) {
        DIA_IMBUSY_CALM();
    };
    if ((RND_FINBARBODYGUARD) == (1)) {
        DIA_IMBUSY_ANGRY();
    };
}

func void B_ASSIGNAMBIENTINFOS_Q206_FINBARBODYGUARD(var C_NPC SLF) {
    DIA_FINBARBODYGUARD_EXIT.NPC = HLP_GETINSTANCEID(SLF);
    DIA_FINBARBODYGUARD_FIRSTWARN.NPC = HLP_GETINSTANCEID(SLF);
    DIA_FINBARBODYGUARD_SECONDWARN.NPC = HLP_GETINSTANCEID(SLF);
    DIA_FINBARBODYGUARD_LASTWARN.NPC = HLP_GETINSTANCEID(SLF);
    DIA_FINBARBODYGUARD_FRIEND.NPC = HLP_GETINSTANCEID(SLF);
    DIA_FINBARBODYGUARD_GUILD.NPC = HLP_GETINSTANCEID(SLF);
    DIA_FINBARBODYGUARD_PAY.NPC = HLP_GETINSTANCEID(SLF);
    DIA_FINBARBODYGUARD_BUSY.NPC = HLP_GETINSTANCEID(SLF);
}

