instance Q304_TRAPCUTSCENE(CUTSCENE) {
    ONSTART = FUNCTION(92445);
}

func void Q304_TRAPCUTSCENE_WAIT() {
    if ((Q304_GONZALOSAFED) == (FALSE)) {
        AI_WAITTILLEND(BAU_6287_GONZALO, NONE_6340_SMUGGLER);
        AI_WAITTILLEND(BAU_6287_GONZALO, NONE_6341_BODYGUARD);
        AI_WAITTILLEND(BAU_6287_GONZALO, HERO);
        AI_WAITTILLEND(NONE_6340_SMUGGLER, BAU_6287_GONZALO);
        AI_WAITTILLEND(NONE_6340_SMUGGLER, NONE_6341_BODYGUARD);
        AI_WAITTILLEND(NONE_6340_SMUGGLER, HERO);
        AI_WAITTILLEND(HERO, NONE_6340_SMUGGLER);
        AI_WAITTILLEND(HERO, BAU_6287_GONZALO);
        AI_WAITTILLEND(HERO, NONE_6341_BODYGUARD);
        AI_WAITTILLEND(NONE_6341_BODYGUARD, NONE_6340_SMUGGLER);
        AI_WAITTILLEND(NONE_6341_BODYGUARD, BAU_6287_GONZALO);
        AI_WAITTILLEND(NONE_6341_BODYGUARD, HERO);
    };
    AI_WAITTILLEND(HERO, NONE_6340_SMUGGLER);
    AI_WAITTILLEND(NONE_6340_SMUGGLER, HERO);
}

func void Q304_TRAPCUTSCENE_START() {
    B_PASSTIME(2);
    FADESCREENFROMBLACK(3);
    if (TORCH_HEROHOLDINGTORCH()) {
        TORCH_UNEQUIP();
    };
    MDL_APPLYOVERLAYMDS(PIR_1306_RODRIGO, HUMANSMARVINSNEAKMDS);
    TELEPORTNPCTOWP(58677, "PART17_BLOODCURRENCY_HERO_03");
    MDL_APPLYOVERLAYMDS(PIR_1308_SIMON, HUMANSMARVINSNEAKMDS);
    TELEPORTNPCTOWP(58703, "PART17_CUTSCENE_FINAL_PIRAT_02");
    if ((SIMON_Q304_NEEDMOREPPL) >= (1)) {
        if (!(NPC_ISDEAD(PIR_1311_THIAGO))) {
            MDL_APPLYOVERLAYMDS(PIR_1311_THIAGO, HUMANSMARVINSNEAKMDS);
            TELEPORTNPCTOWP(58743, "PART17_CUTSCENE_FINAL_PIRAT_01");
            NPC_CLEARAIQUEUE(PIR_1311_THIAGO);
            AI_TURNTONPC(PIR_1311_THIAGO, HERO);
            AI_SETWALKMODE(PIR_1311_THIAGO, NPC_RUN);
        };
        if ((SIMON_Q304_NEEDMOREPPL) == (2)) {
            if (!(NPC_ISDEAD(PIR_6322_GHOST))) {
                MDL_APPLYOVERLAYMDS(PIR_6322_GHOST, HUMANSMARVINSNEAKMDS);
                TELEPORTNPCTOWP(58497, "PART17_CUTSCENE_FINAL_PIRAT_03");
                NPC_CLEARAIQUEUE(PIR_6322_GHOST);
                AI_TURNTONPC(PIR_6322_GHOST, HERO);
                AI_SETWALKMODE(PIR_6322_GHOST, NPC_RUN);
            };
        };
    };
    TELEPORTNPCTOWP(58400, "PART17_CAVE_CUTSCENE_BODYGUARD_05");
    TELEPORTNPCTOWP(58416, "PART17_CAVE_CUTSCENE_BODYGUARD_04");
    TELEPORTNPCTOWP(58426, "PART17_CAVE_CUTSCENE_BODYGUARD_03");
    TELEPORTNPCTOWP(58435, "PART17_CAVE_CUTSCENE_BODYGUARD_02");
    TELEPORTNPCTOWP(58464, "PART17_CAVE_CUTSCENE_BODYGUARD_01");
    TELEPORTNPCTOWP(58444, "PART17_CAVE_SMUGGLER");
    TELEPORTNPCTOWP(1819, "PART17_PATH_222");
    NPC_CLEARAIQUEUE(NONE_6336_BODYGUARD);
    NPC_CLEARAIQUEUE(NONE_6337_BODYGUARD);
    NPC_CLEARAIQUEUE(NONE_6338_BODYGUARD);
    NPC_CLEARAIQUEUE(NONE_6339_BODYGUARD);
    NPC_CLEARAIQUEUE(NONE_6341_BODYGUARD);
    NPC_CLEARAIQUEUE(NONE_6340_SMUGGLER);
    NPC_CLEARAIQUEUE(PIR_1306_RODRIGO);
    NPC_CLEARAIQUEUE(PIR_1308_SIMON);
    WLD_SENDTRIGGER("KM_BLOODCURRENCY_01_C");
    HERO.AIVAR[4] = FALSE;
    AI_SETWALKMODE(NONE_6336_BODYGUARD, NPC_RUN);
    AI_SETWALKMODE(NONE_6337_BODYGUARD, NPC_RUN);
    AI_SETWALKMODE(NONE_6338_BODYGUARD, NPC_RUN);
    AI_SETWALKMODE(NONE_6339_BODYGUARD, NPC_RUN);
    AI_SETWALKMODE(NONE_6340_SMUGGLER, NPC_RUN);
    AI_SETWALKMODE(NONE_6341_BODYGUARD, NPC_RUN);
    AI_SETWALKMODE(PIR_1306_RODRIGO, NPC_RUN);
    AI_SETWALKMODE(PIR_1308_SIMON, NPC_RUN);
    AI_TURNTONPC(HERO, NONE_6340_SMUGGLER);
    AI_TURNTONPC(NONE_6336_BODYGUARD, HERO);
    AI_TURNTONPC(NONE_6337_BODYGUARD, HERO);
    AI_TURNTONPC(NONE_6338_BODYGUARD, HERO);
    AI_TURNTONPC(NONE_6339_BODYGUARD, HERO);
    AI_TURNTONPC(NONE_6341_BODYGUARD, HERO);
    AI_TURNTONPC(NONE_6340_SMUGGLER, HERO);
    AI_TURNTONPC(PIR_1306_RODRIGO, HERO);
    AI_TURNTONPC(PIR_1308_SIMON, HERO);
    AI_LOOKATNPC(HERO, NONE_6340_SMUGGLER);
    AI_LOOKATNPC(NONE_6336_BODYGUARD, HERO);
    AI_LOOKATNPC(NONE_6337_BODYGUARD, HERO);
    AI_LOOKATNPC(NONE_6338_BODYGUARD, HERO);
    AI_LOOKATNPC(NONE_6339_BODYGUARD, HERO);
    AI_LOOKATNPC(NONE_6341_BODYGUARD, HERO);
    AI_LOOKATNPC(NONE_6340_SMUGGLER, HERO);
    AI_STARTFACEANI(NONE_6336_BODYGUARD, S_ANGRY, 1, -(1));
    AI_STARTFACEANI(NONE_6337_BODYGUARD, S_ANGRY, 1, -(1));
    AI_STARTFACEANI(NONE_6338_BODYGUARD, S_ANGRY, 1, -(1));
    AI_STARTFACEANI(NONE_6339_BODYGUARD, S_ANGRY, 1, -(1));
    AI_STARTFACEANI(NONE_6341_BODYGUARD, S_ANGRY, 1, -(1));
    AI_STARTFACEANI(HERO, S_ANGRY, 1, -(1));
    AI_STARTFACEANI(NONE_6340_SMUGGLER, S_SMUG, 1, -(1));
    if ((Q304_GONZALOSAFED) == (FALSE)) {
        AI_TURNTONPC(BAU_6287_GONZALO, HERO);
        AI_STARTFACEANI(BAU_6287_GONZALO, S_FRIGHTENED, 1, -(1));
        BAU_6287_GONZALO.AIVAR[92] = TRUE;
        AI_LOOKATNPC(BAU_6287_GONZALO, HERO);
    };
    AI_PLAYANI(HERO, "T_STAND_2_LGUARD_HERO");
    AI_WAIT(HERO, 1084227584);
    AI_FUNCTION(HERO, 92447);
    Q304_TRAPCUTSCENE_WAIT();
    AI_OUTPUT(NONE_6340_SMUGGLER, HERO, "DIA_Q304_FINALCUTSCENE_03_01");
    AI_OUTPUT(NONE_6340_SMUGGLER, HERO, "DIA_Q304_FINALCUTSCENE_03_02");
    Q304_TRAPCUTSCENE_WAIT();
    AI_OUTPUT(HERO, HERO, "DIA_Q304_FINALCUTSCENE_15_03");
    Q304_TRAPCUTSCENE_WAIT();
    AI_OUTPUT(NONE_6340_SMUGGLER, HERO, "DIA_Q304_FINALCUTSCENE_03_04");
    AI_FUNCTION(HERO, 92448);
    Q304_TRAPCUTSCENE_WAIT();
    AI_OUTPUT(NONE_6340_SMUGGLER, HERO, "DIA_Q304_FINALCUTSCENE_03_05");
    AI_FUNCTION(HERO, 92449);
    Q304_TRAPCUTSCENE_WAIT();
    if ((Q304_GONZALOSAFED) == (FALSE)) {
        AI_FUNCTION(HERO, 92450);
        AI_OUTPUT(NONE_6340_SMUGGLER, HERO, "DIA_Q304_FINALCUTSCENE_03_06");
        Q304_TRAPCUTSCENE_WAIT();
        AI_TURNTONPC(NONE_6340_SMUGGLER, BAU_6287_GONZALO);
        AI_TURNTONPC(BAU_6287_GONZALO, NONE_6340_SMUGGLER);
        AI_LOOKATNPC(NONE_6340_SMUGGLER, BAU_6287_GONZALO);
        AI_LOOKATNPC(BAU_6287_GONZALO, NONE_6340_SMUGGLER);
        AI_OUTPUT(NONE_6340_SMUGGLER, HERO, "DIA_Q304_FINALCUTSCENE_03_07");
        AI_OUTPUT(NONE_6340_SMUGGLER, HERO, "DIA_Q304_FINALCUTSCENE_03_08");
        Q304_TRAPCUTSCENE_WAIT();
        AI_OUTPUT(BAU_6287_GONZALO, HERO, "DIA_Q304_FINALCUTSCENE_03_09");
        Q304_TRAPCUTSCENE_WAIT();
        AI_FUNCTION(BAU_6287_GONZALO, 92454);
        AI_TURNTONPC(NONE_6340_SMUGGLER, HERO);
        AI_LOOKATNPC(NONE_6340_SMUGGLER, HERO);
    };
    Q304_TRAPCUTSCENE_WAIT();
    AI_FUNCTION(HERO, 92451);
    AI_OUTPUT(NONE_6340_SMUGGLER, HERO, "DIA_Q304_FINALCUTSCENE_03_10");
    Q304_TRAPCUTSCENE_WAIT();
    AI_WAITTILLEND(NONE_6337_BODYGUARD, NONE_6340_SMUGGLER);
    AI_WAITTILLEND(NONE_6338_BODYGUARD, NONE_6340_SMUGGLER);
    AI_WAITTILLEND(NONE_6341_BODYGUARD, NONE_6340_SMUGGLER);
    NONE_6337_BODYGUARD.FLAGS = 0;
    NONE_6338_BODYGUARD.FLAGS = 0;
    NONE_6341_BODYGUARD.FLAGS = 0;
    AI_DRAWWEAPON(NONE_6337_BODYGUARD);
    AI_DRAWWEAPON(NONE_6338_BODYGUARD);
    AI_DRAWWEAPON(NONE_6341_BODYGUARD);
    AI_WAIT(HERO, 1036831949);
    AI_WAIT(NONE_6340_SMUGGLER, 1084227584);
    AI_WAITTILLEND(NONE_6337_BODYGUARD, HERO);
    AI_WAITTILLEND(NONE_6338_BODYGUARD, HERO);
    AI_WAITTILLEND(NONE_6341_BODYGUARD, HERO);
    AI_GOTOWP(NONE_6337_BODYGUARD, "PART17_PATH_223");
    AI_GOTOWP(NONE_6338_BODYGUARD, "PART17_PATH_223");
    AI_GOTOWP(NONE_6341_BODYGUARD, "PART17_PATH_223");
    FF_APPLY(92446);
}

func void Q304_TRAPCUTSCENE_SETCHASMDETECTION_ONFRAME() {
    if (HLP_ISVALIDNPC(NONE_6337_BODYGUARD)) {
        CALL_INTPARAM(FALSE);
        CALL__THISCALL(MEM_INSTTOPTR(58416), 6851184);
    };
    if (HLP_ISVALIDNPC(NONE_6338_BODYGUARD)) {
        CALL_INTPARAM(FALSE);
        CALL__THISCALL(MEM_INSTTOPTR(58426), 6851184);
    };
    if (HLP_ISVALIDNPC(NONE_6341_BODYGUARD)) {
        CALL_INTPARAM(FALSE);
        CALL__THISCALL(MEM_INSTTOPTR(58464), 6851184);
    };
}

func void Q304_TRAPCUTSCENE_CAMERA1() {
    WLD_SENDTRIGGER("KM_BLOODCURRENCY_FINAL_01");
    WLD_SENDUNTRIGGER("KM_BLOODCURRENCY_01_C");
    HERO.AIVAR[4] = FALSE;
}

func void Q304_TRAPCUTSCENE_CAMERA2() {
    WLD_SENDTRIGGER("KM_BLOODCURRENCY_FINAL_02");
    WLD_SENDUNTRIGGER("KM_BLOODCURRENCY_FINAL_01");
    HERO.AIVAR[4] = FALSE;
}

func void Q304_TRAPCUTSCENE_CAMERA3() {
    WLD_SENDTRIGGER("KM_BLOODCURRENCY_FINAL_03");
    WLD_SENDUNTRIGGER("KM_BLOODCURRENCY_FINAL_02");
    HERO.AIVAR[4] = FALSE;
}

func void Q304_TRAPCUTSCENE_CAMERA4() {
    WLD_SENDTRIGGER("KM_BLOODCURRENCY_FINAL_04");
    WLD_SENDUNTRIGGER("KM_BLOODCURRENCY_FINAL_03");
    HERO.AIVAR[4] = FALSE;
}

func void Q304_TRAPCUTSCENE_CAMERA5() {
    WLD_SENDTRIGGER("KM_BLOODCURRENCY_FINAL_05");
    WLD_SENDUNTRIGGER("KM_BLOODCURRENCY_FINAL_04");
    HERO.AIVAR[4] = FALSE;
}

func void Q304_TRAPCUTSCENE_CAMERA6() {
    MUSIC_OVERRIDETRACK(21947);
    WLD_REMOVEITEM(ITMW_2H_SLD_AXE_Q304);
    AI_PLAYANI(HERO, "T_REMOVE_LGUARD");
    WLD_REMOVEITEM(ITMW_1H_MISC_AXE_Q304_02);
    WLD_SENDTRIGGER("KM_BLOODCURRENCY_FINAL_06");
    WLD_REMOVEITEM(ITMW_1H_MISC_AXE_Q304_01);
    WLD_SENDUNTRIGGER("KM_BLOODCURRENCY_FINAL_05");
    MDL_REMOVEOVERLAYMDS(PIR_1306_RODRIGO, HUMANSMARVINSNEAKMDS);
    MDL_REMOVEOVERLAYMDS(PIR_1308_SIMON, HUMANSMARVINSNEAKMDS);
    TELEPORTNPCTOWP(58677, "PART17_PATH_158");
    TELEPORTNPCTOWP(58703, "PART17_PATH_160");
    AI_DRAWWEAPON(PIR_1306_RODRIGO);
    AI_DRAWWEAPON(PIR_1308_SIMON);
    AI_GOTOWP(PIR_1306_RODRIGO, "PART17_PATH_219");
    AI_GOTOWP(PIR_1308_SIMON, "PART17_PATH_219");
    if ((SIMON_Q304_NEEDMOREPPL) >= (1)) {
        if (!(NPC_ISDEAD(PIR_1311_THIAGO))) {
            MDL_REMOVEOVERLAYMDS(PIR_1311_THIAGO, HUMANSMARVINSNEAKMDS);
            TELEPORTNPCTOWP(58743, "PART17_PATH_162");
            AI_DRAWWEAPON(PIR_1311_THIAGO);
            AI_GOTOWP(PIR_1311_THIAGO, "PART17_PATH_219");
        };
        if ((SIMON_Q304_NEEDMOREPPL) == (2)) {
            if (!(NPC_ISDEAD(PIR_6322_GHOST))) {
                MDL_REMOVEOVERLAYMDS(PIR_6322_GHOST, HUMANSMARVINSNEAKMDS);
                TELEPORTNPCTOWP(58497, "PART17_PATH_163");
                AI_DRAWWEAPON(PIR_6322_GHOST);
                AI_GOTOWP(PIR_6322_GHOST, "PART17_PATH_219");
            };
        };
    };
    HERO.AIVAR[4] = FALSE;
    AI_WAIT(HERO, 1082130432);
    AI_FUNCTION(HERO, 92453);
}

func void Q304_TRAPCUTSCENE_END() {
    FF_REMOVE(92446);
    Q304_FINALCUTSCENE = 4;
    MDL_APPLYOVERLAYMDS(HERO, HUMANSSPRINTMDS);
    AI_STOPLOOKAT(HERO);
    Q304_MAKETHEMBANDIT();
    TELEPORTNPCTOWP(1819, "PART17_CAVE_CUTSCENE_HERO");
    WLD_SENDUNTRIGGER("KM_BLOODCURRENCY_FINAL_06");
    HERO.AIVAR[4] = FALSE;
    AI_OUTPUT(HERO, HERO, "DIA_Q304_FINALCUTSCENE_15_11");
    B_LOGENTRY(TOPIC_Q304, LOG_Q304_ITISATRAP);
    Q304_SMUGGLERESACPE = 1;
    B_STARTOTHERROUTINE(NONE_6340_SMUGGLER, "ESCAPE_WAIT");
    NPC_REFRESH(NONE_6340_SMUGGLER);
    TELEPORTNPCTOWP(58444, "PART17_PATH_158");
    NONE_6340_SMUGGLER.AIVAR[15] = TRUE;
    NONE_6340_SMUGGLER.FLAGS = 2;
    B_STARTOTHERROUTINE(PIR_1306_RODRIGO, "SWAMPCAVEFIGHT");
    NPC_REFRESH(PIR_1306_RODRIGO);
    B_STARTOTHERROUTINE(PIR_1308_SIMON, "SWAMPCAVEFIGHT");
    NPC_REFRESH(PIR_1308_SIMON);
    if ((SIMON_Q304_NEEDMOREPPL) >= (1)) {
        if (!(NPC_ISDEAD(PIR_1311_THIAGO))) {
            B_STARTOTHERROUTINE(PIR_1311_THIAGO, "SWAMPCAVEFIGHT");
            NPC_REFRESH(PIR_1311_THIAGO);
        };
        if ((SIMON_Q304_NEEDMOREPPL) == (2)) {
            if (!(NPC_ISDEAD(PIR_6322_GHOST))) {
                B_STARTOTHERROUTINE(PIR_6322_GHOST, "SWAMPCAVEFIGHT");
                NPC_REFRESH(PIR_6322_GHOST);
            };
        };
    };
    B_STARTOTHERROUTINE(NONE_6337_BODYGUARD, "CAVEFIGHT");
    NPC_REFRESH(NONE_6337_BODYGUARD);
    B_STARTOTHERROUTINE(NONE_6338_BODYGUARD, "CAVEFIGHT");
    NPC_REFRESH(NONE_6338_BODYGUARD);
    B_STARTOTHERROUTINE(NONE_6339_BODYGUARD, "CAVEFIGHT");
    NPC_REFRESH(NONE_6339_BODYGUARD);
    B_STARTOTHERROUTINE(NONE_6341_BODYGUARD, "CAVEFIGHT");
    NPC_REFRESH(NONE_6341_BODYGUARD);
    Q304_ISGONZALOREALLYDEAD();
}

func void Q304_KILLGONZALO() {
    BAU_6287_GONZALO.AIVAR[52] = TRUE;
    BAU_6287_GONZALO.FLAGS = 0;
    BAU_6287_GONZALO.ATTRIBUTE[0] = 2;
    BAU_6287_GONZALO.ATTRIBUTE[1] = 2;
    NPC_CLEARAIQUEUE(NONE_6339_BODYGUARD);
    AI_WAIT(NONE_6339_BODYGUARD, 1065353216);
    AI_TURNTONPC(BAU_6287_GONZALO, NONE_6339_BODYGUARD);
    AI_WAIT(BAU_6287_GONZALO, 1065353216);
    AI_READYRANGEDWEAPON(NONE_6339_BODYGUARD);
    AI_AIMAT(NONE_6339_BODYGUARD, BAU_6287_GONZALO);
    AI_WAIT(NONE_6339_BODYGUARD, 1066192077);
    AI_WAIT(BAU_6287_GONZALO, 1067869798);
    AI_SHOOTAT(NONE_6339_BODYGUARD, BAU_6287_GONZALO);
    AI_FUNCTION(NONE_6339_BODYGUARD, 63280);
}

