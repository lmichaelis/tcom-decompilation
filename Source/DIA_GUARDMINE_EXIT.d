instance DIA_GUARDMINE_EXIT(C_INFO) {
    NPC = 58127;
    NR = 999;
    CONDITION = DIA_GUARDMINE_EXIT_CONDITION;
    INFORMATION = DIA_GUARDMINE_EXIT_INFO;
    PERMANENT = TRUE;
    DESCRIPTION = DIALOG_ENDE;
}

func int DIA_GUARDMINE_EXIT_CONDITION() {
    return TRUE;
}

func void DIA_GUARDMINE_EXIT_INFO() {
    AI_STOPPROCESSINFOS(SELF);
}

instance DIA_GUARDMINE_STOP(C_INFO) {
    NPC = 58127;
    NR = 1;
    CONDITION = DIA_GUARDMINE_STOP_CONDITION;
    INFORMATION = DIA_GUARDMINE_STOP_INFO;
    PERMANENT = TRUE;
    DESCRIPTION = "Will you let me through?";
}

func int DIA_GUARDMINE_STOP_CONDITION() {
    if (((NPC_HASITEMS(OTHER, 37341)) == (0)) || ((LOG_GETSTATUS(MIS_Q403)) != (LOG_SUCCESS))) {
        return TRUE;
    };
    return 0 /* !broken stack! */;
}

func void DIA_GUARDMINE_STOP_INFO() {
    AI_OUTPUT(OTHER, SELF, "DIA_GuardMine_STOP_15_01");
    AI_OUTPUT(SELF, OTHER, "DIA_GuardMine_STOP_03_02");
    AI_OUTPUT(OTHER, SELF, "DIA_GuardMine_STOP_15_03");
    AI_OUTPUT(SELF, OTHER, "DIA_GuardMine_STOP_03_04");
    AI_OUTPUT(OTHER, SELF, "DIA_GuardMine_STOP_15_05");
    AI_OUTPUT(SELF, OTHER, "DIA_GuardMine_STOP_03_06");
    AI_STOPPROCESSINFOS(SELF);
}

instance DIA_GUARDMINE_PASS(C_INFO) {
    NPC = 58127;
    NR = 1;
    CONDITION = DIA_GUARDMINE_PASS_CONDITION;
    INFORMATION = DIA_GUARDMINE_PASS_INFO;
    PERMANENT = FALSE;
    DESCRIPTION = "I have a letter from Ulryk. Let me in.";
}

func int DIA_GUARDMINE_PASS_CONDITION() {
    if (((LOG_GETSTATUS(MIS_Q403)) == (LOG_SUCCESS)) && ((NPC_HASITEMS(OTHER, 37341)) >= (1))) {
        return TRUE;
    };
    return 0 /* !broken stack! */;
}

func void DIA_GUARDMINE_PASS_INFO() {
    AI_OUTPUT(OTHER, SELF, "DIA_GuardMine_Pass_15_01");
    AI_OUTPUT(SELF, OTHER, "DIA_GuardMine_Pass_03_02");
    B_USEFAKESCROLL();
    AI_OUTPUT(SELF, OTHER, "DIA_GuardMine_Pass_03_03");
    AI_OUTPUT(OTHER, SELF, "DIA_GuardMine_Pass_15_04");
    AI_OUTPUT(SELF, OTHER, "DIA_GuardMine_Pass_03_05");
    AI_OUTPUT(SELF, OTHER, "DIA_GuardMine_Pass_03_06");
    INFO_CLEARCHOICES(82160);
    INFO_ADDCHOICE(82160, "Fine.", 82163);
    INFO_ADDCHOICE(82160, "You've got to be kidding!", 82164);
}

func void DIA_GUARDMINE_PASS_YES() {
    AI_OUTPUT(OTHER, SELF, "DIA_GuardMine_Pass_Yes_15_01");
    AI_OUTPUT(SELF, OTHER, "DIA_GuardMine_Pass_Yes_03_02");
    INFO_CLEARCHOICES(82160);
}

func void DIA_GUARDMINE_PASS_NO() {
    AI_OUTPUT(OTHER, SELF, "DIA_GuardMine_Pass_No_15_01");
    AI_OUTPUT(SELF, OTHER, "DIA_GuardMine_Pass_No_03_02");
    AI_OUTPUT(OTHER, SELF, "DIA_GuardMine_Pass_No_15_03");
    AI_OUTPUT(SELF, OTHER, "DIA_GuardMine_Pass_No_03_04");
    AI_OUTPUT(OTHER, SELF, "DIA_GuardMine_Pass_No_15_05");
    AI_OUTPUT(SELF, OTHER, "DIA_GuardMine_Pass_No_03_06");
    AI_OUTPUT(OTHER, SELF, "DIA_GuardMine_Pass_No_15_07");
    INFO_CLEARCHOICES(82160);
}

instance DIA_GUARDMINE_WHATHELP(C_INFO) {
    NPC = 58127;
    NR = 1;
    CONDITION = DIA_GUARDMINE_WHATHELP_CONDITION;
    INFORMATION = DIA_GUARDMINE_WHATHELP_INFO;
    PERMANENT = FALSE;
    DESCRIPTION = "What kind of support is this supposed to be?";
}

func int DIA_GUARDMINE_WHATHELP_CONDITION() {
    if (((LOG_GETSTATUS(MIS_Q404)) == (LOG_RUNNING)) && (NPC_KNOWSINFO(OTHER, 82160))) {
        return TRUE;
    };
    return 0 /* !broken stack! */;
}

func void DIA_GUARDMINE_WHATHELP_INFO() {
    Q404_GUARDMINE_NEEDHELP = TRUE;
    Q404_GUARDMINE_COUNT = 0;
    AI_OUTPUT(OTHER, SELF, "DIA_GuardMine_WhatHelp_15_01");
    AI_OUTPUT(SELF, OTHER, "DIA_GuardMine_WhatHelp_03_02");
    AI_OUTPUT(OTHER, SELF, "DIA_GuardMine_WhatHelp_15_03");
    AI_OUTPUT(SELF, OTHER, "DIA_GuardMine_WhatHelp_03_04");
    AI_OUTPUT(SELF, OTHER, "DIA_GuardMine_WhatHelp_03_05");
    AI_OUTPUT(SELF, OTHER, "DIA_GuardMine_WhatHelp_03_06");
    AI_LOGENTRY(TOPIC_Q404, LOG_Q404_GUARD_NEEDHELP);
}

instance DIA_GUARDMINE_Q404GOTHELP(C_INFO) {
    NPC = 58127;
    NR = 1;
    CONDITION = DIA_GUARDMINE_Q404GOTHELP_CONDITION;
    INFORMATION = DIA_GUARDMINE_Q404GOTHELP_INFO;
    PERMANENT = TRUE;
    DESCRIPTION = "As for opening the gate...";
}

func int DIA_GUARDMINE_Q404GOTHELP_CONDITION() {
    if ((((LOG_GETSTATUS(MIS_Q404)) == (LOG_RUNNING)) && ((Q404_GUARDMINE_NEEDHELP) == (TRUE))) && ((Q404_CANUSEMINEWHEEL) == (FALSE))) {
        return TRUE;
    };
    return 0 /* !broken stack! */;
}

func void DIA_GUARDMINE_ENTER() {
    Q404_GUARDMINE_NEEDHELP = FALSE;
    Q404_CANUSEMINEWHEEL = TRUE;
    AI_FUNCTION(SELF, 82171);
    AI_TURNTONPC(DJG_10019_GUARDMINE, HERO);
    AI_TURNTONPC(HERO, DJG_10019_GUARDMINE);
    AI_LOOKATNPC(HERO, DJG_10019_GUARDMINE);
    AI_OUTPUT(SELF, OTHER, "DIA_GuardMine_Q404GotHelp_03_06");
    AI_GOTOWP(SELF, "WOLFSDEN_GUARD_WHEEL");
    if ((Q404_GRONSTATUS) == (2)) {
        AI_TURNAWAY(SELF, DJG_10011_GRON);
    };
    AI_USEMOB(SELF, "VWHEEL", -(1));
    AI_TURNAWAY(SELF, HERO);
    AI_USEMOB(SELF, "VWHEEL", 1);
    AI_WAIT(SELF, 1045220557);
    AI_PLAYANI(SELF, T_SEARCH);
    AI_WAIT(SELF, 1045220557);
    AI_TURNTONPC(SELF, HERO);
    AI_OUTPUT(SELF, OTHER, "DIA_GuardMine_Q404GotHelp_03_07");
    AI_OUTPUT(SELF, OTHER, "DIA_GuardMine_Q404GotHelp_03_08");
    AI_OUTPUT(SELF, OTHER, "DIA_GuardMine_Q404GotHelp_03_09");
    AI_OUTPUT(OTHER, SELF, "DIA_GuardMine_Q404GotHelp_15_10");
    AI_OUTPUT(SELF, OTHER, "DIA_GuardMine_Q404GotHelp_03_11");
    AI_OUTPUT(OTHER, SELF, "DIA_GuardMine_Q404GotHelp_15_12");
    AI_FUNCTION(SELF, 82172);
    AI_LOGENTRY(TOPIC_Q404, LOG_Q404_GUARD_GOTOMINE);
    AI_STOPPROCESSINFOS(SELF);
}

func void GUARDMINE_CUTSCENE01() {
    DIACAM_DISABLE();
    WLD_SENDTRIGGER("KM_MINEOPEN_01");
    TELEPORTNPCTOWP(58127, "WOLFSDEN_GUARD_MINE");
    TELEPORTNPCTOWP(1819, "WOLFSDEN_CITADEL_HELP_HERO");
    if ((Q404_GRONSTATUS) == (2)) {
        TELEPORTNPCTOWP(58265, "WOLFSDEN_CITADEL_HELP_01");
        AI_TURNTONPC(DJG_10011_GRON, DJG_10019_GUARDMINE);
        AI_LOOKATNPC(DJG_10011_GRON, DJG_10019_GUARDMINE);
    };
    if ((Q404_VAHRALSTATUS) == (2)) {
        TELEPORTNPCTOWP(58283, "WOLFSDEN_CITADEL_HELP_02");
        AI_TURNTONPC(DJG_10014_VAHRAL, DJG_10019_GUARDMINE);
        AI_LOOKATNPC(DJG_10014_VAHRAL, DJG_10019_GUARDMINE);
    };
    if ((Q404_LEGRIFSTATUS) == (2)) {
        TELEPORTNPCTOWP(58304, "WOLFSDEN_CITADEL_HELP_03");
        AI_TURNTONPC(DJG_10017_LEGRIF, DJG_10019_GUARDMINE);
        AI_LOOKATNPC(DJG_10017_LEGRIF, DJG_10019_GUARDMINE);
    };
    if ((Q404_DALMONSTATUS) == (3)) {
        TELEPORTNPCTOWP(58315, "WOLFSDEN_CITADEL_HELP_04");
        AI_TURNTONPC(DJG_10027_DALMON, DJG_10019_GUARDMINE);
        AI_LOOKATNPC(DJG_10027_DALMON, DJG_10019_GUARDMINE);
    };
}

func void GUARDMINE_CUTSCENE02() {
    WLD_SENDUNTRIGGER("KM_MINEOPEN_01");
    DIACAM_ENABLE();
    HERO.AIVAR[4] = FALSE;
    if ((Q404_GRONSTATUS) == (2)) {
        AI_STOPLOOKAT(DJG_10011_GRON);
    };
    if ((Q404_VAHRALSTATUS) == (2)) {
        AI_STOPLOOKAT(DJG_10014_VAHRAL);
    };
    if ((Q404_LEGRIFSTATUS) == (2)) {
        AI_STOPLOOKAT(DJG_10017_LEGRIF);
    };
    if ((Q404_DALMONSTATUS) == (3)) {
        AI_STOPLOOKAT(DJG_10027_DALMON);
    };
}

func void DIA_GUARDMINE_Q404GOTHELP_INFO() {
    AI_OUTPUT(OTHER, SELF, "DIA_GuardMine_Q404GotHelp_15_01");
    if ((Q404_GUARDMINE_COUNT) >= (2)) {
        if ((Q404_GUARDMINE_COUNT) == (2)) {
            AI_OUTPUT(SELF, OTHER, "DIA_GuardMine_Q404GotHelp_03_03");
        } else if ((Q404_GUARDMINE_COUNT) == (3)) {
            AI_OUTPUT(SELF, OTHER, "DIA_GuardMine_Q404GotHelp_03_04");
            AI_OUTPUT(SELF, OTHER, "DIA_GuardMine_Q404GotHelp_03_05");
        } else if ((Q404_GUARDMINE_COUNT) == (4)) {
            AI_OUTPUT(SELF, OTHER, "DIA_GuardMine_Q404GotHelp_03_13");
        };
        DIA_GUARDMINE_ENTER();
        B_GIVEPLAYERXP((XP_Q404_GUARDMINECOUNT) * (Q404_GUARDMINE_COUNT));
    };
    AI_OUTPUT(SELF, OTHER, "DIA_GuardMine_Q404GotHelp_03_02");
}

instance DIA_GUARDMINE_AFTERMINE(C_INFO) {
    NPC = 58127;
    NR = 1;
    CONDITION = DIA_GUARDMINE_AFTERMINE_CONDITION;
    INFORMATION = DIA_GUARDMINE_AFTERMINE_INFO;
    PERMANENT = FALSE;
    IMPORTANT = TRUE;
}

func int DIA_GUARDMINE_AFTERMINE_CONDITION() {
    if ((LOG_GETSTATUS(MIS_Q404)) == (LOG_SUCCESS)) {
        return TRUE;
    };
    return 0 /* !broken stack! */;
}

func void DIA_GUARDMINE_AFTERMINE_INFO() {
    MOB_CHANGEFOCUSNAME("KM_CHEST_JON", "MOBNAME_JONCHEST");
    WLD_SENDTRIGGER("Q404_MINECRATE");
    if (((Q404_JONSTATUS) == (3)) || ((Q404_JONSTATUS) == (1))) {
        AI_OUTPUT(SELF, OTHER, "DIA_GuardMine_AfterMine_03_01");
        AI_OUTPUT(OTHER, SELF, "DIA_GuardMine_AfterMine_15_02");
        AI_OUTPUT(SELF, OTHER, "DIA_GuardMine_AfterMine_03_03");
        AI_OUTPUT(SELF, OTHER, "DIA_GuardMine_AfterMine_03_04");
        AI_OUTPUT(OTHER, SELF, "DIA_GuardMine_AfterMine_15_05");
        AI_OUTPUT(SELF, OTHER, "DIA_GuardMine_AfterMine_03_06");
        AI_OUTPUT(SELF, OTHER, "DIA_GuardMine_AfterMine_03_07");
        AI_OUTPUT(OTHER, SELF, "DIA_GuardMine_AfterMine_15_08");
    };
    if ((Q404_JONSTATUS) == (4)) {
        AI_OUTPUT(SELF, OTHER, "DIA_GuardMine_AfterMine_03_09");
        AI_OUTPUT(OTHER, SELF, "DIA_GuardMine_AfterMine_15_10");
        AI_OUTPUT(SELF, OTHER, "DIA_GuardMine_AfterMine_03_11");
        AI_SETWALKMODE(SELF, NPC_WALK);
        AI_GOTONPC(SELF, DJG_10020_JON_WOLFSDEN);
        AI_PLAYANI(SELF, T_PLUNDER);
        AI_TURNTONPC(SELF, OTHER);
        AI_OUTPUT(SELF, OTHER, "DIA_GuardMine_AfterMine_03_12");
        AI_OUTPUT(OTHER, SELF, "DIA_GuardMine_AfterMine_15_13");
        AI_OUTPUT(SELF, OTHER, "DIA_GuardMine_AfterMine_03_14");
        AI_OUTPUT(OTHER, SELF, "DIA_GuardMine_AfterMine_15_15");
        AI_OUTPUT(SELF, OTHER, "DIA_GuardMine_AfterMine_03_16");
        AI_OUTPUT(OTHER, SELF, "DIA_GuardMine_AfterMine_15_17");
    };
}

