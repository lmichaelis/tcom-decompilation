func void ZS_REACTTOWEAPON() {
    var C_ITEM ARMOR;
    PERCEPTION_SET_MINIMAL();
    NPC_PERCENABLE(SELF, PERC_ASSESSFIGHTSOUND, 41641);
    if (B_ASSESSENEMY()) {
        return;
    };
    AI_STANDUP(SELF);
    B_LOOKATNPC(SELF, OTHER);
    if (NPC_HASEQUIPPEDARMOR(SELF)) {
        ARMOR = NPC_GETEQUIPPEDARMOR(SELF);
        if ((((((((((((HLP_ISITEM(ARMOR, 35554)) || (HLP_ISITEM(ARMOR, 35555))) || (HLP_ISITEM(ARMOR, 35556))) || (HLP_ISITEM(ARMOR, 35557))) || (HLP_ISITEM(ARMOR, 35558))) || (HLP_ISITEM(ARMOR, 35559))) || (HLP_ISITEM(ARMOR, 35560))) || (HLP_ISITEM(ARMOR, 35561))) || (HLP_ISITEM(ARMOR, 35562))) || (HLP_ISITEM(ARMOR, 35563))) || (HLP_ISITEM(ARMOR, 35564))) || (HLP_ISITEM(ARMOR, 35582))) {
            AI_STARTSTATE(SELF, 61582, 1, "");
            return;
        };
        B_SELECTWEAPON(SELF, OTHER);
    };
    B_SELECTWEAPON(SELF, OTHER);
    B_TURNTONPC(SELF, OTHER);
    if ((((SELF.AIVAR[0]) == (FIGHT_WON)) && ((SELF.AIVAR[47]) != (AR_NONE))) && (NPC_ISPLAYER(OTHER))) {
        B_SAY(SELF, OTHER, "$LOOKINGFORTROUBLEAGAIN");
    };
    if ((PLAYER_DRAWWEAPONCOMMENT) == (FALSE)) {
        if (NPC_ISINFIGHTMODE(OTHER, FMODE_MAGIC)) {
            B_SAY(SELF, OTHER, "$STOPMAGIC");
        } else {
            B_SAY(SELF, OTHER, "$WEAPONDOWN");
        };
        PLAYER_DRAWWEAPONCOMMENT = TRUE;
    };
    NPC_SENDPASSIVEPERC(SELF, PERC_ASSESSWARN, SELF, OTHER);
    SELF.AIVAR[19] = FALSE;
    SELF.AIVAR[68] = 0;
}

func int ZS_REACTTOWEAPON_LOOP() {
    if ((NPC_GETDISTTONPC(SELF, OTHER)) > (PERC_DIST_INTERMEDIAT)) {
        NPC_CLEARAIQUEUE(SELF);
        AI_REMOVEWEAPON(SELF);
        B_STOPLOOKAT(SELF);
        return LOOP_END;
    };
    if (NPC_ISINFIGHTMODE(OTHER, FMODE_NONE)) {
        NPC_CLEARAIQUEUE(SELF);
        B_SAY(SELF, OTHER, "$WISEMOVE");
        AI_REMOVEWEAPON(SELF);
        B_STOPLOOKAT(SELF);
        return LOOP_END;
    };
    if ((NPC_GETSTATETIME(SELF)) > (SELF.AIVAR[68])) {
        if (!(NPC_CANSEENPC(SELF, OTHER))) {
            B_TURNTONPC(SELF, OTHER);
        };
        SELF.AIVAR[68] = (SELF.AIVAR[68]) + (1);
    };
    if (((SELF.AIVAR[19]) == (FALSE)) && ((NPC_GETSTATETIME(SELF)) > (5))) {
        if (NPC_ISINFIGHTMODE(OTHER, FMODE_MAGIC)) {
            B_SAY(SELF, OTHER, "$ISAIDSTOPMAGIC");
        } else {
            B_SAY(SELF, OTHER, "$ISAIDWEAPONDOWN");
        };
        SELF.AIVAR[19] = TRUE;
    };
    if ((NPC_GETSTATETIME(SELF)) > (10)) {
        B_ATTACK(SELF, OTHER, AR_REACTTOWEAPON, 0);
    };
    return LOOP_CONTINUE;
}

func void ZS_REACTTOWEAPON_END() {
    B_STOPLOOKAT(SELF);
    AI_STARTSTATE(SELF, 61582, 1, "");
}

