func void SQ317_HOMERFOLLOW() {
    WLD_SENDTRIGGER("SQ317_MOVER_REPAIRDWALL");
    SQ317_FOLLOWSAFTEY = TRUE;
    NONE_13719_HOMER.AIVAR[15] = TRUE;
    NPC_EXCHANGEROUTINE(NONE_13719_HOMER, "SQ317_FOLLOW");
    NPC_REFRESH(NONE_13719_HOMER);
    HERO.AIVAR[4] = FALSE;
}

func void SQ317_HOMERWAITATBEACH() {
    WLD_SENDTRIGGER("SQ317_MOVER_REPAIRDWALL");
    NONE_13719_HOMER.AIVAR[15] = FALSE;
    B_STARTOTHERROUTINE(NONE_13719_HOMER, "SQ317_WAITATBEACH");
    NPC_REFRESH(NONE_13719_HOMER);
}

func void SQ317_HOMERWAITATEXIT() {
    WLD_SENDTRIGGER("SQ317_MOVER_REPAIRDWALL");
    NONE_13719_HOMER.AIVAR[15] = FALSE;
    B_STARTOTHERROUTINE(NONE_13719_HOMER, "SQ317_WAITATEXIT");
    NPC_REFRESH(NONE_13719_HOMER);
}

func void SQ317_HOMERWAITATBEACH_TELEPORT() {
    TELEPORTNPCTOWP(58848, "P17_HAVEN_IN_24");
    SQ317_HOMERWAITATBEACH();
}

func void SQ317_HOMERTELEPORT_PREPARE() {
    HERO.AIVAR[4] = TRUE;
    FF_APPLYONCEEXT(62460, 75, 4);
}

func void SQ317_HOMERTELEPORT_PREPARE_APPLY() {
    var int SQ317_HOMERTELEPORT_PREPARE_COUNT;
    SQ317_HOMERTELEPORT_PREPARE_COUNT = (SQ317_HOMERTELEPORT_PREPARE_COUNT) + (1);
    if ((SQ317_HOMERTELEPORT_PREPARE_COUNT) == (4)) {
        CUTSCENE_START(92958);
    };
}

func void SQ317_HOMERTELEPORTTOPRISON() {
    NONE_13719_HOMER.AIVAR[15] = FALSE;
    SND_PLAY("MFX_TELEPORT_CAST");
    B_STARTOTHERROUTINE(NONE_13719_HOMER, "SQ317_PRISON");
    NPC_REFRESH(NONE_13719_HOMER);
    TELEPORTNPCTOWP(58848, NONE_13719_HOMER.WP);
    NPC_REMOVEINVITEMS(NONE_13719_HOMER, 34594, 1);
}

func void SQ317_HOMERTELEPORT_END() {
    FF_APPLYONCEEXT(62464, 75, 4);
}

func void SQ317_HOMERTELEPORT_END_APPLY() {
    var int SQ317_HOMERTELEPORT_END_COUNT;
    SQ317_HOMERTELEPORT_END_COUNT = (SQ317_HOMERTELEPORT_END_COUNT) + (1);
    if ((SQ317_HOMERTELEPORT_END_COUNT) == (4)) {
        SQ317_HOMERESCAPED = TRUE;
        WLD_SENDUNTRIGGER("SQ317_HOMERTELEPORT_01");
        WLD_SENDUNTRIGGER("SQ317_HOMERTELEPORT_02");
        B_LOGENTRY(TOPIC_SQ317, LOG_SQ317_HOMER_ESCAPED);
        HERO.AIVAR[4] = FALSE;
    };
}

func void SQ317_CHECKRUNES() {
    if (((TELEPORT_GOTANYRUNE) == (TRUE)) && ((NPC_HASITEMS(HERO, 38064)) >= (1))) {
        if ((TELEPORT_GOTANYRUNE_CHECK()) == (FALSE)) {
            TELEPORT_GOTANYRUNE = FALSE;
            NPC_REMOVEINVITEMS(HERO, 38064, 1);
        };
    };
}

func void SQ317_FINISHQUEST() {
    if ((SQ317_KILLDINKEL) == (1)) {
        SQ317_KILLDINKEL = 2;
        SQ317_KILLDINKEL_DAY = WLD_GETDAY();
    };
    LOG_SETSTATUS(_@(MIS_SQ317), TOPIC_SQ317, LOG_SUCCESS);
    B_GIVEPLAYERXP(XP_SQ317_FINISH);
}

func void SQ317_DINKIELBODY() {
    B_REMOVENPC(58858);
    FF_APPLYONCEEXTGT(62469, 0, -(1));
}

func void SQ317_DINKIELBODY_APPLY() {
    var ZCMOVER MOVER1;
    var int MOVPTR1;
    var int SQ317_DINKIELBODY_COUNT;
    if ((SQ317_DINKIELBODY_COUNT) == (0)) {
        PRINTD("Rozpoczynam - SQ317_DinkielBody_Apply");
        MOVPTR1 = MEM_SEARCHVOBBYNAME("SQ317_MOVER_DINKIELCORPSE");
        MOVER1 = MEM_PTRTOINST(MOVPTR1);
        CHANGEVOBCOLLISION("SQ317_DINKIELCORPSE", FALSE, FALSE, FALSE, TRUE);
        WLD_SENDTRIGGER("SQ317_MOVER_DINKIELCORPSE");
        SQ317_DINKIELBODY_COUNT = 1;
    };
    if (((MOVER1.MOVERSTATE) != (MOVER_STATE_OPENING)) && ((MOVER1.MOVERSTATE) != (MOVER_STATE_CLOSING))) {
        PRINTD("Skoñczy³em - SQ317_DinkielBody_Apply");
        CHANGEVOBCOLLISION("SQ317_DINKIELCORPSE", TRUE, TRUE, TRUE, TRUE);
        FF_REMOVE(62469);
        SQ317_DINKIELBODY_COUNT = 0;
    };
}

func void SQ317_GIVEHOMERSTUFF() {
    CREATEINVITEMS(SELF, 38040, 1);
    B_GIVEINVITEMS(SELF, OTHER, 38040, 1);
    CREATEINVITEMS(SELF, 33660, 3);
    if ((SQ317_WHATRUNE) == (1)) {
        CREATEINVITEMS(SELF, 38068, 1);
    };
    if ((SQ317_WHATRUNE) == (2)) {
        CREATEINVITEMS(SELF, 38069, 1);
    };
    if ((SQ317_WHATRUNE) == (3)) {
        CREATEINVITEMS(SELF, 38082, 1);
        B_GIVEINVITEMS(SELF, OTHER, 38082, 1);
    };
    B_GIVEINVITEMS(SELF, OTHER, 33660, 3);
}

