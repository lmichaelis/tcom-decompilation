const int SPL_COST_TELEPORT = 10;
func void B_PRINTTELEPORTTOOFARAWAY(var int LEVEL) {
    if ((LEVEL) != (CURRENTLEVEL)) {
        PRINTSCREEN(PRINT_TELEPORTTOOFARAWAY, -(1), YPOS_LEVELUP, FONT_SCREENSMALL, 2);
    };
}

func int SPELL_LOGIC_PALTELEPORTSECRET(var int MANAINVESTED) {
    if ((NPC_GETACTIVESPELLISSCROLL(SELF)) && ((SELF.ATTRIBUTE[2]) >= (SPL_COST_SCROLL))) {
        return SPL_SENDCAST;
    };
    if ((SELF.ATTRIBUTE[2]) >= (SPL_COST_TELEPORT)) {
        return SPL_SENDCAST;
    };
    PRINTSCREEN(PRINT_LOWONMANA, -(1), YPOS_LEVELUP, FONT_SCREENSMALL, 2);
    return SPL_NEXTLEVEL;
}

func void B_TELEPORTKM_STARTDIALOGUE() {
    HERO.AIVAR[4] = TRUE;
    TELEPORTKM_STARTDIALOGUE = 1;
    AI_PROCESSINFOS(HERO);
}

const int TELEPORTDISTANCE = 1000;
func void B_TELEPORTKM_CHECKDISTWP() {
    SELF.ATTRIBUTE[2] = (SELF.ATTRIBUTE[2]) + (SPL_COST_TELEPORT);
    if ((((((((((((((((((NPC_GETDISTTOWP(SELF, "TELEPORT_PARTM1_CHURCH")) <= (TELEPORTDISTANCE)) || ((NPC_GETDISTTOWP(SELF, "TELEPORT_CITY_ADANOS")) <= (TELEPORTDISTANCE))) || ((NPC_GETDISTTOWP(SELF, "TELEPORT_LIGHTHOUSE")) <= (TELEPORTDISTANCE))) || ((NPC_GETDISTTOWP(SELF, "TELEPORT_TOMB")) <= (TELEPORTDISTANCE))) || (((NPC_GETDISTTOWP(SELF, "TELEPORT_VOLFZACK")) <= (TELEPORTDISTANCE)) && (((Q503_GOTOVOLFZACKE) == (0)) || ((Q503_GOTOVOLFZACKE) == (7))))) || ((NPC_GETDISTTOWP(SELF, "TELEPORT_SILBACH")) <= (TELEPORTDISTANCE))) || ((NPC_GETDISTTOWP(SELF, "TELEPORT_MONASTERY")) <= (TELEPORTDISTANCE))) || ((NPC_GETDISTTOWP(SELF, "TELEPORT_SWAMPV1")) <= (TELEPORTDISTANCE))) || ((NPC_GETDISTTOWP(SELF, "TELEPORT_LURKER")) <= (TELEPORTDISTANCE))) || ((NPC_GETDISTTOWP(SELF, "TELEPORT_SKELETONS")) <= (TELEPORTDISTANCE))) || ((NPC_GETDISTTOWP(SELF, "TELEPORT_WOLFSDEN")) <= (TELEPORTDISTANCE))) || ((NPC_GETDISTTOWP(SELF, "TELEPORT_OLDTOMB")) <= (TELEPORTDISTANCE))) || ((NPC_GETDISTTOWP(SELF, "TELEPORT_SWAMPV2")) <= (TELEPORTDISTANCE))) || ((NPC_GETDISTTOWP(SELF, "PART4_TELEPORT_TOWER")) <= (TELEPORTDISTANCE))) || ((NPC_GETDISTTOWP(SELF, "PARTM5_HEROHOUSE_TELEPORT")) <= (TELEPORTDISTANCE))) || ((NPC_GETDISTTOWP(SELF, "PART14_ISLAND_14")) <= (TELEPORTDISTANCE))) || ((NPC_GETDISTTOWP(SELF, "P5_CULTIST_DEMON_IN")) <= (TELEPORTDISTANCE))) {
        if (((LOG_GETSTATUS(MIS_Q312)) == (LOG_RUNNING)) || ((LOG_GETSTATUS(MIS_Q308)) == (LOG_RUNNING))) {
            if (((NPC_GETDISTTOWP(SELF, "TELEPORT_PARTM1_CHURCH")) <= (TELEPORTDISTANCE)) || ((NPC_GETDISTTOWP(SELF, "TELEPORT_CITY_ADANOS")) <= (TELEPORTDISTANCE))) {
                AI_PLAYANI(SELF, "T_HEASHOOT_2_STAND");
                B_SAY(HERO, HERO, "$MARVIN_Impossible");
            } else {
                B_TELEPORTKM_STARTDIALOGUE();
            };
        } else if ((Q301_BLOCKTELEPORT) == (TRUE)) {
            AI_PLAYANI(SELF, "T_HEASHOOT_2_STAND");
            Q301_MARVIN_DONTLEAVETHISPLACE();
        } else {
            B_TELEPORTKM_STARTDIALOGUE();
        };
    };
    AI_PLAYANI(SELF, "T_HEASHOOT_2_STAND");
    PRINTSCREEN(PRINT_TELMAGIKRINGFAR, -(1), YPOS_LEVELUP, FONT_SCREENSMALL, 2);
}

func void SPELL_CAST_PALTELEPORTSECRET() {
    B_PRINTTELEPORTTOOFARAWAY(ARCHOLOS_ZEN);
    if (NPC_GETACTIVESPELLISSCROLL(SELF)) {
        SELF.ATTRIBUTE[2] = (SELF.ATTRIBUTE[2]) - (SPL_COST_SCROLL);
    };
    SELF.ATTRIBUTE[2] = (SELF.ATTRIBUTE[2]) - (SPL_COST_TELEPORT);
    B_TELEPORTKM_CHECKDISTWP();
}

func void SPELL_CAST_TELEPORT() {
    if ((NPC_GETACTIVESPELL(SELF)) == (SPL_PALTELEPORTSECRET)) {
        SPELL_CAST_PALTELEPORTSECRET();
    };
}

func int TELEPORTKM_CONDITION() {
    return TELEPORTKM_STARTDIALOGUE;
}

func void TELEPORTKM_EXIT() {
    HERO.AIVAR[4] = FALSE;
    AI_STOPPROCESSINFOS(SELF);
    AI_PLAYANI(SELF, "T_HEASHOOT_2_STAND");
    TELEPORTKM_STARTDIALOGUE = FALSE;
}

instance TELEPORTKM_END(C_INFO) {
    NPC = 50091;
    NR = 999;
    CONDITION = TELEPORTKM_CONDITION;
    INFORMATION = TELEPORTKM_EXIT;
    PERMANENT = TRUE;
    DESCRIPTION = DIALOG_ENDE;
}

instance TELEPORTKM_CHOICE(C_INFO) {
    NPC = 50091;
    NR = 1;
    CONDITION = TELEPORTKM_CONDITION;
    INFORMATION = TELEPORTKM_INFO;
    PERMANENT = TRUE;
    DESCRIPTION = DIALOG_CHOOSELOCATION;
}

func void TELEPORTKM_INFO() {
    INFO_CLEARCHOICES(43651);
    INFO_ADDCHOICE(43651, DIALOG_BACK, 43654);
    if ((TELEPORT_CITYINNOS) == (TRUE)) {
        INFO_ADDCHOICE(43651, DIALOG_TP_CHOICE_CITYINNOS, 43655);
    };
    if ((TELEPORT_CITYADANOS) == (TRUE)) {
        INFO_ADDCHOICE(43651, DIALOG_TP_CHOICE_CITYADANOS, 43656);
    };
    if ((TELEPORT_OURHOUSE) == (TRUE)) {
        INFO_ADDCHOICE(43651, DIALOG_TP_CHOICE_OURHOUSE, 43669);
    };
    if ((TELEPORT_LIGHTHOUSE) == (TRUE)) {
        INFO_ADDCHOICE(43651, DIALOG_TP_CHOICE_LIGHTHOUSE, 43657);
    };
    if ((TELEPORT_TOMB) == (TRUE)) {
        INFO_ADDCHOICE(43651, DIALOG_TP_CHOICE_TOMB, 43658);
    };
    if ((TELEPORT_VOLFZACK) == (TRUE)) {
        INFO_ADDCHOICE(43651, DIALOG_TP_CHOICE_VOLFZACK, 43659);
    };
    if ((TELEPORT_SILBACH) == (TRUE)) {
        INFO_ADDCHOICE(43651, DIALOG_TP_CHOICE_SILBACH, 43660);
    };
    if ((TELEPORT_SWAMPV1) == (TRUE)) {
        INFO_ADDCHOICE(43651, DIALOG_TP_CHOICE_SWAMPV1, 43661);
    };
    if ((TELEPORT_LURKER) == (TRUE)) {
        INFO_ADDCHOICE(43651, DIALOG_TP_CHOICE_LURKER, 43662);
    };
    if ((TELEPORT_SKELETONS) == (TRUE)) {
        INFO_ADDCHOICE(43651, DIALOG_TP_CHOICE_SKELETONS, 43663);
    };
    if ((TELEPORT_WOLFSDEN) == (TRUE)) {
        INFO_ADDCHOICE(43651, DIALOG_TP_CHOICE_WOLFSDEN, 43664);
    };
    if ((TELEPORT_SWAMPV2) == (TRUE)) {
        INFO_ADDCHOICE(43651, DIALOG_TP_CHOICE_SWAMPV2, 43665);
    };
    if ((TELEPORT_MONASTERY) == (TRUE)) {
        INFO_ADDCHOICE(43651, DIALOG_TP_CHOICE_MONASTERY, 43666);
    };
    if ((TELEPORT_OLDTOMB) == (TRUE)) {
        INFO_ADDCHOICE(43651, DIALOG_TP_CHOICE_NEARVAHRDAL, 43667);
    };
    if ((TELEPORT_FISHERMANS) == (TRUE)) {
        INFO_ADDCHOICE(43651, DIALOG_TP_CHOICE_FISHERMAN, 43668);
    };
}

func void TELEPORTKM_USEMANA() {
    ACH_7_RUNE_FASTTRAVEL = TRUE;
    if ((SELF.ATTRIBUTE[2]) >= (SPL_COST_TELEPORT)) {
        SELF.ATTRIBUTE[2] = (SELF.ATTRIBUTE[2]) - (SPL_COST_TELEPORT);
    };
    SELF.ATTRIBUTE[2] = 0;
}

func void TELEPORTKM_CHOICE_BACK() {
    INFO_CLEARCHOICES(43651);
}

func void TELEPORTKM_CHOICE_CITYINNOS() {
    if (((LOG_GETSTATUS(MIS_Q312)) == (LOG_RUNNING)) || ((LOG_GETSTATUS(MIS_Q308)) == (LOG_RUNNING))) {
        Q312_MARVIN_TELEPORTBLOCKED();
        TELEPORTKM_EXIT();
    };
    TELEPORTKM_EXIT();
    TELEPORTKM_USEMANA();
    AI_TELEPORT(SELF, "TELEPORT_PARTM1_CHURCH");
    TELEMETRY_FASTTRAVEL(1, "TELEPORT_PARTM1_CHURCH");
}

func void TELEPORTKM_CHOICE_CITYADANOS() {
    if (((LOG_GETSTATUS(MIS_Q312)) == (LOG_RUNNING)) || ((LOG_GETSTATUS(MIS_Q308)) == (LOG_RUNNING))) {
        Q312_MARVIN_TELEPORTBLOCKED();
        TELEPORTKM_EXIT();
    };
    TELEPORTKM_EXIT();
    TELEPORTKM_USEMANA();
    AI_TELEPORT(SELF, "TELEPORT_CITY_ADANOS");
    TELEMETRY_FASTTRAVEL(1, "TELEPORT_CITY_ADANOS");
}

func void TELEPORTKM_CHOICE_LIGHTHOUSE() {
    TELEPORTKM_EXIT();
    TELEPORTKM_USEMANA();
    AI_TELEPORT(SELF, "TELEPORT_LIGHTHOUSE");
    TELEMETRY_FASTTRAVEL(1, "TELEPORT_LIGHTHOUSE");
}

func void TELEPORTKM_CHOICE_TOMB() {
    TELEPORTKM_EXIT();
    TELEPORTKM_USEMANA();
    AI_TELEPORT(SELF, "TELEPORT_TOMB");
    TELEMETRY_FASTTRAVEL(1, "TELEPORT_TOMB");
}

func void TELEPORTKM_CHOICE_VOLFZACK() {
    TELEPORTKM_EXIT();
    TELEPORTKM_USEMANA();
    AI_TELEPORT(SELF, "TELEPORT_VOLFZACK");
    TELEMETRY_FASTTRAVEL(1, "TELEPORT_VOLFZACK");
}

func void TELEPORTKM_CHOICE_SILBACH() {
    TELEPORTKM_EXIT();
    TELEPORTKM_USEMANA();
    AI_TELEPORT(SELF, "TELEPORT_SILBACH");
    TELEMETRY_FASTTRAVEL(1, "TELEPORT_SILBACH");
}

func void TELEPORTKM_CHOICE_SWAMPV1() {
    TELEPORTKM_EXIT();
    TELEPORTKM_USEMANA();
    AI_TELEPORT(SELF, "TELEPORT_SWAMPV1");
    TELEMETRY_FASTTRAVEL(1, "TELEPORT_SWAMPV1");
}

func void TELEPORTKM_CHOICE_LURKER() {
    TELEPORTKM_EXIT();
    TELEPORTKM_USEMANA();
    AI_TELEPORT(SELF, "TELEPORT_LURKER");
    TELEMETRY_FASTTRAVEL(1, "TELEPORT_LURKER");
}

func void TELEPORTKM_CHOICE_SKELETONS() {
    TELEPORTKM_EXIT();
    TELEPORTKM_USEMANA();
    AI_TELEPORT(SELF, "TELEPORT_SKELETONS");
    TELEMETRY_FASTTRAVEL(1, "TELEPORT_SKELETONS");
}

func void TELEPORTKM_CHOICE_WOLFSDEN() {
    TELEPORTKM_EXIT();
    TELEPORTKM_USEMANA();
    AI_TELEPORT(SELF, "TELEPORT_WOLFSDEN");
    TELEMETRY_FASTTRAVEL(1, "TELEPORT_WOLFSDEN");
}

func void TELEPORTKM_CHOICE_SWAMPV2() {
    TELEPORTKM_EXIT();
    TELEPORTKM_USEMANA();
    AI_TELEPORT(SELF, "TELEPORT_SWAMPV2");
    TELEMETRY_FASTTRAVEL(1, "TELEPORT_SWAMPV2");
}

func void TELEPORTKM_CHOICE_MONASTERY() {
    TELEPORTKM_EXIT();
    TELEPORTKM_USEMANA();
    AI_TELEPORT(SELF, "TELEPORT_MONASTERY");
    TELEMETRY_FASTTRAVEL(1, "TELEPORT_MONASTERY");
}

func void TELEPORTKM_CHOICE_NEARVAHRDAL() {
    TELEPORTKM_EXIT();
    TELEPORTKM_USEMANA();
    AI_TELEPORT(SELF, "TELEPORT_OLDTOMB");
    TELEMETRY_FASTTRAVEL(1, "TELEPORT_OLDTOMB");
}

func void TELEPORTKM_CHOICE_FISHERMAN() {
    TELEPORTKM_EXIT();
    TELEPORTKM_USEMANA();
    AI_TELEPORT(SELF, "PART4_TELEPORT_TOWER");
    TELEMETRY_FASTTRAVEL(1, "PART4_TELEPORT_TOWER");
}

func void TELEPORTKM_CHOICE_OURHOUSE() {
    TELEPORTKM_EXIT();
    TELEPORTKM_USEMANA();
    AI_TELEPORT(SELF, "PARTM5_HEROHOUSE_TELEPORT");
    TELEMETRY_FASTTRAVEL(1, "PARTM5_HEROHOUSE_TELEPORT");
}

